---
title: "Raf_OA_Multiomics_All_Human_Scripts_Rmarkdown"
author: "Weilan Wang"
date: "2025-02-04"
output: html_document
---

```{r library setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('C:/Users/Weilan Wang/Desktop/weilan_R')
## install.packages("viridis")
## install.packages("multiblock")
## install.packages("lmerTest")
## install.packages("emmeans")
## install.packages("Matrix", type = "source")
## BiocManager::install("DESeq2")
## BiocManager::install("EnhancedVolcano")
## BiocManager::install("MOFA2")
## BiocManager::install("limma")
## BiocManager::install("phyloseq")
## BiocManager::install("microViz")
## BiocManager::install("MOFAdata")
## BiocManager::install(c("phyloseq", "microbiome", "ComplexHeatmap"), update = FALSE)
## install.packages("microViz",repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos")))

library(broom.mixed)
library(car)
library(caret)
library(circlize)
library(ComplexHeatmap)
library(cowplot)
library(data.table)
library(DESeq2)
library(doParallel)
library(dplyr)
library(egg)
library(EnhancedVolcano)
library(emmeans)
library(GGally)
library(ggcorrplot)
library(ggraph)
library(ggnewscale)
library(ggforce)
library(ggplot2)
library(ggpubr)
library(gridExtra)
library(grid)
library(git2r)
library(Hmisc)
library(igraph)
library(lattice)
library(lme4)
library(lmerTest)
library(limma)
library(lsmeans)
library(magrittr)
library(Matrix)
library(mgcv)
library(microViz)
library(MOFA2)
library(MOFAdata)
library(multiblock)
library(MuMIn)
library(nlme)
library(pheatmap)
library(phyloseq)
library(purrr)
library(RColorBrewer)
library(readr)
library(readxl)
library(reshape2)
library(rstatix)
library(tidyr)
library(tidyverse)
library(vegan)
library(viridis)

```

## R Markdown

```{r theme setup for figures, echo=FALSE}
mytheme1 <- theme(panel.background = element_rect(fill = "white", color="black"), 
                  axis.title = element_text(face="bold",size=12, color = "black"),
                  axis.text.y  = element_text(face="bold",size=12, color = "black"),
                  axis.text.x  = element_text(face="bold",size=12, color = "black"),
                  panel.grid.minor.y=element_blank(), 
                  panel.grid.minor.x=element_blank(),
                  panel.grid.major.y=element_blank(),
                  panel.grid.major.x=element_blank(),
                  strip.background = element_blank(),
                  strip.text.x = element_text(face="bold",size=14, color = "black"),
                  legend.position = "top",
                  legend.box = "horizontal",
                  legend.title= element_blank(),
                  legend.text =element_text(size=14),
                  legend.key = element_blank())

mytheme2 <- theme(panel.background = element_rect(fill = "white", color = NA), 
                  panel.border = element_blank(), 
                  axis.line.x = element_line(color = "black"),  # Keep the x-axis line
                  axis.line.y = element_line(color = "black"),
                  axis.title = element_text(face="bold",size=12, color = "black"),
                  axis.text.y  = element_text(face="bold",size=12, color = "black"),
                  axis.text.x  = element_text(face="bold",size=12, color = "black"),
                  panel.grid.minor.y=element_blank(), 
                  panel.grid.minor.x=element_blank(),
                  panel.grid.major.y=element_blank(),
                  panel.grid.major.x=element_blank(),
                  strip.background = element_blank(),
                  strip.text.x = element_blank(),
                  strip.text.y = element_blank(),
                  legend.position = "top",
                  legend.box = "vertical",
                  legend.title= element_text(face="bold",size=10, color = "black"),
                  legend.text =element_text(size=10),
                  legend.key = element_blank())

mytheme3 <- theme(panel.background = element_rect(fill = "white", color = NA), 
                  panel.border = element_blank(), 
                  axis.line.x = element_line(color = "black"),  # Keep the x-axis line
                  axis.line.y = element_line(color = "black"),
                  axis.title = element_text(face="bold",size=12, color = "black"),
                  axis.text.y  = element_text(size=10, color = "black"),
                  axis.text.x  = element_text(size=10, color = "black"),
                  panel.grid.minor.y=element_blank(), 
                  panel.grid.minor.x=element_blank(),
                  panel.grid.major.y=element_blank(),
                  panel.grid.major.x=element_blank(),
                  strip.background = element_blank(),
                  strip.text.x = element_blank(),
                  strip.text.y = element_blank(),
                  legend.position = "none",
                  legend.box = "vertical",
                  legend.title= element_text(face="bold",size=10, color = "black"),
                  legend.text =element_text(size=10),
                  legend.key = element_blank())

mytheme4 <- theme(panel.background = element_rect(fill = "white", color = NA), 
                  panel.border = element_rect(color = "black", fill = NA),  # Use element_rect for panel.border
                  axis.line.x = element_line(color = "black"),  # Keep the x-axis line
                  axis.line.y = element_line(color = "black"),
                  axis.title = element_text(face="bold", size=12, color = "black"),
                  axis.text.y  = element_text(size=10, color = "black"),
                  axis.text.x  = element_text(size=10, color = "black"),
                  panel.grid.minor.y = element_blank(), 
                  panel.grid.minor.x = element_blank(),
                  panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
                  panel.grid.major.x = element_line(color = "grey", linetype = "dashed"),
                  strip.background = element_rect(),
                  strip.text.x = element_text(size=10, color = "black"),
                  strip.text.y = element_blank(),
                  legend.position = "right",
                  legend.box = "vertical",
                  legend.title = element_text(size=10, color = "black"),
                  legend.text = element_text(size=10),
                  legend.key = element_rect())
```

```{r Figures 1B-C. Post-intervention phenotypic changes stats & figures}
####### Raf_OA_Phenotype_stats ###
Raf_OA_Phenotype_changes <- read.csv("Raf_phenotype_changes_wide.csv")
participant_counts <- table(Raf_OA_Phenotype_changes$Participant)
filtered_data <- Raf_OA_Phenotype_changes[Raf_OA_Phenotype_changes$Participant %in% 
                                            names(participant_counts[participant_counts > 1]), ]
columns_to_model <- names(filtered_data)[which(names(filtered_data) == "TotalMass"):ncol(filtered_data)]
pairwise_comparisons_list <- list()
descriptive_stats_list <- list()

# Loop through each column and fit the linear model (no random effect)
for (col in columns_to_model) {
  formula <- as.formula(paste(col, "~ Diets * Months"))
  model <- lm(formula, data = filtered_data)
  emmeans_results <- emmeans(model, pairwise ~ Diets * Months, adjust = "NONE")
  summary_emmeans <- summary(emmeans_results$contrasts, infer = c(TRUE, TRUE))
  pairwise_comparisons <- as.data.frame(summary_emmeans)
  pairwise_comparisons$Phenotype <- col
  pairwise_comparisons_list[[col]] <- pairwise_comparisons
  
  descriptive_stats <- filtered_data %>%
    group_by(Diets, Months) %>%
    summarise(
      mean_value = mean(get(col), na.rm = TRUE),
      sem_value = sd(get(col), na.rm = TRUE) / sqrt(n())
    ) %>%
    mutate(mean_sem = paste0(round(mean_value, 2), " Â± ", round(sem_value, 2)), Phenotype = col)  
  descriptive_stats_list[[col]] <- descriptive_stats
}

# Combine all pairwise comparisons and descriptive stats into one data frame
Raf_phenotype_changes_posthoc <- do.call(rbind, pairwise_comparisons_list)
Raf_phenotype_changes_summary <- do.call(rbind, descriptive_stats_list)

write.csv(Raf_phenotype_changes_posthoc, "Raf_of_phenotypes_changes_posthoc.csv")
write.csv(Raf_phenotype_changes_summary, "Raf_phenotype_changes_descriptive_stats.csv")

####### Raf_OA_Phenotype_figures ###
Raf_phenotype_data_changes <- read.csv("Raf_phenotype_changes_wide.csv", header=TRUE, sep=",") 

# Add new combined column before reshaping
Raf_phenotype_data_changes <- Raf_phenotype_data_changes %>%
  mutate(Category = paste(Months, Diets, sep = "_"))

Raf_phenotype_data_changes_long <- Raf_phenotype_data_changes %>%
  pivot_longer(
    cols = TotalMass:TimeUpGo,  # Adjust this range as needed to cover all columns involved
    names_to = "Params_catlog",
    values_to = "Params_Value"
  ) %>%
  mutate(Params_type = case_when(
    Params_catlog %in% names(Raf_phenotype_data_changes)
    [which(names(Raf_phenotype_data_changes) == "TotalMass"):which(names(Raf_phenotype_data_changes) == "TrunkFat.")] ~ "Body Composition",
    Params_catlog %in% names(Raf_phenotype_data_changes)
    [which(names(Raf_phenotype_data_changes) == "SitToStand"):which(names(Raf_phenotype_data_changes) == "TimeUpGo")] ~ "Function Test",
    TRUE ~ "Other"  
  ))

write.csv(Raf_phenotype_data_changes_long, 'Raf_phenotype_data_changes_long.csv')
Raf_phenotype_data_changes_long$Category <- factor(Raf_phenotype_data_changes_long$Category, 
                                                     levels = c('M3_Placebo', 'M6_Placebo',
                                                                'M3_Prebiotic','M6_Prebiotic'))
### Make density figure for each phenotype ###
Raf_phenotype_data_Body_Composition_Pre_figure <- Raf_phenotype_data_changes_long %>%
  filter(Params_type == "Body Composition") %>%
  ggplot(aes(x = Params_Value, color = Category, fill = Category)) +
  geom_density(aes(y = ..density..), alpha = 0.7) +  
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1) +  
  scale_fill_manual(values = c("darkgrey", "black", "tomato", "red")) +  
  scale_color_manual(values = c("darkgrey", "black", "tomato", "red")) + 
  mytheme3 +  
  facet_wrap(~Params_catlog, scales = "free", ncol = 4) +  
  ylab("Density") +
  xlab("Body Composition")

Raf_phenotype_data_Body_Composition_Pre_figure


Raf_phenotype_data_Function_test_Pre_figure <- Raf_phenotype_data_changes_long %>%
  filter(Params_type == "Function Test") %>%
  ggplot(aes(x = Params_Value, color = Category, fill = Category)) +
  geom_density(aes(y = ..density..), alpha = 0.7) +  
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1) +  
  scale_fill_manual(values = c("darkgrey", "black", "tomato", "red")) + 
  scale_color_manual(values = c("darkgrey", "black", "tomato", "red")) +  
  mytheme3 + 
  facet_wrap(~Params_catlog, scales = "free", ncol = 3) +  
  ylab("Density") +
  xlab("Function Test")

Raf_phenotype_data_Function_test_Pre_figure


# Summary for raw phenotype data
threshold <- 2
Raf_OA_phenotype_data_outlier_filtered <- read.csv("Raf_OA_phenotypes.csv") %>%
  group_by(Group) %>%
  mutate(across(where(is.numeric), ~ ifelse(abs(. - mean(., na.rm = TRUE)) <= threshold * sd(., na.rm = TRUE), ., NA))) %>%
  ungroup()

columns_to_model2 <- names(Raf_OA_phenotype_data_outlier_filtered)[
  which(names(Raf_OA_phenotype_data_outlier_filtered) == "TotalMass"):which(names(Raf_OA_phenotype_data_outlier_filtered) == "Butyrate")]
columns_to_model2 <- c(columns_to_model2,
  names(Raf_OA_phenotype_data_outlier_filtered)[which(names(Raf_OA_phenotype_data_outlier_filtered) == "SitToStand"):
                                                  which(names(Raf_OA_phenotype_data_outlier_filtered) == "TimeUpGo")])

descriptive_stats_list2 <- list()

# Loop through each column and fit the linear model (no random effect)
for (col in columns_to_model2) {
  descriptive_stats2 <- Raf_OA_phenotype_data_outlier_filtered %>%
    group_by(Diets, Months) %>%
    summarise(
      mean_value = mean(get(col), na.rm = TRUE),
      sem_value = sd(get(col), na.rm = TRUE) / sqrt(n())
    ) %>%
    mutate(mean_sem = paste0(round(mean_value, 2), " Â± ", round(sem_value, 2)),
           Phenotype = col)  
  descriptive_stats_list2[[col]] <- descriptive_stats2
}

Raf_raw_phenotype_changes_summary <- do.call(rbind, descriptive_stats_list2)
write.csv(Raf_raw_phenotype_changes_summary, "Raf_raw_phenotype_descriptive_stats.csv")

```

```{r Figure 2A. Raf OA MetaPhlan4, HumaNn3, dbCAN3 PUL structural analysis}
Raf_OA_HuMaNn3_Pathway_CPM <- read.delim("Raf_OA_humann_pathabundance_cpm_normalized.tsv", 
                                         header = TRUE, row.names = 1)
colnames(Raf_OA_HuMaNn3_Pathway_CPM) <- gsub("_paired_Abundance.CPM$", "",  # remov the suffix "_paired_Abundance-CPM"
                                             colnames(Raf_OA_HuMaNn3_Pathway_CPM))

Raf_OA_MetaPhlan_data <- read.csv("Raf_OA_MetaPhlan_data.csv", header = TRUE, row.names = 1) %>% as.data.frame()
Raf_OA_MetaPhlan_metadata <- read.csv("Raf_OA_phenotypes.csv", header = TRUE, row.names = 1) %>% as.data.frame()
Raf_OA_CAZyme_PUL_data <- read.csv("Raf_Combined_PUL_Data.csv", header = TRUE, row.names = 1) %>% as.data.frame()

Raf_OA_MetaPhlan_data_transposed <-t(Raf_OA_MetaPhlan_data)
Raf_OA_HuMaNn3_Pathway_CPM_transposed <-t(Raf_OA_HuMaNn3_Pathway_CPM)

# Calculate Shannon index for each sample
Raf_OA_MetaPhlan_shannon_index <- diversity(Raf_OA_MetaPhlan_data_transposed, index = "shannon")
Raf_OA_HuMaNn3_shannon_index <- diversity(Raf_OA_HuMaNn3_Pathway_CPM_transposed, index = "shannon")
Raf_OA_CAZyme_PUL_shannon_index <- diversity(Raf_OA_CAZyme_PUL_data, index = "shannon")

# Convert Shannon index to a data frame
Raf_OA_MetaPhlan_shannon_df <- data.frame(Sample_ID = rownames(Raf_OA_MetaPhlan_data_transposed), 
                                          Shannon_Index = Raf_OA_MetaPhlan_shannon_index)

Raf_OA_HuMaNn3_shannon_df <- data.frame(Sample_ID = rownames(Raf_OA_HuMaNn3_Pathway_CPM_transposed), 
                                        Shannon_Index = Raf_OA_HuMaNn3_shannon_index)

Raf_OA_CAZyme_PUL_shannon_df <- data.frame(Sample_ID = rownames(Raf_OA_CAZyme_PUL_data), 
                                           Shannon_Index = Raf_OA_CAZyme_PUL_shannon_index)

# Rename the Shannon index columns for clarity
colnames(Raf_OA_MetaPhlan_shannon_df)[2] <- "MetaPhlan_Shannon_Index"
colnames(Raf_OA_HuMaNn3_shannon_df)[2] <- "HuMaNn3_Shannon_Index"
colnames(Raf_OA_CAZyme_PUL_shannon_df)[2] <- "CAZyme_PUL_shannon_Index"

# Merge MetaPhlan4, HumaNn3, CAZyme_PUL shannon index and metadata by 'row.names'
Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df <- merge(Raf_OA_MetaPhlan_shannon_df, 
                                                    Raf_OA_HuMaNn3_shannon_df,
                                                    by= "Sample_ID", all = TRUE)

rownames(Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df) <- Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df[, 1]
Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df <- Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df[, -1]
Raf_OA_metagenomic_shannon_with_metadata <- merge(Raf_OA_MetaPhlan_HuMaNn3_merged_shannon_df,
                                                    Raf_OA_MetaPhlan_metadata,
                                                    by= "row.names", all = TRUE)

Raf_OA_CAZyme_shannon_with_metadata <- merge(Raf_OA_CAZyme_PUL_shannon_df, Raf_OA_MetaPhlan_metadata, 
                                             by= "row.names", all = TRUE)

Raf_OA_metagenomic_shannon_with_metadata$Group <- factor(Raf_OA_metagenomic_shannon_with_metadata$Group, 
                                                         levels = c('Placebo_M0', 'Placebo_M3','Placebo_M6', 
                                                                    'Prebiotic_M0','Prebiotic_M3','Prebiotic_M6'))
Raf_OA_CAZyme_shannon_with_metadata$Group <- factor(Raf_OA_CAZyme_shannon_with_metadata$Group, 
                                                    levels = c('Placebo_M0', 'Placebo_M3','Placebo_M6', 
                                                               'Prebiotic_M0','Prebiotic_M3','Prebiotic_M6'))

# Function to compute mean and SEM
compute_mean_sem <- function(data, index_column, index_name) {
  data %>%
    group_by(Diets, Months) %>%
    summarise(
      Mean = mean(.data[[index_column]], na.rm = TRUE),
      SEM = sd(.data[[index_column]], na.rm = TRUE) / sqrt(n())
    ) %>%
    ungroup() %>%
    mutate(Index = index_name)  # Add column to specify which index this data belongs to
}

# Compute mean and SEM for each index
metaPhlan_stats <- compute_mean_sem(Raf_OA_metagenomic_shannon_with_metadata, "MetaPhlan_Shannon_Index", "MetaPhlan")
humanN3_stats <- compute_mean_sem(Raf_OA_metagenomic_shannon_with_metadata, "HuMaNn3_Shannon_Index", "HuMaNn3")
cazyme_stats <- compute_mean_sem(Raf_OA_CAZyme_shannon_with_metadata, "CAZyme_PUL_shannon_Index", "CAZyme_PUL")

# Combine into one data frame
combined_stats <- bind_rows(metaPhlan_stats, humanN3_stats, cazyme_stats)
write_csv(combined_stats, "Raf_OA_metagenomic_Shannon_Index_Stats.csv")

# Fit mixed-effects models
Raf_OA_MetaPhlan_shannon <- lmer(MetaPhlan_Shannon_Index ~ Diets* Months +  (1 | Participant), 
              data = Raf_OA_metagenomic_shannon_with_metadata, REML = TRUE)
Raf_OA_HuMaNn3_shannon <- lmer(HuMaNn3_Shannon_Index ~ Diets * Months + (1 | Participant), 
                                   data = Raf_OA_metagenomic_shannon_with_metadata, REML = TRUE)
Raf_OA_CAZyme_PUL_shannon <- lmer(CAZyme_PUL_shannon_Index ~ Diets * Months + (1 | Participant), 
                                       data = Raf_OA_CAZyme_shannon_with_metadata , REML = TRUE)

# After fitting  models, check the residuals for normality:
meta_residuals <- residuals(Raf_OA_MetaPhlan_shannon)
human_residuals <- residuals(Raf_OA_HuMaNn3_shannon)
cazyme_residuals <- residuals(Raf_OA_CAZyme_PUL_shannon)

shapiro.test(meta_residuals) # Shapiro-Wilk test for normality
shapiro.test(human_residuals)
shapiro.test(cazyme_residuals) 

# All passed normality --- proceed with linear mixed effects
summary(Raf_OA_MetaPhlan_shannon)
summary(Raf_OA_HuMaNn3_shannon)
summary(Raf_OA_CAZyme_PUL_shannon)

anova(Raf_OA_MetaPhlan_shannon)
anova(Raf_OA_HuMaNn3_shannon)
anova(Raf_OA_CAZyme_PUL_shannon)

# Compute estimated marginal means
Raf_OA_MetaPhlan_shannon_emm_meta <- emmeans(Raf_OA_MetaPhlan_shannon, ~ Diets*Months)
Raf_OA_HuMaNn3_shannon_emm_meta <- emmeans(Raf_OA_HuMaNn3_shannon, ~ Diets* Months)
Raf_OA_CAZyme_PUL_shannon_emm_meta <- emmeans(Raf_OA_CAZyme_PUL_shannon, ~ Diets*Months)

print(Raf_OA_HuMaNn3_shannon_emm_meta)
print(Raf_OA_MetaPhlan_shannon_emm_meta)
print(Raf_OA_CAZyme_PUL_shannon_emm_meta)

# Pairwise comparisons
Raf_OA_HuMaNn3_shannon_emm_meta_posthoc_meta <- contrast(
  Raf_OA_HuMaNn3_shannon_emm_meta, interaction = c("pairwise"),simple = "each")

Raf_OA_MetaPhlan_shannon_emm_meta_posthoc_meta <- contrast(
  Raf_OA_MetaPhlan_shannon_emm_meta, interaction = c("pairwise"),simple = "each")

Raf_OA_CAZyme_PUL_shannon_emm_meta_posthoc_meta <- contrast(
  Raf_OA_CAZyme_PUL_shannon_emm_meta, interaction = c("pairwise"),simple = "each")


# Print & Save the results
summary(Raf_OA_MetaPhlan_shannon_emm_meta_posthoc_meta)
summary(Raf_OA_HuMaNn3_shannon_emm_meta_posthoc_meta)
summary(Raf_OA_CAZyme_PUL_shannon_emm_meta_posthoc_meta)

write.csv(Raf_OA_MetaPhlan_shannon_emm_meta_posthoc_meta, "Raf_OA_MetaPhlan_shannon_emm_meta_posthoc_meta.csv")
write.csv(Raf_OA_HuMaNn3_shannon_emm_meta_posthoc_meta, "Raf_OA_HuMaNn3_shannon_emm_meta_posthoc_meta.csv")
write.csv(Raf_OA_CAZyme_PUL_shannon_emm_meta_posthoc_meta, "Raf_OA_CAZyme_PUL_shannon_emm_meta_posthoc_meta.csv")

# Generate Violin Plot for shannon indexes
Raf_OA_MetaPhlan_shannon_violin_plot <- ggplot(Raf_OA_metagenomic_shannon_with_metadata, 
                                       aes(x = Months, y = MetaPhlan_Shannon_Index, fill = Group)) +
  geom_violin(alpha = 0.65, trim = TRUE) +  
  geom_boxplot(width = 0.2, position = position_dodge(0.9), alpha = 0.8) +  # Add boxplot on top
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) + 
  mytheme4 +
  ylab("Shannon Index") +
  xlab(" ")

Raf_OA_HuMaNn3_shannon_violin_plot <- ggplot(Raf_OA_metagenomic_shannon_with_metadata, 
                                     aes(x = Months, y = HuMaNn3_Shannon_Index, fill = Group)) +
  geom_violin(alpha = 0.65, trim = TRUE) +  
  geom_boxplot(width = 0.2, position = position_dodge(0.9), alpha = 0.8) +  # Add boxplot on top
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +    
  mytheme4 +
  ylab(" ") +
  xlab("Time (month)") 

Raf_OA_CAZyme_PUL_shannon_violin_plot <- ggplot(Raf_OA_CAZyme_shannon_with_metadata, 
                                                aes(x = Months, y = CAZyme_PUL_shannon_Index, fill = Group)) +
  geom_violin(alpha = 0.65, trim = TRUE) + 
  geom_boxplot(width = 0.2, position = position_dodge(0.9), alpha = 0.8, 
               outlier.colour = NA) +  
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +  # Plot points with jitter
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) + 
  ylab(" ") +
  xlab(" ") +
  mytheme4 

Raf_OA_shannon_combined_plot <- ggarrange(
  Raf_OA_MetaPhlan_shannon_violin_plot,
  Raf_OA_HuMaNn3_shannon_violin_plot,
  Raf_OA_CAZyme_PUL_shannon_violin_plot,
  ncol = 3, nrow = 1,        
  labels = c("MetaPhlAn4 Taxonomy", 
             "HUMAnN3 Pathway",
             "dbCAN3 PUL"))

Raf_OA_shannon_combined_plot

### Calculate Bray-Curtis dissimilarity with Matephlan4, HumaNn3 Pathway & CAZyme_PUL, no need additional normalization ### 
Raf_OA_Matephlan_bray_curtis <- vegdist(Raf_OA_MetaPhlan_data_transposed, method = "bray")
Raf_OA_HuMaNn3_bray_curtis <- vegdist(Raf_OA_HuMaNn3_Pathway_CPM_transposed, method = "bray")
Raf_OA_CAZyme_PUL_bray_curtis <- vegdist(Raf_OA_CAZyme_PUL_data, method = "bray")

Raf_OA_Matephlan_bray_curtis_matrix <- as.matrix(Raf_OA_Matephlan_bray_curtis)
Raf_OA_HuMaNn3_bray_curtis_matrix <- as.matrix(Raf_OA_HuMaNn3_bray_curtis)
Raf_OA_CAZyme_PUL_bray_curtis_matrix <- as.matrix(Raf_OA_CAZyme_PUL_bray_curtis)

Raf_OA_MetaPhlan_nmds <- metaMDS(Raf_OA_Matephlan_bray_curtis_matrix, distance = "bray", k = 3, trymax = 2000)
Raf_OA_HuMaNn3_nmds <- metaMDS(Raf_OA_HuMaNn3_bray_curtis, distance = "bray", k = 3, trymax = 2000)
Raf_OA_CAZyme_PUL_nmds <- metaMDS(Raf_OA_CAZyme_PUL_bray_curtis_matrix, distance = "bray", k = 3, trymax = 2000)

# Check the stress value to assess the quality of the ordination (< 0.2 is acceptable)
Raf_OA_MetaPhlan_nmds$stress
Raf_OA_HuMaNn3_nmds$stress
Raf_OA_CAZyme_PUL_nmds$stress

# Extract the NMDS configuration (points in each dimension)
metaPhlan_coordinates <- Raf_OA_MetaPhlan_nmds$points
humanNn3_coordinates <- Raf_OA_HuMaNn3_nmds$points
cazymePUL_coordinates <- Raf_OA_CAZyme_PUL_nmds$points

# Calculate the total variance for each NMDS configuration
metaPhlan_total_variance <- sum(dist(metaPhlan_coordinates)^2)
humanNn3_total_variance <- sum(dist(humanNn3_coordinates)^2)
cazymePUL_total_variance <- sum(dist(cazymePUL_coordinates)^2)

# Estimate the variance explained by each dimension based on the total variance and the distance matrix
metaPhlan_variance_explained <- apply(metaPhlan_coordinates, 2, function(dim) {
  sum(dist(cbind(dim))^2) / metaPhlan_total_variance * 100
})

humanNn3_variance_explained <- apply(humanNn3_coordinates, 2, function(dim) {
  sum(dist(cbind(dim))^2) / humanNn3_total_variance * 100
})

cazymePUL_variance_explained <- apply(cazymePUL_coordinates, 2, function(dim) {
  sum(dist(cbind(dim))^2) / cazymePUL_total_variance * 100
})

# Print the variance explained by each dimension
cat("MetaPhlan NMDS Variance Explained by Each Dimension:\n")
print(metaPhlan_variance_explained)

cat("\nHuMaNn3 NMDS Variance Explained by Each Dimension:\n")
print(humanNn3_variance_explained)

cat("\nCAZyme PUL NMDS Variance Explained by Each Dimension:\n")
print(cazymePUL_variance_explained)

# Extract NMDS coordinates
Raf_OA_MetaPhlan_nmds_coordinates <- as.data.frame(Raf_OA_MetaPhlan_nmds$points)
Raf_OA_HuMaNn3_nmds_coordinates <- as.data.frame(Raf_OA_HuMaNn3_nmds$points)
Raf_OA_CAZyme_PUL_nmds_coordinates <- as.data.frame(Raf_OA_CAZyme_PUL_nmds$points)

# Assign Sample_ID for each NMDS coordinates dataset correctly
Raf_OA_MetaPhlan_nmds_coordinates$Sample_ID <- rownames(Raf_OA_MetaPhlan_nmds_coordinates)
Raf_OA_HuMaNn3_nmds_coordinates$Sample_ID <- rownames(Raf_OA_HuMaNn3_nmds_coordinates)
Raf_OA_CAZyme_PUL_nmds_coordinates$Sample_ID <- rownames(Raf_OA_CAZyme_PUL_nmds_coordinates)
Raf_OA_MetaPhlan_metadata$Sample_ID <- rownames(Raf_OA_MetaPhlan_metadata)

# Merge NMDS coordinates with metadata (ensure Sample_ID matches between coordinates and metadata)
Raf_OA_self_reported_nutrition_GI_data <- Raf_OA_self_reported_data_long %>%
  filter(Variable %in% c("GI_stools_day", "Total_energy", "Protein",
                         "Carbohydrate","Total_Sugars", "Total_Fat")) %>%
  select(Sample_Name, Variable, Value) %>%
  pivot_wider(names_from = Variable, values_from = Value) 

Raf_OA_MetaPhlan_metadata_with_self_report_data <- merge(Raf_OA_MetaPhlan_metadata,
                                                         Raf_OA_self_reported_nutrition_GI_data,
                                                         by = "Sample_Name") %>% as.data.frame()

str(Raf_OA_MetaPhlan_metadata_with_self_report_data)

Raf_OA_MetaPhlan_nmds_with_metadata <- merge(Raf_OA_MetaPhlan_nmds_coordinates, 
                                              Raf_OA_MetaPhlan_metadata_with_self_report_data, 
                                              by = "Sample_ID")

Raf_OA_HuMaNn3_nmds_with_metadata <- merge(Raf_OA_HuMaNn3_nmds_coordinates, 
                                             Raf_OA_MetaPhlan_metadata_with_self_report_data, 
                                             by = "Sample_ID")

Raf_OA_CAZyme_PUL_nmds_with_metadata <- merge(Raf_OA_CAZyme_PUL_nmds_coordinates, 
                                                    Raf_OA_MetaPhlan_metadata_with_self_report_data, 
                                                    by = "Sample_ID")

# Define the factors to test
Raf_OA_adonis_factors <- c("Diets", "Months", "Participant", "Sex")

str(Raf_OA_MetaPhlan_metadata_with_self_report_data)

# Define the datasets and corresponding metadata
Raf_OA_adonis_datasets <- list(
  MetaPhlan = Raf_OA_Matephlan_bray_curtis_matrix,
  HuMaNn3 = Raf_OA_HuMaNn3_bray_curtis_matrix,
  CAZyme_PUL = Raf_OA_CAZyme_PUL_bray_curtis_matrix
)

Raf_OA_metadata <- Raf_OA_MetaPhlan_metadata_with_self_report_data %>%
  select(all_of(Raf_OA_adonis_factors)) 

str(Raf_OA_metadata)

Raf_OA_adonis_PERMANOVA_results <- list()

# Loop over datasets and factors to run the PERMANOVA analysis
for (dataset_name in names(Raf_OA_adonis_datasets)) {
  dataset <- Raf_OA_adonis_datasets[[dataset_name]]
  
  for (factor in Raf_OA_adonis_factors) {
    formula <- as.formula(paste("dataset ~", factor)) 
    result <- adonis2(formula, data = Raf_OA_metadata, permutations = 999, na.rm = TRUE)
    Raf_OA_adonis_PERMANOVA_results[[paste0(dataset_name, "_", factor)]] <- result
  }
}
Raf_OA_adonis_PERMANOVA_results
write.csv(Raf_OA_adonis_PERMANOVA_results, "Raf_OA_adonis_PERMANOVA_results.csv")

Raf_OA_adonis_PERMANOVA_data <-read.csv("Raf_OA_adonis_PERMANOVA_results_orangnized.csv") %>%
  filter(Index %in% "R2") 

Raf_OA_adonis_PERMANOVA_data$Factor <- factor(Raf_OA_adonis_PERMANOVA_data$Factor, 
                                               levels = c("Time", "Sex", "Diets",  "Participant"))

Raf_OA_adonis_PERMANOVA_data$Model <- factor(Raf_OA_adonis_PERMANOVA_data$Model, 
                                               levels = c("MetaPhlan", "HuMaNn3", "dbCAN3_PUL"))

# Create the boxplot with custom factor levels
Raf_OA_adonis_PERMANOVA_barplot <- ggplot(Raf_OA_adonis_PERMANOVA_data, aes(x = Factor, y = Value, fill = Model)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Model) +
  coord_flip() +  # Flip the axes
  mytheme1 +
  labs(x = "Factor", y = "PERMANOVA RÂ²")
Raf_OA_adonis_PERMANOVA_barplot

ggsave("Raf_OA_adonis_PERMANOVA_barplot.svg", 
       plot = Raf_OA_adonis_PERMANOVA_barplot, 
       device = "svg", 
       width = 6, height = 2.5, 
       units = "in")

#### Make NMDS plots ###
Raf_OA_MetaPhlan_nmds_with_metadata$Group <- factor(Raf_OA_MetaPhlan_nmds_with_metadata$Group, 
                                   levels = c('Placebo_M0', 'Placebo_M3','Placebo_M6', 
                                              'Prebiotic_M0','Prebiotic_M3','Prebiotic_M6'))

Raf_OA_HuMaNn3_nmds_with_metadata$Group <- factor(Raf_OA_HuMaNn3_nmds_with_metadata$Group,
                                                  levels = c('Placebo_M0', 'Placebo_M3','Placebo_M6',
                                                             'Prebiotic_M0','Prebiotic_M3','Prebiotic_M6'))

Raf_OA_CAZyme_PUL_nmds_with_metadata$Group <- factor(Raf_OA_CAZyme_PUL_nmds_with_metadata$Group, 
                                                          levels = c('Placebo_M0','Placebo_M3','Placebo_M6',
                                                                     'Prebiotic_M0','Prebiotic_M3','Prebiotic_M6'))


Raf_OA_MetaPhlan_NMDS <- ggplot(data=Raf_OA_MetaPhlan_nmds_with_metadata, 
                                aes(x = MDS1, y = MDS2, fill = Group)) +
  geom_mark_ellipse(aes(color = Group), alpha = 0.45, size = 1, linetype = 2, expand = 0) +
  geom_point(aes(fill = Group), size = 4, shape = 21, color = "black") +
  scale_color_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  mytheme4

Raf_OA_HuMaNn3_NMDS <- ggplot(data=Raf_OA_HuMaNn3_nmds_with_metadata, 
                              aes(x = MDS1, y = MDS2, fill = Group)) +
  geom_mark_ellipse(aes(color = Group), alpha = 0.45, size = 1, linetype = 2, expand = 0) +
  geom_point(aes(fill = Group), size = 4, shape = 21, color = "black") +
  scale_color_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  mytheme4

Raf_OA_CAZyme_PUL_NMDS <- ggplot(data=Raf_OA_CAZyme_PUL_nmds_with_metadata, 
                                      aes(x = MDS1, y = MDS2, fill = Group)) +
  geom_mark_ellipse(aes(color = Group), alpha = 0.45, size = 1, linetype = 2, expand = 0) +
  geom_point(aes(fill = Group), size = 4, shape = 21, color = "black") +
  scale_color_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  mytheme4

Raf_OA_MetaPhlan_NMDS
Raf_OA_HuMaNn3_NMDS
Raf_OA_CAZyme_PUL_NMDS

Raf_OA_NMDS_combined_plot <- ggarrange(
  Raf_OA_MetaPhlan_NMDS,
  Raf_OA_HuMaNn3_NMDS,
  Raf_OA_CAZyme_PUL_bray_NMDS,
  ncol = 3, nrow = 1,        
  labels = c("MetaPhlAn4 Taxonomy", "HUMAnN3 Pathway","dbCAN3 PUL"))
Raf_OA_NMDS_combined_plot

# Shepard plot
Raf_OA_MetaPhlan_shepard_plot <- vegan::stressplot(Raf_OA_MetaPhlan_nmds)
Raf_OA_HuMaNn3_shepard_plot <- vegan::stressplot(Raf_OA_HuMaNn3_nmds)
Raf_OA_CAZyme_PUL_shepard_plot <- vegan::stressplot(Raf_OA_CAZyme_PUL_nmds)

```


```{r Figure S1A. Peformance of micorbiome, cytokine, metabolites as Random Forest predictors}
# Step 1: Load Data
Raf_OA_Cytokine_data <- read.csv("Raf_OA_phenotypes.csv", header = TRUE, row.names = 1) %>%
  select(c(LPS: IL_10))

Raf_OA_MetaPhlan_species <- read.delim("Raf_OA_metaphlan_merged_abundance_table_species.txt", header = TRUE, row.names = 1)
colnames(Raf_OA_MetaPhlan_species) <- gsub("d_metagenome$", "", colnames(Raf_OA_MetaPhlan_species))
Raf_OA_MetaPhlan_data_transposed <- as.data.frame(t(Raf_OA_MetaPhlan_species))
Raf_OA_Metagemoics_combined_data <- merge(Raf_OA_Cytokine_data,
                                          Raf_OA_MetaPhlan_data_transposed, 
                                          by = "row.names", all = TRUE)
rownames(Raf_OA_Metagemoics_combined_data) <- Raf_OA_Metagemoics_combined_data$Row.names
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data[, -1]


Raf_OA_HuMaNn3_Pathway_CPM <- read.delim("Raf_OA_humann_pathabundance_cpm_normalized_unstratified.tsv", 
                                         header = TRUE, row.names = 1)
colnames(Raf_OA_HuMaNn3_Pathway_CPM) <- gsub("_paired_Abundance.CPM$", "", colnames(Raf_OA_HuMaNn3_Pathway_CPM))
Raf_OA_HuMaNn3_Pathway_CPM_transposed <- as.data.frame(t(Raf_OA_HuMaNn3_Pathway_CPM))
Raf_OA_Metagemoics_combined_data <- merge(Raf_OA_Metagemoics_combined_data,
                                          Raf_OA_HuMaNn3_Pathway_CPM_transposed, 
                                          by = "row.names", all = TRUE)
rownames(Raf_OA_Metagemoics_combined_data) <- Raf_OA_Metagemoics_combined_data$Row.names
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data[, -1]

Raf_OA_PUL_Contig_data <- read.csv("Raf_Summarized_PUL_Data.csv", header = TRUE, row.names = 1) %>%
  select(-c(Sample_Name, Participant, Group, Treatment, Time))
Raf_OA_Metagemoics_combined_data <- merge(Raf_OA_Metagemoics_combined_data,
                                          Raf_OA_PUL_Contig_data, 
                                          by = "row.names", all = TRUE)
rownames(Raf_OA_Metagemoics_combined_data) <- Raf_OA_Metagemoics_combined_data$Row.names
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data[, -1]


Raf_OA_Metabolites_intensity_filtered_data <- read.csv("Raf_metabolites_quality_control_Filtered_Intensity_Data.csv", 
                                                       header = TRUE, row.names = 1) %>%
  select(-c(Sample_Name))
Raf_OA_Metagemoics_combined_data <- merge(Raf_OA_Metagemoics_combined_data,
                                          Raf_OA_Metabolites_intensity_filtered_data, 
                                          by = "row.names", all = TRUE)
rownames(Raf_OA_Metagemoics_combined_data) <- Raf_OA_Metagemoics_combined_data$Row.names
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data[, -1]

# Replace missing values with the median for numeric columns BEFORE scaling
numeric_columns <- sapply(Raf_OA_Metagemoics_combined_data, is.numeric)
Raf_OA_Metagemoics_combined_data[numeric_columns] <- lapply(
  Raf_OA_Metagemoics_combined_data[numeric_columns], 
  function(x) ifelse(is.na(x), median(x, na.rm = TRUE), x)
)

# Apply z-score normalization to all numeric columns AFTER replacing NA
Raf_OA_Metagemoics_combined_data[numeric_columns] <- scale(Raf_OA_Metagemoics_combined_data[numeric_columns])

# Merge phenotype changes with the dataset
Raf_OA_phenotypes <- read.csv("Raf_OA_phenotypes.csv", header = TRUE, row.names = 1) %>%
  select(-c(LPS: IL_10)) %>%
  select(-c(Acetate: Valerate))

Raf_OA_Metagemoics_combined_data <- merge(Raf_OA_phenotypes,
                                          Raf_OA_Metagemoics_combined_data,
                                          by = "row.names")
rownames(Raf_OA_Metagemoics_combined_data) <- Raf_OA_Metagemoics_combined_data$Row.names
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data[, -1]

# Define response variables and ensure they are numeric
response_vars <- c("TotalMass", "TotalLean","TotalFat", "TrunkFatKg","TrunkFat.","BMC", "BMD", 
                   "HandGrip", "TimeUpGo", "FastWalk", "SixMinWalk",  "SitToStand")

Raf_OA_Metagemoics_combined_data[response_vars] <- lapply(
  Raf_OA_Metagemoics_combined_data[response_vars], as.numeric
)

# Convert categorical variables to factors
Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data %>%
  mutate(Diets = as.factor(Diets))

# Specify the range of columns for predictors
predictor_ranges <- list(
  cytokine = 20:29,
  compositional = 30:1307,  
  functional = c(1308:1779),
  PULfunctional = 1780:2148,
  PULPLUS = c(1308:2148),
  Metabolites = 2149:2206,
  cytokine_compositional = c(20:29, 30:1307),
  cytokine_functional = c(20:29, 1308:1779),
  cytokine_PULfunctional = c(20:29, 1780:2148),
  cytokine_PULPLUS = c(20:29, 1308:2148),
  cytokine_Metabolites = c(20:29, 2149:2206),
  Metabolites_compositional = c(2149:2206, 30:1307),
  Metabolites_functional = c(2149:2206, 1308:1779),
  Metabolites_PULfunctional = c(2149:2206, 1780:2148),
  Metabolites_PULPLUS = c(2149:2206, 1308:2148)
)

# Step 2: Set Up Control with Bootstrapping
set.seed(123)
train_control <- trainControl(
  method = "boot",       # Use bootstrapping for re-sampling
  number = 1000,          # Number of bootstrap iterations
  returnResamp = "final"
)

# Define a tuning grid for mtry 
tune_grid <- expand.grid(mtry = seq(1, 15, by = 2))

# Register parallel backend
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# Function to preprocess predictors
prepare_predictors <- function(data, cols) {
  data %>%
    select(Diets, all_of(colnames(data)[cols])) %>%
    select_if(is.numeric) %>%
    select(-nearZeroVar(.))
}

# Train random forest models 
train_rf_model <- function(response, rf_predictors, response_values) {
  tryCatch({
    train(
      x = rf_predictors,
      y = response_values,
      method = "rf",
      trControl = train_control,
      tuneGrid = tune_grid,
      ntree = 500,         # Reduced number of trees for regularization
      maxnodes = 10,       # Reduced complexity
      nodesize = 20,       # Larger terminal nodes for simplicity
      importance = TRUE
    )
  }, error = function(e) {
    message("Error in model training: ", e)
    NULL
  })
}

# Initialize a list to store results
results_summary <- list()

### detach("package:MOFA2", unload = TRUE) --- solution for "predict" function conflicts ####

# Step 3: Fit Random Forest Models for Each Response Variable and Predictor Set
for (response in response_vars) {
  # Filter for non-missing values in response
  data_filtered <- Raf_OA_Metagemoics_combined_data %>% filter(!is.na(.data[[response]]))
  response_values <- data_filtered[[response]]
  
  for (predictor_set in names(predictor_ranges)) {
    cat("\nTraining model for response:", response, "with predictors:", predictor_set, "\n")
    rf_predictors <- prepare_predictors(data_filtered, predictor_ranges[[predictor_set]])
    
    if (nrow(rf_predictors) > 5 & ncol(rf_predictors) > 0) {
      rf_model <- train_rf_model(response, rf_predictors, response_values)
      
      if (!is.null(rf_model)) {
        # Store model results
        training_performance <- postResample(predict(rf_model$finalModel, rf_predictors), response_values)
        best_tune <- rf_model$bestTune
        results_summary[[response]] <- rbind(
          results_summary[[response]],
          data.frame(
            Model = predictor_set,
            Response = response,
            Best_mtry = best_tune$mtry,
            Train_RMSE = training_performance[1],
            Validation_RMSE = rf_model$results$RMSE[which.min(rf_model$results$RMSE)],
            Overfit_Degree = training_performance[1] - rf_model$results$RMSE[which.min(rf_model$results$RMSE)],
            Rsquared = rf_model$results$Rsquared[which.min(rf_model$results$RMSE)],
            MAE = rf_model$results$MAE[which.min(rf_model$results$RMSE)]
          )
        )
        
        # Extract and save top features
        importance_data <- as.data.frame(varImp(rf_model)$importance)
        importance_data$Variable <- rownames(importance_data)
        top_features <- importance_data %>% arrange(desc(Overall)) %>% head(10)
        write.csv(top_features, 
                  file = paste0("Top_10_Features_", predictor_set, "_", response, ".csv"), 
                  row.names = FALSE)
        
        # Save the trained model
        saveRDS(rf_model, file = paste0("RF_Model_", predictor_set, "_", response, ".rds"))
      }
    } else {
      cat("Insufficient data for predictor set:", predictor_set, "\n")
    }
  }
}

# Combine all results into a single data frame
final_results3 <- do.call(rbind, results_summary)
write.csv(final_results3, "RF_Results_Summary_3_updates.csv", row.names = FALSE)

# Visualize results
dark2_colors <- colorRampPalette(brewer.pal(8, "Dark2"))(15) 
final_results <- read.csv("Raf_OA_Metagemoics_Random_Forest_model_summary2.csv")
final_results$Response <- factor(final_results$Response, 
                                 levels =  c("TotalMass", "TotalLean","TotalFat", "TrunkFatKg","TrunkFat.","BMC", "BMD", 
                                             "HandGrip", "TimeUpGo", "FastWalk", "SixMinWalk",  "SitToStand"))
str(final_results)


final_results$Predictor <- factor(final_results$Predictor, 
                                     levels =  c("MetaPhlAn4 Taxonomy", "HUMAnN3 Pathway", "dbCAN3 PUL", 
                                             "Serum Cytokine",  "Cytokine +  MetaPhlAn4", 
                                             "Cytokine + HUMAnN3", "Cytokine + dbCAN3",
                                             "Serum Metabolites", "Metabolites +  MetaPhlAn4", "Metabolites +  HUMAnN3", 
                                             "Metabolites +  dbCAN3","HUMAnN3 + dbCAN3","Cytokine + Metabolites", 
                                             "Cytokine + HUMAnN3 + dbCAN3","Metabolites +  HUMAnN3 + dbCAN3"))

Body_composition_data <- filter(final_results, Phenotype == "Body Composition")
Physical_Fucntion_data <- filter(final_results, Phenotype == "Physical Function")

Raf_OA_Metagemoics_Random_Forest_model_R2_Body_composition <- ggplot(Body_composition_data, 
                                                                     aes(x = Response, y = Rsquared, fill = Predictor)) + 
  geom_bar(position = position_dodge(), stat = "identity") +  
  labs(title = "R-squared Values for Models", x = "Response Variable", y = "R-squared") +
  scale_fill_manual(values = dark2_colors) + 
  mytheme2

Raf_OA_Metagemoics_Random_Forest_model_R2_Physical_Fucntion <- ggplot(Physical_Fucntion_data, 
                                                                      aes(x = Response, y = Rsquared, fill = Predictor)) + 
  geom_bar(position = position_dodge(), stat = "identity") +  
  labs(title = "R-squared Values for Models", x = "Response Variable", y = "R-squared") +
  scale_fill_manual(values = dark2_colors) + 
  mytheme2

Raf_OA_Metagemoics_Random_Forest_model_R2_Body_composition
Raf_OA_Metagemoics_Random_Forest_model_R2_Physical_Fucntion

ggsave("Raf_OA_Metagemoics_Random_Forest_model_R2_Body_composition2.svg", 
       plot = Raf_OA_Metagemoics_Random_Forest_model_R2_Body_composition, 
       device = "svg", 
       width = 10, height = 5, 
       units = "in")

ggsave("Raf_OA_Metagemoics_Random_Forest_model_R2_Physical_Fucntion2.svg", 
       plot = Raf_OA_Metagemoics_Random_Forest_model_R2_Physical_Fucntion, 
       device = "svg", 
       width = 8, height = 5, 
       units = "in")

# Stop the parallel backend
stopCluster(cl)
```


```{r Fig S1B. MaAsLin 3 Stats & figures on MetaPhlan4 Species}
library(maaslin2) # MaAsLin3 (Microbiome Multivariable Association with Linear Models) 
library(RColorBrewer)

Raf_OA_MetaPhlan_species <- read.delim("Raf_OA_metaphlan_merged_abundance_table_species.txt", 
                                       header = TRUE, row.names = 1) 

# Update the column names by removing the suffix "d_metagenome"
colnames(Raf_OA_MetaPhlan_species) <- gsub("d_metagenome$", "", colnames(Raf_OA_MetaPhlan_species))
Raf_OA_MetaPhlan_species_transposed <-t(Raf_OA_MetaPhlan_species)
Raf_OA_MetaPhlan_species_transposed <- as.data.frame(Raf_OA_MetaPhlan_species_transposed)
af_OA_MetaPhlan_metadata <- read.csv("Raf_OA_phenotypes.csv", header = TRUE, row.names = 1)

Raf_OA_MetaPhlan_species_transposed$Sample_ID <- rownames(Raf_OA_MetaPhlan_species_transposed)
af_OA_MetaPhlan_metadata$Sample_ID <- rownames(Raf_OA_MetaPhlan_metadata)

Raf_OA_MetaPhlan_with_metadata <- merge(Raf_OA_MetaPhlan_species_transposed,
                                        Raf_OA_MetaPhlan_metadata,
                                        by="Sample_ID")

# Identify the start of phenotype columns (i.e., first non-metadata column)
Raf_OA_MetaPhlan_phenotype_start <- which(names(Raf_OA_MetaPhlan_with_metadata) == "Sample_Name")  

# Select metadata columns correctly
Raf_OA_MetaPhlan_data_columns <- names(Raf_OA_MetaPhlan_with_metadata)[1:(Raf_OA_MetaPhlan_phenotype_start - 1)]
Raf_OA_MetaPhlan_data_columns <- setdiff(Raf_OA_MetaPhlan_data_columns, "Sample_ID")  # Exclude Sample_ID
Raf_OA_MetaPhlan_data_columns <- union(Raf_OA_MetaPhlan_data_columns, c("Diets", "Months", "Participant"))   
Raf_OA_MetaPhlan_data_columns

# Function to check normality and count non-normal variables
check_normality <- function(df, columns) {
  numeric_columns <- columns[sapply(df[columns], is.numeric)]
  if (length(numeric_columns) == 0) {
    stop("No numeric columns found for normality check!")
  }

  normality_results <- data.frame(Variable = numeric_columns, Shapiro_p = NA, Normality = NA)
  print("### Checking Normality for Selected Columns ###")

  for (col in numeric_columns) {
    p_value <- shapiro.test(df[[col]])$p.value  # Shapiro-Wilk normality test
    normality_results[normality_results$Variable == col, "Shapiro_p"] <- p_value
    normality_results[normality_results$Variable == col, "Normality"] <- p_value > 0.05  # TRUE if normally distributed
    print(paste("Variable:", col, "| Shapiro-Wilk p-value:", round(p_value, 4), "| Normally Distributed:", p_value > 0.05))
  }

  # Count the number of non-normally distributed variables
  num_non_normal <- sum(!normality_results$Normality)
  num_total <- nrow(normality_results)
  
  print("### Normality Test Summary ###")
  print(normality_results)
  print(paste("Total Variables Tested:", num_total))
  print(paste("Variables NOT Normally Distributed:", num_non_normal))

  # Visualization: Histograms & Q-Q Plots
  par(mfrow=c(2,3))  # Adjust layout for multiple plots
  for (col in numeric_columns[1:min(6, length(numeric_columns))]) {
    hist(df[[col]], main = paste("Histogram of", col), xlab = col, breaks = 20, col = "lightblue")
    qqnorm(df[[col]], main = paste("Q-Q Plot of", col))
    qqline(df[[col]], col = "red")
  }

  return(list(results = normality_results, non_normal_count = num_non_normal))
}

# Run normality check
normality_check <- check_normality(Raf_OA_MetaPhlan_with_metadata, Raf_OA_MetaPhlan_data_columns)
write.csv(normality_check$results, "Normality_Test_Results.csv", row.names = FALSE)
print(paste("Number of Variables NOT Normally Distributed:", normality_check$non_normal_count))

##### Majority cols are not normally distributed
# Function to apply log transformation to all numeric columns, handling zeros
log_transform_data <- function(df, columns) {
  numeric_columns <- columns[sapply(df[columns], is.numeric)]
  if (length(numeric_columns) == 0) {
    stop("No numeric columns found for log transformation!")
  }
  for (col in numeric_columns) {
    df[[col]] <- log1p(df[[col]])  # log(N + 1) transformation to handle zeros
    print(paste("Log transformation applied for:", col))
  }
  return(df)
}

# Apply log transformation to all numeric columns in the dataset
Raf_OA_MetaPhlan_log_transformed <- log_transform_data(Raf_OA_MetaPhlan_with_metadata, 
                                                       Raf_OA_MetaPhlan_data_columns)

write.csv(Raf_OA_MetaPhlan_log_transformed, "Log_Transformed_Raf_OA_MetaPhlan.csv", row.names = FALSE)

########## Fit mixed linear model to log transformed data 
# Extract only M0 baseline values for each participant and keep only relevant columns
# --- Step 1: Safe Column Mapping for Microbial Data ---
original_colnames <- colnames(Raf_OA_MetaPhlan_log_transformed)
safe_colnames <- make.names(original_colnames, unique = TRUE)  # Ensure unique, valid names
colname_mapping <- setNames(safe_colnames, original_colnames)  # Map original -> safe names

# Apply safe column names to the dataset
colnames(Raf_OA_MetaPhlan_log_transformed) <- safe_colnames
Raf_OA_MetaPhlan_data_columns <- na.omit(colname_mapping[Raf_OA_MetaPhlan_data_columns])

# --- Step 2: Extract Baseline Values (Month M0) ---
Raf_OA_MetaPhlan_baseline_values <- Raf_OA_MetaPhlan_log_transformed[Raf_OA_MetaPhlan_log_transformed$Months == "M0", Raf_OA_MetaPhlan_data_columns]

# Remove metadata columns from baseline data
Raf_OA_MetaPhlan_baseline_values <- Raf_OA_MetaPhlan_baseline_values[, !colnames(Raf_OA_MetaPhlan_baseline_values) %in% c("Diets", "Months")]

# Rename baseline columns
rename_indices <- 1:(ncol(Raf_OA_MetaPhlan_baseline_values) - 1)
colnames(Raf_OA_MetaPhlan_baseline_values)[rename_indices] <- 
  paste0(colnames(Raf_OA_MetaPhlan_baseline_values)[rename_indices], "_Baseline")

# Remove M0 from main dataset to prevent duplication
Raf_OA_MetaPhlan_log_transformed <- Raf_OA_MetaPhlan_log_transformed[Raf_OA_MetaPhlan_log_transformed$Months != "M0", ]

# --- Step 3: Prepare Metadata ---
Raf_OA_MetaPhlan_metadata <- Raf_OA_MetaPhlan_log_transformed[, c("Sample_ID", "Diets", "Months", "Participant")]
rownames(Raf_OA_MetaPhlan_metadata) <- Raf_OA_MetaPhlan_metadata$Sample_ID

# Merge metadata with baseline values
Raf_OA_MetaPhlan_metadata <- merge(Raf_OA_MetaPhlan_metadata,
                                   Raf_OA_MetaPhlan_baseline_values,
                                   by = "Participant", all.x = TRUE)

# --- Step 4: Identify Microbial Taxa Columns ---
microbial_data_cols <- grep("^k__Bacteria", colnames(Raf_OA_MetaPhlan_log_transformed), value = TRUE)

# Extract microbial data for MaAsLin2
Raf_OA_MetaPhlan_input_data <- Raf_OA_MetaPhlan_log_transformed[, microbial_data_cols]
rownames(Raf_OA_MetaPhlan_input_data) <- Raf_OA_MetaPhlan_log_transformed$Sample_ID

# --- Step 5: Safe Mapping for Microbial Taxa ---
microbial_taxa <- grep("^k__Bacteria", colnames(Raf_OA_MetaPhlan_log_transformed), value = TRUE)
microbial_taxa_safe <- colname_mapping[microbial_taxa]  # Apply safe mapping

# Ensure Sample_ID is rownames in metadata
rownames(Raf_OA_MetaPhlan_metadata) <- Raf_OA_MetaPhlan_metadata$Sample_ID

# Drop Sample_ID column after setting rownames
Raf_OA_MetaPhlan_metadata <- Raf_OA_MetaPhlan_metadata[, !colnames(Raf_OA_MetaPhlan_metadata) %in% "Sample_ID"]

Raf_OA_MetaPhlan_metadata$Diets <- 
  factor(Raf_OA_MetaPhlan_metadata$Diets, levels = c('Placebo', 'Prebiotic'))
Raf_OA_MetaPhlan_metadata$Months <- 
  factor(Raf_OA_MetaPhlan_metadata$Months, levels = c('M0', 'M3', 'M6'))
Raf_OA_MetaPhlan_metadata$Group <- 
  factor(Raf_OA_MetaPhlan_metadata$Group, levels = c("Placebo_M0", "Prebiotic_M0", 
                                                     "Placebo_M3",  "Prebiotic_M3",
                                                     "Placebo_M6",  "Prebiotic_M6"))

entical(rownames(Raf_OA_MetaPhlan_metadata), rownames(Raf_OA_MetaPhlan_species_transposed))

Prebiotic_rownames <- rownames(Raf_OA_MetaPhlan_metadata[Raf_OA_MetaPhlan_metadata$Group %in% c("Prebiotic_M0",
                                                                                                "Prebiotic_M3"), ])
# Extract row names where Group is either "Prebiotic_M0" or "Prebiotic_M3"
Prebiotic_rownames <- rownames(Raf_OA_MetaPhlan_metadata[Raf_OA_MetaPhlan_metadata$Group %in% c("Prebiotic_M0", "Prebiotic_M3"), ])
Raf_OA_MetaPhlan_data_transposed_Prebiotic <- Raf_OA_MetaPhlan_data_transposed[Prebiotic_rownames, , drop = FALSE]
print(Prebiotic_rownames)

M3_rownames <- rownames(Raf_OA_MetaPhlan_metadata[Raf_OA_MetaPhlan_metadata$Months %in% c("M0","M3"), ])
Raf_OA_MetaPhlan_data_transposed_M3 <- Raf_OA_MetaPhlan_data_transposed[M3_rownames, , drop = FALSE]

Raf_OA_MetaPhlan_metadata$Months <- factor(Raf_OA_MetaPhlan_metadata$Months, levels = c("M0", "M3", "M6"))

### MaAsLin2 0n Diet-derived avriations in MetaPhlan4  profile ####
Raf_OA_MetaPhlan_Maaslin2_diet = Maaslin2(Raf_OA_MetaPhlan_species_transposed, # relative abundance
                                               input_metadata = Raf_OA_MetaPhlan_metadata, 
                                               output = 'Raf_OA_MetaPhlan_Maaslin2_Diet',
                                               fixed_effects = c("Diets"), 
                                               reference = c("Diets,Placebo"),
                                               random_effects = c("Participant"),
                                               normalization  = "NONE", 
                                               transform = 'LOG', # default = 'LOG'
                                               min_prevalence = 0,
                                               min_abundance = 0,
                                               standardize = FALSE,
                                               cores = 6) # (by default, analysis_method = "LM')

### Maasline  figures -- MetaPhlAn4 species  Prebiotic vs. Placebo ###########
Raf_OA_MetaPhlan4_sig_species_MaAslin2_Prebiotic <-read.csv("Raf_OA_sig_MetaPhlan4_species_MaAsLin2.csv") %>%
  arrange(coef) %>%
  mutate(feature = factor(feature, levels = feature))

Raf_OA_MetaPhlan4_sig_species_MaAslin2_Prebiotic_figure <- ggplot(Raf_OA_MetaPhlan4_sig_species_MaAslin2_Prebiotic) +
  geom_point(aes(x = feature, y = coef, fill = qval), 
             shape = 21, color = "black", size = 5) +
  scale_fill_gradient(high = "white", low = "#01665e") + 
  geom_errorbar(aes(x = feature, ymin = coef - stderr, ymax = coef + stderr), 
                width = 0.2, color = "black") +
  geom_hline(yintercept = 0, color = "dimgrey", linetype = "dashed", size = 1) +
  labs(x = "MetaPhlan4 Species", y = "Î² coefficient") +
  coord_flip() +  
  mytheme4 
Raf_OA_MetaPhlan4_sig_species_MaAslin2_Prebiotic_figure

ggsave("Raf_OA_MetaPhlan4_sig_species_MaAslin3_Prebiotic_figure.svg", 
       plot = Raf_OA_MetaPhlan4_sig_species_MaAslin3_Prebiotic_figure, 
       device = "svg", 
       width = 6, height = 6.5, 
       units = "in")
```
```{r Figures 2B-C & 4C. Serum Cytokine, LPS & Fecal SCFA Stats & Figures}
Raf_OA_phenotype_data <- read.csv("Raf_OA_phenotypes.csv")
threshold <- 3 

# Filter out outliers for each numeric variable within each Group
Raf_OA_phenotype_data_outlier_filtered <- Raf_OA_phenotype_data %>%
  group_by(Group) %>%
  mutate(across(where(is.numeric), ~ ifelse(abs(. - mean(., na.rm = TRUE)) <= threshold * sd(., na.rm = TRUE), ., NA))) %>%
  ungroup()
str(Raf_OA_phenotype_data_outlier_filtered)


Raf_OA_phenotype_data_outlier_filtered$Group <- factor(Raf_OA_phenotype_data_outlier_filtered$Group, 
                                            levels = c('Placebo_M0', 'Prebiotic_M0',
                                                       'Placebo_M3', 'Prebiotic_M3', 
                                                       'Placebo_M6', 'Prebiotic_M6'))

Raf_OA_phenotype_participant_counts <- table(Raf_OA_phenotype_data_outlier_filtered$Participant)
Raf_OA_phenotype_data_outlier_filtered$Diets <- factor(Raf_OA_phenotype_data_outlier_filtered$Diets)
Raf_OA_phenotype_data_outlier_filtered$Months <- factor(Raf_OA_phenotype_data_outlier_filtered$Months)

Raf_OA_phenotypes <- names(Raf_OA_phenotype_data_outlier_filtered)[
  which(names(Raf_OA_phenotype_data_outlier_filtered) == "TotalMass"):ncol(Raf_OA_phenotype_data_outlier_filtered)]

all_results <- data.frame()

for (phenotype in Raf_OA_phenotypes) {
  formula <- as.formula(paste(phenotype, "~ Diets * Months + (1 | Participant)"))
  lme_model <- lmer(formula, data = Raf_OA_phenotype_data_outlier_filtered, REML = FALSE)
  emms <- emmeans(lme_model, ~ Diets * Months)
  pairwise_comparisons <- contrast(emms, method = "pairwise", simple = "each")
  pairwise_comparisons_adjusted <- summary(pairwise_comparisons, adjust = "bonferroni")
  phenotype_results <- as.data.frame(pairwise_comparisons_adjusted)
  phenotype_results$Phenotype <- phenotype
  all_results <- bind_rows(all_results, phenotype_results)
  print(paste("Processed results for", phenotype))
}

write.csv(all_results, "Raf_OA_Raw_Phenotypes_Pairwise_Comparisons.csv", row.names = FALSE)

#### phenotype figures- raw ####
Raf_OA_phenotype_data_long <- Raf_OA_phenotype_data_outlier_filtered %>%
  pivot_longer(
    cols = TotalMass:TimeUpGo, 
    names_to = "Params_catlog",
    values_to = "Params_Value"
  ) %>%
  mutate(Params_type = case_when(
    Params_catlog %in% names(Raf_OA_phenotype_data_outlier_filtered)
    [which(names(Raf_OA_phenotype_data_outlier_filtered) == "TotalMass"):which(names(Raf_OA_phenotype_data_outlier_filtered) == "TrunkFat.")] ~ "Body Composition",
    Params_catlog %in% names(Raf_OA_phenotype_data_outlier_filtered)
    [which(names(Raf_OA_phenotype_data_outlier_filtered) == "GM_CSF"):which(names(Raf_OA_phenotype_data_outlier_filtered) == "IL_10")] ~ "Serum Proinflammatory Markers",
    Params_catlog %in% names(Raf_OA_phenotype_data_outlier_filtered)
    [which(names(Raf_OA_phenotype_data_outlier_filtered) == "Acetate"):which(names(Raf_OA_phenotype_data_outlier_filtered) == "Valerate")] ~ "SCFA",
    Params_catlog %in% names(Raf_OA_phenotype_data_outlier_filtered)
    [which(names(Raf_OA_phenotype_data_outlier_filtered) == "SitToStand"):which(names(Raf_OA_phenotype_data_outlier_filtered) == "TimeUpGo")] ~ "Function Test",
    Params_catlog %in% names(Raf_OA_phenotype_data_outlier_filtered)
    [which(names(Raf_OA_phenotype_data_outlier_filtered) == "LPS")] ~ "LPS",
    TRUE ~ "Other"  
  ))

unique(Raf_OA_phenotype_data_long$Params_catlog)

write.csv(Raf_OA_phenotype_data_long , 'Raf_OA_phenotype_data_long.csv')

### Box Plots for each phenotype ###
Raf_phenotype_data_cytokines_figure <- Raf_OA_phenotype_data_long  %>%
  filter(Params_type == "Serum Proinflammatory Markers") %>%
  ggplot(aes(x = Months, y = Params_Value, fill = Group)) +
 stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1, outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", "tomato", "black", "red")) +
  mytheme3 +
  facet_wrap(~Params_catlog, scales = "free", ncol = 3) +  
  ylab("Serum cytokines (pg/mL)") +
  xlab("Time (month)")
Raf_phenotype_data_cytokines_figure

Raf_phenotype_data_SCFA_figure <- Raf_OA_phenotype_data_long  %>%
  filter(Params_type == "SCFA" & Params_catlog %in% c("Acetate", "Propionate", "Butyrate")) %>%
  ggplot(aes(x = Months, y = Params_Value, fill = Group)) +
 stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1, outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", "tomato", "black", "red")) +
  mytheme3 +
  facet_wrap(~Params_catlog, scales = "free", ncol = 3) +  
  ylab("Fecal SCFA (umol/g)") +
  xlab("Time (month)")
Raf_phenotype_data_SCFA_figure

Raf_OA_LPS_conc_plot <- ggplot(Raf_OA_phenotype_data_outlier_filtered, 
                                   aes(x = Months, y = LPS, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1, outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", "tomato", "black", "red")) +
  mytheme3 +
  ylab("Concentration (umol/g)") +
  xlab("Time (month)") 

Raf_OA_LPS_conc_plot

ggsave("Raf_OA_LPS_conc_plot.svg", 
       plot = Raf_OA_LPS_conc_plot, 
       device = "svg", 
       width = 2, height = 4, 
       units = "in")

ggsave("Raf_phenotype_data_SCFA.svg", 
       plot = Raf_phenotype_data_SCFA_figure, 
       device = "svg", 
       width = 4.5, height = 3, 
       units = "in")

ggsave("Raf_phenotype_cytokines_raw.svg", 
       plot = Raf_phenotype_data_cytokines_figure, 
       device = "svg", 
       width = 5, height = 5, 
       units = "in")
```

```{r Figures S2C & 2D. Correlations between MetaPhlAn4 species and Phenotypes}
### Spearman's correlation between MetaPhlAn4 species and phenotype #### 
threshold <- 2
Raf_OA_phenotype_data_outlier_filtered <- read.csv("Raf_OA_phenotypes.csv") %>%
  group_by(Group) %>%
  mutate(across(where(is.numeric), ~ ifelse(abs(. - mean(., na.rm = TRUE)) <= threshold * sd(., na.rm = TRUE), ., NA))) %>%
  ungroup()

# Filter data for baseline (Month 0) and select relevant columns
Raf_OA_phenotype_data_outlier_filtered_baseline <- Raf_OA_phenotype_data_outlier_filtered %>%
  select(Sex:TrunkFat., SitToStand:TimeUpGo, Group)

Raf_OA_phenotype_data_outlier_filtered_baseline

# Loop through the selected columns and summarize
summary_results <- lapply(Raf_OA_phenotype_data_outlier_filtered_baseline, function(col) {
  if(is.numeric(col)) {
    return(c(
      mean = mean(col, na.rm = TRUE),
      sd = sd(col, na.rm = TRUE),
      min = min(col, na.rm = TRUE),
      max = max(col, na.rm = TRUE)
    ))
  } else {
    return(NA)
  }
})

# Convert the list into a data frame for easier viewing
summary_table <- as.data.frame(t(summary_results))
print(summary_table)

#### 
Raf_OA_MetaPhlan_species_data <- Raf_OA_MetaPhlan_species_transposed %>%
   rownames_to_column(var = "SampleID")

Raf_OA_Microbiome_phenotype_merged_data <- merge(
  Raf_OA_MetaPhlan_species_data, 
  Raf_OA_phenotype_data_outlier_filtered, 
  by = "SampleID")

Phenotypic_cols <- list(
  body_composition_cols = names(Raf_OA_Microbiome_phenotype_merged_data)[which(names(Raf_OA_Microbiome_phenotype_merged_data) == "TotalMass"):which(names(Raf_OA_Microbiome_phenotype_merged_data) == "TrunkFat.")],
  function_test_cols = names(Raf_OA_Microbiome_phenotype_merged_data)[which(names(Raf_OA_Microbiome_phenotype_merged_data) == "HandGrip")])

MetaPhlAn4_species_cols <- Raf_OA_Microbiome_phenotype_merged_data[, 2:1279]
MetaPhlAn4_species_results_combined <- data.frame()

# Loop over each MetaPhlAn4_species and calculate correlations with all other variables
for (MetaPhlAn_species in colnames(MetaPhlAn4_species_cols)) {
  for (group_name in names(Phenotypic_cols)) {
    for (var_name in Phenotypic_cols[[group_name]]) {
      test <- cor.test(Raf_OA_Microbiome_phenotype_merged_data[[MetaPhlAn_species]], 
                       Raf_OA_Microbiome_phenotype_merged_data[[var_name]], use = "complete.obs")
      temp_result <- data.frame(
        MetaPhlAn4_species = MetaPhlAn_species,
        Parameter = var_name,
        correlation = test$estimate,
        p_value = test$p.value,
        Group = group_name
      )
      MetaPhlAn4_species_results_combined <- bind_rows(MetaPhlAn4_species_results_combined, temp_result)
    }
  }
}

write_csv(MetaPhlAn4_species_results_combined, "MetaPhlAn4_species_phenotypes_results_combined.csv")

# Load and filter correlation data (p < 0.05)
data_filtered <- MetaPhlAn4_species_results_combined %>%
  filter(Parameter %in% c("TotalLean", "TrunkFatKg", "TrunkFat.", "HandGrip"), 
         p_value < 0.05) %>%
  mutate(correlation_group = ifelse(correlation > 0, "Positive", "Negative"))

MetaPhlAn4_species_Diet_Massline <- read.csv("MetaPhlAn4_species_Maaslin2_diet_coefficient.csv") %>%
  select(MetaPhlAn4_species, coef, qval)

merged_data <- merged_data %>%
  mutate(SignLabel = case_when(
    !is.na(qval) & qval < 0.05 & coef > 0 ~ "+",
    !is.na(qval) & qval < 0.05 & coef < 0 ~ "-",
    TRUE ~ ""
  )) # merge significant labels from Maaslin2 for MetaPhlAn4 species Prebiotic vs. Placebo

# Function to create combined bar plot for each phenotype with annotation
create_combined_bar_plot <- function(df, parameter_name) {
  df_subset <- df %>% filter(Parameter == parameter_name)
  top_pos <- df_subset %>%
    arrange(desc(correlation)) %>%
    head(15) # Select top 15 most positively correlated species
  top_neg <- df_subset %>%
    arrange(correlation) %>%
    head(15) # Select top 15 most negatively correlated species
  combined_data <- bind_rows(top_pos, top_neg) # Combine positive and negative species

  # Create the bar plot
  combined_plot <- ggplot(combined_data, aes(x = reorder(MetaPhlAn4_species, correlation), y = correlation, fill = correlation > 0)) +
    geom_bar(stat = "identity") +
    coord_flip() +  # Flip axes for horizontal bars
    scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "darkblue"), labels = c("Positive", "Negative")) +  
    labs(title = paste(parameter_name, "- Top 15 Positive and Negative Correlations"),
         x = "MetaPhlAn4 Species",
         y = "Correlation",
         fill = "Correlation Type") +
    mytheme2 +
    theme(plot.title = element_text(hjust = 0.5, face = "bold")) +

    # Add annotations for significance
    geom_text(aes(label = SignLabel), 
              color = "black", 
              size = 5, 
              hjust = -0.2)  # Move text slightly off the bar for visibility

  return(combined_plot)
}

# Generate plots for each phenotype
plot_TotalLean <- create_combined_bar_plot(merged_data, "TotalLean")
plot_TrunkFatKg <- create_combined_bar_plot(merged_data, "TrunkFatKg")
plot_TrunkFat <- create_combined_bar_plot(merged_data, "TrunkFat.")
plot_HandGrip <- create_combined_bar_plot(merged_data, "HandGrip")

plot_TrunkFatKg

ggsave("Raf_OA_TotalLean_Top15_correlated_species.svg", 
       plot = plot_TotalLean, 
       device = "svg", 
       width = 8, height = 6, 
       units = "in")
ggsave("Raf_OA_TrunkFatKg_Top15_correlated_species.svg", 
       plot = plot_TrunkFatKg, 
       device = "svg", 
       width = 8, height = 6, 
       units = "in")
ggsave("Raf_OA_TrunkFat_Top15_correlated_species.svg", 
       plot = plot_TrunkFat, 
       device = "svg", 
       width = 8, height = 6, 
       units = "in")
ggsave("Raf_OA_HandGrip_Top15_correlated_species.svg", 
       plot = plot_HandGrip, 
       device = "svg", 
       width = 8, height = 6, 
       units = "in")

write.csv(merged_data, "Raf_OA_Raw_Phenotypes_Maaslin2_merged_data.csv", row.names = FALSE) # save a merged data for double-check

## Spearman's correlations between serum cytokines vs phenotype & fecal SCFA
colnames(Raf_OA_phenotype_data_outlier_filtered)

Raf_cytokine_phenotype_order <-c("Participant", "Months", "Acetate", "Propionate","Butyrate", 
                            "TotalMass", "TotalFat", "TotalLean", "TrunkFatKg","Fat.", "BMC", "BMD",
                            "TrunkFat.","HandGrip", "FastWalk", "TimeUpGo", "SitToStand", "SixMinWalk", 
                            "LPS", "GM_CSF", "IL_1b", "IL_1RA", "IL_4", "IL_5", "IL_12p4", "IL_13", "TNFa","IL_10")

Raf_cytokine_phenotype_merged_data_long_normalized <- read.csv("Raf_OA_CGC_phenotype_merged_data_normalized_wide.csv") %>%
  select(all_of(Raf_cytokine_phenotype_order))


cytokine_cols <- names(Raf_cytokine_phenotype_merged_data_long_normalized)[which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "GM_CSF"):which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "IL_10")]

analysis_groups <- list(
  body_composition_cols = names(Raf_cytokine_phenotype_merged_data_long_normalized)[which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "TotalMass"):which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "TrunkFat.")],
  function_test_cols = names(Raf_cytokine_phenotype_merged_data_long_normalized)[which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "HandGrip"):which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "SixMinWalk")],
  scfa_cols = names(Raf_cytokine_phenotype_merged_data_long_normalized)[which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "Acetate"):which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "Butyrate")],
  LPS_cols =  names(Raf_cytokine_phenotype_merged_data_long_normalized)[which(names(Raf_cytokine_phenotype_merged_data_long_normalized) == "LPS")]
)

# Initialize an empty data frame to store results for cytokines VS. SCFA & phenotype
cytokines_phenotype_results_combined_nomrlized <- data.frame()

for (cytokine in cytokine_cols) {
  for (group_name in names(analysis_groups)) {
    for (var_name in analysis_groups[[group_name]]) {
      test <- cor.test(Raf_cytokine_phenotype_merged_data_long_normalized[[cytokine]], 
                       Raf_cytokine_phenotype_merged_data_long_normalized[[var_name]], use = "complete.obs")
      temp_result <- data.frame(
        Serum_Marker = cytokine,
        Parameter = var_name,
        correlation = test$estimate,
        p_value = test$p.value,
        Group = group_name
      )
      
      cytokines_phenotype_results_combined_nomrlized <- bind_rows(cytokines_phenotype_results_combined_nomrlized, temp_result)
    }
  }
}

write_csv(cytokines_phenotype_results_combined_nomrlized, "Raf_OA_Serum_cytokine_phenotypes_results_combined_nomrlized.csv")

### Makes heatmap for the correlations #####
# Define the specific order for "body_composition_cols"
Parameters_order <- c("TotalMass", "TotalFat", "TotalLean", "TrunkFatKg",
                      "Fat.", "TrunkFat.", "BMC", "BMD", "LPS", 
                      "HandGrip", "FastWalk", "TimeUpGo", "SitToStand", "SixMinWalk")

# Filter and apply the custom parameter order
serum_results_combined <- cytokines_phenotype_results_combined %>%
  filter(Group != "scfa_cols") %>% # Remove rows where Group is "scfa_cols"
  mutate(
    Significance = ifelse(BH_adjusted_p_value < 0.05, "*", ""), # Add significance markers
    Parameter = factor(Parameter, levels = Parameters_order) # Set custom order
  ) %>%
  arrange(Parameter, Group)

# Reshape data to wide format for ComplexHeatmap
heatmap_data <- serum_results_combined %>%
  select(Serum_Marker, Parameter, correlation, Group) %>%
  pivot_wider(names_from = Serum_Marker, values_from = correlation)

parameter_groups <- heatmap_data$Group
heatmap_matrix <- heatmap_data %>%
  select(-Group) %>%
  column_to_rownames("Parameter") %>%
  as.matrix()

significance_data <- serum_results_combined %>%
  select(Serum_Marker, Parameter, Significance) %>%
  pivot_wider(names_from = Serum_Marker, values_from = Significance)

significance_matrix <- significance_data %>%
  column_to_rownames("Parameter") %>%
  as.matrix()

# Define colors for the Group annotations
group_colors <- c("body_composition_cols" = "orange", 
                  "LPS_cols" = "purple", 
                  "function_test_cols" = "darkgreen")

# Extract Group information for each Parameter in the correct order
row_annotation <- rowAnnotation(
  Group = parameter_groups,
  col = list(Group = group_colors),
  annotation_legend_param = list(title = "Group")
)

range_coef <- range(heatmap_matrix, na.rm = TRUE)

# Create breaks for smooth color transitions around zero
breaks <- c(min(range_coef), 0, max(range_coef))
color_palette <- colorRamp2(breaks, colors = c("blue", "white", "red"))

# Generate the heatmap with ComplexHeatmap, adjusting appearance settings
Raf_phenotype_cytokine_correlations <- Heatmap(
  heatmap_matrix,
  name = "Correlation",
  col = color_palette,
  border = TRUE,  # Adds border around each cell
  row_names_side = "left",
  column_names_side = "top",
  cluster_rows = FALSE,
  cluster_columns = TRUE,
  cell_fun = function(j, i, x, y, width, height, fill) {
     grid.rect(x, y, width, height, gp = gpar(col = "black", lwd = 0.5, fill = NA))
    # Display only significance markers
    if (!is.na(significance_matrix[i, j]) && significance_matrix[i, j] == "*") {
      grid.text("*", x, y, gp = gpar(col = "black", fontsize = 24))
    }
  },
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 14),       # Font size for row names
  column_names_gp = gpar(fontsize = 14),    # Font size for column names
  width = unit(9 * ncol(heatmap_matrix), "mm"),  # Total width for columns
  height = unit(9 * nrow(heatmap_matrix), "mm"), # Total height for rows
  left_annotation = row_annotation,
  column_title = "Correlations between Serum cytokines and Phenotypes",
  column_title_gp = gpar(fontsize = 14, fontface = "bold"),
  row_title_gp = gpar(fontsize = 14, fontface = "bold")
)

Raf_phenotype_cytokine_correlations
svg("Raf_phenotype_cytokine_correlations.svg", width = 8, height = 8)
draw(Raf_phenotype_cytokine_correlations)
dev.off()

```

```{r Figures 3D-F. Bacterial-Cytokine Co-abundance network}
str(Raf_OA_phenotype_data_outlier_filtered)
Raf_OA_cytokine_data <- Raf_OA_phenotype_data_outlier_filtered %>%
  select(SampleID, Diets, IL_1b:TNFa)
  
Raf_OA_MetaPhlan_species_data <- Raf_OA_MetaPhlan_species_transposed %>%
   rownames_to_column(var = "SampleID")

Raf_OA_Microbiome_cytokine_merged_data <- merge(
  Raf_OA_MetaPhlan_species_data, 
  Raf_OA_cytokine_data, 
  by = "SampleID")

Raf_OA_Microbiome_cytokine_prebiotic <- Raf_OA_Microbiome_cytokine_merged_data %>%
  filter(Diets %in% "Prebiotic")
Raf_OA_Microbiome_cytokine_placebo <- Raf_OA_Microbiome_cytokine_merged_data %>%
  filter(Diets %in% "Placebo")

Raf_OA_Microbiome_cytokine_prebiotic_numeric <- Raf_OA_Microbiome_cytokine_prebiotic %>%
  select(-SampleID, -Diets) %>%
  select_if(is.numeric) 

Raf_OA_Microbiome_cytokine_placebo_numeric <- Raf_OA_Microbiome_cytokine_placebo %>%
  select(-SampleID, -Diets) %>%
  select_if(is.numeric) 

# Perform Spearman correlation analysis
Raf_OA_Microbiome_cytokine_prebiotic_cor_matrix <- rcorr(as.matrix(Raf_OA_Microbiome_cytokine_prebiotic_numeric), type = "spearman")
Raf_OA_Microbiome_cytokine_placebo_cor_matrix <- rcorr(as.matrix(Raf_OA_Microbiome_cytokine_placebo_numeric), type = "spearman")

Raf_OA_Microbiome_cytokine_prebiotic_cor_coeff <- Raf_OA_Microbiome_cytokine_prebiotic_cor_matrix$r
Raf_OA_Microbiome_cytokine_placebo_cor_coeff <- Raf_OA_Microbiome_cytokine_placebo_cor_matrix$r

Raf_OA_Microbiome_cytokine_prebiotic_p_values <- Raf_OA_Microbiome_cytokine_prebiotic_cor_matrix$P
Raf_OA_Microbiome_cytokine_placebo_p_values <- Raf_OA_Microbiome_cytokine_placebo_cor_matrix$P


# Filter significant correlations (e.g., p-adjust < 0.05 and |correlation| > 0.5)
Raf_OA_Microbiome_cytokine_prebiotic_cor_sig <- ifelse(Raf_OA_Microbiome_cytokine_prebiotic_p_values < 0.05 & 
                                               abs(Raf_OA_Microbiome_cytokine_prebiotic_cor_coeff) > 0.45, 
                                               Raf_OA_Microbiome_cytokine_prebiotic_cor_coeff, 0)

Raf_OA_Microbiome_cytokine_placebo_cor_sig <- ifelse(Raf_OA_Microbiome_cytokine_placebo_p_values < 0.05 & 
                                               abs(Raf_OA_Microbiome_cytokine_placebo_cor_coeff) > 0.45, 
                                               Raf_OA_Microbiome_cytokine_placebo_cor_coeff, 0)

range(Raf_OA_Microbiome_cytokine_prebiotic_cor_sig, na.rm = TRUE)
range(Raf_OA_Microbiome_cytokine_placebo_cor_sig, na.rm = TRUE) #  Check the range of filtered correlations

sum(Raf_OA_Microbiome_cytokine_prebiotic_cor_sig != 0, na.rm = TRUE) # Count non-zero correlations
sum(Raf_OA_Microbiome_cytokine_placebo_cor_sig != 0, na.rm = TRUE)

# Melt the correlation matrix into a long format
Raf_OA_Microbiome_cytokine_prebiotic_cor_df <- melt(Raf_OA_Microbiome_cytokine_prebiotic_cor_sig, na.rm = TRUE) %>%
  filter(value != 0) 
Raf_OA_Microbiome_cytokine_placebo_cor_df <- melt(Raf_OA_Microbiome_cytokine_placebo_cor_sig, na.rm = TRUE) %>%
  filter(value != 0) 

colnames(Raf_OA_Microbiome_cytokine_prebiotic_cor_df) <- c("Variable1", "Variable2", "Correlation")
colnames(Raf_OA_Microbiome_cytokine_placebo_cor_df) <- c("Variable1", "Variable2", "Correlation")

###### Filter for Microbiome-Cytokine Edges Only 
# Define a helper function to classify variables as "cytokine" or "microbiome"
classify_type <- function(var_name) {
  if (grepl("^IL|TNFa", var_name)) {
    return("cytokine")
  } else {
    return("microbiome")
  }
}

Raf_OA_Microbiome_cytokine_prebiotic_cor_df <- Raf_OA_Microbiome_cytokine_prebiotic_cor_df %>%
  mutate(
    Type1 = sapply(Variable1, classify_type),
    Type2 = sapply(Variable2, classify_type)
  ) # Add types for Variable1 and Variable2

Raf_OA_Microbiome_cytokine_placebo_cor_df <- Raf_OA_Microbiome_cytokine_placebo_cor_df %>%
  mutate(
    Type1 = sapply(Variable1, classify_type),
    Type2 = sapply(Variable2, classify_type)
  )

Raf_OA_Microbiome_cytokine_prebiotic_cor_df <- Raf_OA_Microbiome_cytokine_prebiotic_cor_df %>%
  filter(
    (Type1 == "cytokine" & Type2 == "microbiome") |
    (Type1 == "microbiome" & Type2 == "cytokine") 
  ) # Keep only microbiome-cytokine edges

Raf_OA_Microbiome_cytokine_placebo_cor_df <- Raf_OA_Microbiome_cytokine_placebo_cor_df %>%
  filter(
    (Type1 == "cytokine" & Type2 == "microbiome") |
    (Type1 == "microbiome" & Type2 == "cytokine") 
  )

# Rebuild the network with p values as edge attributes
Raf_OA_Microbiome_cytokine_prebiotic_network <- graph_from_data_frame(
  Raf_OA_Microbiome_cytokine_prebiotic_cor_df, 
  directed = FALSE)

Raf_OA_Microbiome_cytokine_placebo_network <- graph_from_data_frame(
  Raf_OA_Microbiome_cytokine_placebo_cor_df, 
  directed = FALSE)

print(V(Raf_OA_Microbiome_cytokine_prebiotic_network))  # List node attributes
print(V(Raf_OA_Microbiome_cytokine_placebo_network))

print(V(Raf_OA_Microbiome_cytokine_prebiotic_network))
print(V(Raf_OA_Microbiome_cytokine_placebo_network))# List edge attributes

summary(Raf_OA_Microbiome_cytokine_prebiotic_network)
summary(Raf_OA_Microbiome_cytokine_placebo_network)

degree_distribution_prebiotic <- degree(Raf_OA_Microbiome_cytokine_prebiotic_network) # Inspect the degree (number of connections) for nodes
degree_distribution_placebo <- degree(Raf_OA_Microbiome_cytokine_placebo_network)

summary(degree_distribution_prebiotic)
summary(degree_distribution_placebo)

range(E(Raf_OA_Microbiome_cytokine_prebiotic_network)$Correlation)   # Check the range of correlation values
range(E(Raf_OA_Microbiome_cytokine_placebo_network)$Correlation)

# Betweenness centrality measures the importance of a node based on the number of shortest paths in the network that pass through it. 
# A node with high betweenness acts as a "bridge" connecting different parts of the network
node_betweenness_prebiotic <- betweenness(Raf_OA_Microbiome_cytokine_prebiotic_network)
node_betweenness_placebo <- betweenness(Raf_OA_Microbiome_cytokine_placebo_network)

sorted_betweenness_prebiotic <- sort(node_betweenness_prebiotic, decreasing = TRUE)
sorted_betweenness_placebo <- sort(node_betweenness_placebo, decreasing = TRUE)

print(head(sorted_betweenness_prebiotic, 50))
print(head(sorted_betweenness_placebo, 50))

write.csv(sorted_betweenness_prebiotic, "Betweenness Centrality of Raf_OA_Microbiome_cytokine_nodes_prebiotic_cor0.45.csv")
write.csv(sorted_betweenness_placebo, "Betweenness Centrality of Raf_OA_Microbiome_cytokine_nodes_placebo_cor0.45.csv")

### export Network as GraphML for visualization in Gephi### 
# Add a type attribute to classify nodes
V(Raf_OA_Microbiome_cytokine_prebiotic_network)$type <- ifelse(grepl("^IL|TNFa", 
                                                                     V(Raf_OA_Microbiome_cytokine_prebiotic_network)$name), 
                                                               "cytokine", "microbiome")
V(Raf_OA_Microbiome_cytokine_placebo_network)$type <- ifelse(grepl("^IL|TNFa", 
                                                                   V(Raf_OA_Microbiome_cytokine_placebo_network)$name), 
                                                             "cytokine", "microbiome")

## Add phylum & Genus info for species
node_list_prebiotic <- data.frame(name = V(Raf_OA_Microbiome_cytokine_prebiotic_network)$name)
node_list_placebo <- data.frame(name = V(Raf_OA_Microbiome_cytokine_placebo_network)$name)

write.csv(node_list_prebiotic, "Raf_Cytokine_microbes_node_annotation_prebiotic.csv", row.names = FALSE)
write.csv(node_list_placebo, "Raf_Cytokine_microbes_node_annotation_placebo.csv", row.names = FALSE)

# Read and merge Taxa info from MetaPhlAn4 file
MetaPhlAn4_species_fullinfo <- read.csv('Raf_OA_MetaPhlAn_full_taxa_file.csv', stringsAsFactors = FALSE) %>%
  distinct(Species, .keep_all = TRUE)

write.csv(MetaPhlAn4_species_fullinfo, 'Raf_OA_MetaPhlAn_full_taxa_dereplicated.csv')

# add Phylum and Genus info manually 
Raf_OA_Microbiome_cytokine_prebiotic_network_annotation <- read.csv("Raf_Cytokine_microbes_node_annotation_prebiotic_edited.csv")
Raf_OA_Microbiome_cytokine_placebo_network_annotation <- read.csv("Raf_Cytokine_microbes_node_annotation_placebo_edited.csv")

V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Type <- Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$type[
  match(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$name, 
        Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$name)]

V(Raf_OA_Microbiome_cytokine_placebo_network)$Type <- Raf_OA_Microbiome_cytokine_placebo_network_annotation$type[
  match(V(Raf_OA_Microbiome_cytokine_placebo_network)$name, 
        Raf_OA_Microbiome_cytokine_placebo_network_annotation$name)]

V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Phylum <- Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$annotation_Phylum[
  match(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$name, 
        Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$name)]

V(Raf_OA_Microbiome_cytokine_placebo_network)$Phylum <- Raf_OA_Microbiome_cytokine_placebo_network_annotation$annotation_Phylum[
  match(V(Raf_OA_Microbiome_cytokine_placebo_network)$name, 
        Raf_OA_Microbiome_cytokine_placebo_network_annotation$name)]

V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Genus <- Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$annotation_Genus[
  match(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$name, 
        Raf_OA_Microbiome_cytokine_prebiotic_network_annotation$name)]

V(Raf_OA_Microbiome_cytokine_placebo_network)$Genus <- Raf_OA_Microbiome_cytokine_placebo_network_annotation$annotation_Genus[
  match(V(Raf_OA_Microbiome_cytokine_placebo_network)$name, 
        Raf_OA_Microbiome_cytokine_placebo_network_annotation$name)]

print(table(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Type, useNA = "ifany"))
print(table(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Phylum, useNA = "ifany"))
print(table(V(Raf_OA_Microbiome_cytokine_prebiotic_network)$Genus, useNA = "ifany"))

print(table(V(Raf_OA_Microbiome_cytokine_placebo_network)$Type, useNA = "ifany"))
print(table(V(Raf_OA_Microbiome_cytokine_placebo_network)$Phylum, useNA = "ifany"))
print(table(V(Raf_OA_Microbiome_cytokine_placebo_network)$Genus, useNA = "ifany"))

# Add a new edge attribute 'corr_direction' based on the sign of the correlation
E(Raf_OA_Microbiome_cytokine_prebiotic_network)$corr_direction <- ifelse(
  E(Raf_OA_Microbiome_cytokine_prebiotic_network)$Correlation < 0, -1, 1
)

E(Raf_OA_Microbiome_cytokine_placebo_network)$corr_direction <- ifelse(
  E(Raf_OA_Microbiome_cytokine_placebo_network)$Correlation < 0, -1, 1
)


# Export the igraph network to GraphML
write_graph(Raf_OA_Microbiome_cytokine_prebiotic_network, 
            file = "Raf_OA_Microbiome_cytokine_network_prebiotic_corr0.45.graphml", 
            format = "graphml")

write_graph(Raf_OA_Microbiome_cytokine_placebo_network, 
            file = "Raf_OA_Microbiome_cytokine_network_placebo_corr0.45.graphml", 
            format = "graphml")

# Save node attributes to CSV
node_data <- as_data_frame(Raf_OA_Microbiome_cytokine_network, what = "vertices")
write.csv(node_data, "Raf_OA_Microbiome_cytokine_nodes.csv", row.names = FALSE)

# Save edge attributes to CSV
edge_data <- as_data_frame(Raf_OA_Microbiome_cytokine_network, what = "edges")
write.csv(edge_data, "Raf_OA_Microbiome_cytokine_edges.csv", row.names = FALSE)

#### Figure for top nodes by Betweenness Centrality ### 
# Betweenness Centrality of cytokine in Prebiotic vs. Placebo
Raf_OA_Microbiome_cytokine_nodes_centrality_cytokine <- read.csv("Betweenness Centrality of Raf_OA_Microbiome_cytokine_nodes.csv") 

# Order Cytokine based on the Ratio in the placebo group
Cytokine_order <- c("IL_4","TNFa","IL_1b","IL_13","IL_12p4","IL_5", "IL_1RA")

Raf_OA_Microbiome_cytokine_nodes_centrality_cytokine <- Raf_OA_Microbiome_cytokine_nodes_centrality_cytokine %>%
  mutate(Cytokine = factor(Cytokine, levels = Cytokine_order))
Raf_OA_Microbiome_cytokine_network_centrality_cytokine <- ggplot(Raf_OA_Microbiome_cytokine_nodes_centrality_cytokine) +
  geom_col(aes(x = Cytokine, y = Centrality, fill = Diet), 
           color = "black", position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("black", "red")) +
  labs(x = "Cytokine", y = "Betweenness Centrality") +
  coord_flip() +  
  mytheme4
Raf_OA_Microbiome_cytokine_network_centrality_cytokine
ggsave("Raf_OA_Microbiome_cytokine_network_centrality_cytokine.svg", 
       plot = Raf_OA_Microbiome_cytokine_network_centrality_cytokine, 
       device = "svg", 
       width = 5, height = 3, 
       units = "in")

# Betweenness Centrality of bacteia in Prebiotic
Raf_OA_Microbiome_cytokine_nodes_centrality_bacteria <- read.csv("Betweenness Centrality of Raf_OA_Microbiome_cytokine_nodes_prebiotic.csv")

Raf_OA_Microbiome_cytokine_nodes_centrality_bacteria <- Raf_OA_Microbiome_cytokine_nodes_centrality_bacteria %>%
  arrange(desc(Betweenness_Centrality)) %>%  # Order in descending order for highest values
  slice_head(n = 15) %>%  # Select the top 15 rows
  mutate(Node = factor(Node, levels = rev(Node)))  # Reverse the order for coord_flip()

Raf_OA_Microbiome_cytokine_network_centrality_bacteria <- ggplot(Raf_OA_Microbiome_cytokine_nodes_centrality_bacteria) +
  geom_point(aes(x = Node, y = Betweenness_Centrality, fill = Betweenness_Centrality, size = Betweenness_Centrality), 
             shape = 21, color = "black") +  # Use fill and size aesthetic
  scale_fill_gradient(high = "#01665e", low = "white") +  # Color based on Betweenness_Centrality
  scale_size_continuous(range = c(3, 7)) +  # Adjust point size range
  labs(x = "MetaPhlAn4 Species", y = "Cytokine-Microbes network Betweenness Centrality") +
  coord_flip() +  
  mytheme4
Raf_OA_Microbiome_cytokine_network_centrality_bacteria
ggsave("Raf_OA_Microbiome_cytokine_network_centrality_bacteria-corr0.45.svg", 
       plot = Raf_OA_Microbiome_cytokine_network_centrality_bacteria, 
       device = "svg", 
       width = 7, height = 3.5, 
       units = "in")
```
# Remove zero-variance columns
zero_var_columns <- apply(Raf_OA_Microbiome_cytokine_prebiotic_numeric, 2, var) == 0
Raf_OA_Microbiome_cytokine_prebiotic_numeric <- Raf_OA_Microbiome_cytokine_prebiotic_numeric[, !zero_var_columns]



```{r Figure 3A. Top HUMAnN3 pathways associated with prebiotic responsive phenotypes, identified using MaAsLin2}
Raf_OA_HuMaNn3_Pathway_CPM_normalized <- read.csv("Raf_OA_Metagenomic_pathways_heatmap2.csv", header = TRUE, check.names = FALSE)
annotation_row <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 1:2, drop = FALSE] # Separate the first column for annotations (MetaCyc Ontology)
Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 4:7] # Extract data for heatmap 
Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 8:11]

# Set rownames for coefficient and q-value matrices using the second column (pathway names)
rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef) <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 3]
rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue) <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 3]
rownames(annotation_row) <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 3]

identical(rownames(annotation_row), rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef)) # Verify rownames match

# Convert coefficients and q-values to numeric matrices
Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef <- as.data.frame(lapply(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef, as.numeric))
Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef <- as.matrix(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef)

Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue <- as.data.frame(lapply(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue, as.numeric))
Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue <- as.matrix(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue)

str(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef) # Check the structure to ensure it's now numeric
str(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue)

any(is.na(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef)) # Check for NA values
Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef[is.na(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef)] <- 0 # Replace NA values with 0
any(is.infinite(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef)) # Check for Inf values

# Create the sign matrix for significant associations, ensuring NA values are handled
sign_matrix <- ifelse(is.na(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue) | is.infinite(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue),  
                      "",  # Replace NA or Inf with an empty string
                      ifelse(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue <= 0.05, 
                             ifelse(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef >= 0, "+", "-"), 
                             ""))  # Empty string for non-significant associations
# Trim whitespace from the 'Pathways Class' column
annotation_row$`Pathways Class` <- trimws(annotation_row$`Pathways Class`)
unique(annotation_row$`Pathways Class`)

# Define the annotation colors for each row separately
annotation_colors <- list(
  `MetaCyc Ontology` = c("Degradation/Utilization/Assimilation" = "purple",
                         "Generation of Precursor Metabolites and Energy" = "darkgreen",
                         "Biosynthesis" = "yellow"),
  
  `Pathways Class`= c( "Amide, Amidine, Amine, and Polyamine Degradation" = "darkred",  
                       "Amino Acid Degradation" = "dimgrey",  
                       "Aromatic Compound Degradation" = "#0000FF",  
                       "C1 Compound Utilization and Assimilation" = "lightgreen",  
                       "Carbohydrate Degradation" = "#FFA500",
                       "Carboxylic Acid Degradation" =   "#800080",
                       "Fatty Acid and Lipid Degradation" = "#FF00FF",   
                       "Inorganic Nutrient Metabolism" =  "#00FFFF", 
                       "Nucleoside and nucleotide degradation" = "#A52A2A",  
                       "Amino Acid Biosynthesis" = "#008080",  
                       "Carbohydrate Biosynthesis" = "red",  
                       "Carboxylic Acid Biosynthesis" = "green",  
                       "Cofactor, Carrier, and Vitamin Biosynthesis" = "#FFC0CB", 
                       "Fatty Acid and Lipid Biosynthesis" = "darkblue",  
                       "Nucleoside and nucleotide biosynthesis" = "#8B4513",  
                       "Secondary Metabolites Biosynthesis" = "#4682B4",  
                       "Fermentation" = "#DC143C",  
                       "Generation of Precursor Metabolites and Energy" = "#228B22",  
                       "Glycolysis" = "#D2691E"))

# Assign row names to Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef from the second column (pathway names)
rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef) <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 3]
rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue) <- Raf_OA_HuMaNn3_Pathway_CPM_normalized[, 3]

# Ensure that the number of rows in all components match
identical(rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef), rownames(annotation_row))
identical(rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef), rownames(Raf_OA_HuMaNn3_Pathway_CPM_normalized_qvalue))

range_coef <- range(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef, na.rm = TRUE)
breaks <- c(seq(min(range_coef),-0.001, length.out = 51), seq(0, max(range_coef), length.out = 50))

# Generate a color palette where 0 corresponds to white
color_palette <- colorRampPalette(c("blue", "white", "red"))(length(breaks) - 1)

# Generate the heatmap with the custom color palette
pheatmap::pheatmap(Raf_OA_HuMaNn3_Pathway_CPM_normalized_coef, 
                   cluster_cols = FALSE, 
                   cluster_rows = FALSE,
                   color = color_palette,
                   breaks = breaks,
                   display_numbers = sign_matrix,  
                   number_color = "black",          
                   show_rownames = TRUE, 
                   show_colnames = TRUE, 
                   annotation_row = annotation_row,  
                   annotation_colors = annotation_colors,
                   border_color = "black",
                   cellwidth = 9,  # Set width of each cell
                   cellheight = 9,
                   main = "Heatmap with 0 as White")
```
```{r Figure 3B.Self-reported Data stats & Figure}
Raf_OA_self_reported_data <- read.csv("Raf_OA_self_reported_data.csv")

# Reshape the dataset to long format, excluding ParticipantID and Group
Raf_OA_self_reported_data_long <- Raf_OA_self_reported_data %>%
  pivot_longer(cols = -c(ParticipantID, Diets),
               names_to = "Variable",
               values_to = "Value") %>%
  mutate(Months = case_when(
    grepl(".1", Variable) ~ "M0",
    grepl(".2", Variable) ~ "M3",
    grepl(".3", Variable) ~ "M6"
  )) %>%
  mutate(Diets = recode(Diets, `1` = "Prebiotic", `2` = "Placebo")) %>%
  # Clean up the 'Variable' column to remove .1, .2, .3 suffixes
  mutate(Variable = gsub("\\.\\d+", "", Variable)) %>%
  mutate(Sample_Name = paste(ParticipantID, ifelse(Months == "M0", "A", 
                                                   ifelse(Months == "M3", "B", "C")), sep = "")) %>%
  mutate(Group = paste(Diets, Months, sep = "_")) %>%  
  mutate(Category = case_when(
    grepl("^GI_", Variable) ~ "GI_feelings_function",  # GI variables
    Variable %in% c("Total_energy", "Protein", 
                    "Carbohydrate", "Dietary_Fiber", 
                    "Total_Sugars", "Total_Fat") ~ "Energy_nutritent_intake",  # Energy and nutrient intake variables
    TRUE ~ "Quality_of_life"   # All other variables
  )) %>% 
  select(ParticipantID, Months,Sample_Name, Diets, 
         Group, Variable, Category, Value) 
  
unique(Raf_OA_self_reported_data_long$Variable)
unique(Raf_OA_self_reported_data_long$Group)

# Stats on each Variable by fitting linear mixed model 
variables_to_analyze <- unique(Raf_OA_self_reported_data_long$Variable)
all_results <- data.frame()  # Create an empty dataframe to store all results

# Loop over each variable and run the statistical analysis
for (var in variables_to_analyze) {
  data_var <- Raf_OA_self_reported_data_long %>% filter(Variable == var)
  model <- lmer(Value ~ Diets * Months + (1 | ParticipantID), data = data_var, REML = FALSE)
  emms <- emmeans(model, ~ Diets * Months)
  emms_pairwise_comparisons <- contrast(emms, interaction = "pairwise", simple = "each")
  emms_df <- as.data.frame(emms_pairwise_comparisons)
  emms_df$Variable <- var
  all_results <- rbind(all_results, emms_df)
  print(paste("Results for", var))
  print(summary(emms_pairwise_comparisons))
}

Raf_OA_self_reported_data_long$Group <- factor(Raf_OA_self_reported_data_long$Group, 
                                             levels = c('Placebo_M0','Prebiotic_M0',
                                                        'Placebo_M3','Prebiotic_M3',
                                                        'Placebo_M6','Prebiotic_M6'))

Raf_OA_Self_reported_food_intake_boxplot <- Raf_OA_self_reported_data_long %>%
  filter(Category %in% c("Energy_nutritent_intake")) %>%
  ggplot(aes(x = Months, y = Value, fill = Group)) +
  stat_boxplot(geom ='errorbar', na.rm = TRUE) + 
  geom_boxplot(alpha = 1, na.rm = TRUE) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", 
                               "tomato", "black", "red")) +
  ylab("Self-reported Energy & Nutritent Intake") +
  xlab("Time (Month)") +
  facet_wrap(~ Variable, scales = "free", nrow = 2)+
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_self_reported_data_long$Variable)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_OA_Self_reported_food_intake_boxplot

Raf_OA_Self_reported_GI_Function_boxplot <- Raf_OA_self_reported_data_long %>%
  filter(Category %in% c("GI_feelings_function")) %>%
  ggplot(aes(x = Months, y = Value, fill = Group)) +
  stat_boxplot(geom ='errorbar', na.rm = TRUE) + 
  geom_boxplot(alpha = 1, na.rm = TRUE) +
  geom_point(position = position_jitterdodge(jitter.width = 1, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", 
                               "tomato", "black", "red")) +
  ylab("Self-reported GI Function & Feeling") +
  xlab("Time (Month)") +
  facet_wrap(~ Variable, scales = "free", nrow = 2)+
  mytheme1 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_self_reported_data_long$Variable)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_OA_Self_reported_GI_Function_boxplot

Raf_OA_Self_reported_life_quality_boxplot <- Raf_OA_self_reported_data_long %>%
  filter(Category %in% c("Quality_of_life")) %>%
  ggplot(aes(x = Months, y = Value, fill = Group)) +
  stat_boxplot(geom ='errorbar', na.rm = TRUE) + 
  geom_boxplot(alpha = 1, na.rm = TRUE) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", 
                               "tomato", "black", "red")) +
  ylab("Self-reported Quality of Life") +
  xlab("Time (Month)") +
  facet_wrap(~ Variable, scales = "free", nrow = 2)+
  mytheme1 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_self_reported_data_long$Variable)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_OA_Self_reported_life_quality_boxplot

ggsave("Raf_OA_Self_reported_food_intake_boxplot.svg", 
       plot = Raf_OA_Self_reported_food_intake_boxplot, 
       device = "svg", 
       width = 5, height = 3.5, 
       units = "in")

ggsave("Raf_OA_Self_reported_GI_Function_boxplot.svg", 
       plot = Raf_OA_Self_reported_GI_Function_boxplot, 
       device = "svg", 
       width = 4, height = 3.5, 
       units = "in")

ggsave("Raf_OA_Self_reported_life_quality_boxplot.svg", 
       plot = Raf_OA_Self_reported_life_quality_boxplot, 
       device = "svg", 
       width = 7.5, height = 3.5, 
       units = "in")

```

```{r Figure 3C. Metabolome insensity stats & figures}
## Quality Control by removing metabolites with intensity lower than 3* Mid-Blank --- quality control standard from  CMRF staff
Raf_metabolites_quality_control_data <- read.csv("Raf_metabolites_quality_control2024.csv", header = TRUE, row.names = 1)
blank_samples <- Raf_metabolites_quality_control_data %>% select(starts_with("MidBlank")) # Identify Blank samples 
blank_averages <- rowMeans(blank_samples, na.rm = TRUE) 

thresholds <- blank_averages * 3
non_blank_samples <- Raf_metabolites_quality_control_data %>% select(-starts_with("MidBlank"))
comparison_matrix <- non_blank_samples > thresholds
num_false <- rowSums(comparison_matrix == FALSE)
retained_metabolites <- rownames(non_blank_samples)[num_false <= 40] # Filter the metabolites with more than 40 "FALSE" values
filtered_metabolites_data <- Raf_metabolites_quality_control_data[retained_metabolites, ]
filtered_metabolites_data <- filtered_metabolites_data %>% select(-starts_with("MidBlank"))
write.csv(filtered_metabolites_data, "Raf_metabolites_quality_control_Filtered_Original_Data.csv", row.names = TRUE)

### Edit the quality controlled file & extract the shotgun subset & remove outliers manually ### 
Raf_metabilomics_clean_data <- read.csv("Raf_metabilomics_QC_outlier_removed.csv")

Raf_metabilomics_clean_data_long <- Raf_metabilomics_clean_data %>%
  gather(key = "condition", value = "Intensity", -Metabolites) %>%
  separate(condition, into = c("Treatment", "Time", "Participant"), sep = "_") 

head(Raf_metabilomics_clean_data_long)
write.csv(Raf_metabilomics_clean_data_long, "Raf_metabilomics_clean_data_long.csv")

# Convert Treatment and Time to factor variables
Raf_metabilomics_clean_data_long$Treatment <- as.factor(Raf_metabilomics_clean_data_long$Treatment)
Raf_metabilomics_clean_data_long$Time <- as.factor(Raf_metabilomics_clean_data_long$Time)

metabolites <- unique(Raf_metabilomics_clean_data_long$Metabolites)
all_results <- data.frame(Metabolite = character(),
                          Comparison = character(),
                          Estimate = numeric(),
                          SE = numeric(),
                          df = numeric(),
                          t.ratio = numeric(),
                          P.value = numeric(),
                          stringsAsFactors = FALSE)

for (met in metabolites) {
  sub_data <- Raf_metabilomics_clean_data_long[Raf_metabilomics_clean_data_long$Metabolites == met,]
  model <- lmer(Intensity ~ Treatment * Time + (1 | Participant), data = sub_data, REML = FALSE)
  if(isSingular(model)) {
    next  # Skip to next iteration if model is singular
  }
  emm <- emmeans(model, pairwise ~ Treatment * Time)
  comparisons <- summary(emm$contrasts)
  met_results <- data.frame(Metabolite = rep(met, nrow(comparisons)),
                            Comparison = comparisons$contrast,
                            Estimate = comparisons$estimate,
                            SE = comparisons$SE,
                            df = comparisons$df,
                            t.ratio = comparisons$t.ratio,
                            P.value = comparisons$`p.value`,
                            stringsAsFactors = FALSE)
  all_results <- rbind(all_results, met_results)
}

print(all_results)
write.csv(all_results, "Raf_metabolites_quality_control_Filtered_Intensity_Data.csv", row.names = FALSE)

Raf_OA_metabolome <- read.csv("Raf_metabolites_quality_control_Filtered_Intensity_Data.csv")
Raf_metabolites_Category <- read.csv("Raf_metabolites_Category.csv")
unique(Raf_metabolites_Category$Metabolites2)

Raf_OA_phenotype_data_metadata <- Raf_OA_phenotype_data_outlier_filtered %>% 
  select(SampleID, Participant,Diets,Months, Group) 

Raf_OA_metabolome <-merge(Raf_OA_metabolome,
                          Raf_OA_phenotype_data_metadata,
                          by= "SampleID")

Raf_OA_metabolome_long <- Raf_OA_metabolome %>%
  gather(X10.HYDROXYDECANOATE:URIDINE, key = "Metabolites2", value = "Conc")

Raf_OA_metabolome_long <-merge(Raf_OA_metabolome_long,
                          Raf_metabolites_Category,
                          by= "Metabolites2")

write.csv(Raf_OA_metabolome_long, "Raf_OA_metabolome_dataset_long.csv")

results_df2 <- data.frame()
metabolites2 <- unique(Raf_OA_metabolome_long$Metabolites2)

for (metabolite in metabolites2) {
  subset_data <- Raf_OA_metabolome_long %>% filter(Metabolites2 == metabolite)
  normality_test <- shapiro.test(subset_data$Conc)
  model <- lmer(Conc ~ Diets * Months + (1 | Participant), data = subset_data, REML = FALSE)
  emmeans_results <- emmeans(model, ~ Diets * Months)
  emmeans_contrasts <- contrast(emmeans_results, "pairwise")
  emmeans_contrasts_summary <- summary(emmeans_contrasts)
  emmeans_contrasts_df <- as.data.frame(emmeans_contrasts_summary)
  emmeans_contrasts_df$Metabolite <- metabolite
  results_df2 <- bind_rows(results_df2, emmeans_contrasts_df)
}

write.csv(results_df2, "Raf_metabolites_Inensity_posthoc_pvalues2.csv", row.names = FALSE)
print(results_df2)

# Normalize metabolite intensities by Month 0 (M0) for each participant, only if M0 is valid
Raf_OA_metabolome_long_normalized <- Raf_OA_metabolome_long %>%
  group_by(Participant, Metabolites2) %>%
  mutate(
    Month0_Intensity = Conc[Months == "M0"],  
    Normalized_Conc = ifelse(!is.na(Month0_Intensity) & Month0_Intensity != 0, Conc / Month0_Intensity, NA)
  ) %>%
  ungroup() %>%
  select(-Month0_Intensity) 
head(Raf_OA_metabolome_long_normalized)

write.csv(Raf_OA_metabolome_long_normalized, "Raf_metabolites_metabolome_long_normalized.csv", row.names = FALSE)

Raf_OA_metabolome_long_normalized <- Raf_OA_metabolome_long_normalized %>%
  filter(Group %in% c('Placebo_M3', 'Prebiotic_M3',
                      'Placebo_M6', 'Prebiotic_M6'))

Raf_OA_metabolome_long_normalized_wide <- Raf_OA_metabolome_long_normalized %>%
  pivot_wider(names_from = Metabolites2, values_from = Normalized_Conc)

unique(Raf_OA_metabolome_long_normalized$Category)

Raf_OA_metabolome_long_normalized_AA <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Amino Acids and Derivatives") 
Raf_OA_metabolome_long_normalized_FAA <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Fatty Acids and Derivatives") 
Raf_OA_metabolome_long_normalized_Carbo <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Carbohydrates and Derivatives") 
Raf_OA_metabolome_long_normalized_Hormo <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Hormones and Signaling Molecules") 
Raf_OA_metabolome_long_normalized_Energ <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Metabolic Intermediates and Byproducts")
Raf_OA_metabolome_long_normalized_BA <- Raf_OA_metabolome_long_normalized %>%
  filter(Category %in% "Bile Acids and Derivatives") 


Raf_OA_metabolome_long_normalized_AA$Group <- factor(Raf_OA_metabolome_long_normalized_AA$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))
Raf_OA_metabolome_long_normalized_FAA$Group <- factor(Raf_OA_metabolome_long_normalized_FAA$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))
Raf_OA_metabolome_long_normalized_Carbo$Group <- factor(Raf_OA_metabolome_long_normalized_Carbo$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))
Raf_OA_metabolome_long_normalized_Hormo$Group <- factor(Raf_OA_metabolome_long_normalized_Hormo$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))
Raf_OA_metabolome_long_normalized_Energ$Group <- factor(Raf_OA_metabolome_long_normalized_Energ$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))
Raf_OA_metabolome_long_normalized_BA$Group <- factor(Raf_OA_metabolome_long_normalized_BA$Group,
                                       levels = c('Placebo_M3', 'Prebiotic_M3', 
                                                  'Placebo_M6', 'Prebiotic_M6'))

Raf_metabolites_AA_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_AA, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.5), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 + ylab("Relative Intensity") + xlab("Time (month)") + ylim(c(0,4)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)

Raf_metabolites_FAA_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_FAA, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 + ylab("Relative Intensity") + xlab("Time (month)") + ylim(c(0,8)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)

Raf_metabolites_Carbo_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_Carbo, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 + ylab("Relative Intensity") + xlab("Time (month)") + ylim(c(0,7)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)

Raf_metabolites_Hormo_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_Hormo, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 + ylab("Relative Intensity") + xlab("Time (month)") + ylim(c(0,12)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)

Raf_metabolites_Energ_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_Energ, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 +
  ylab("Relative Intensity") +
  xlab("Time (month)") +
  ylim(c(0,8)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)


Raf_metabolites_BA_Intensity_plot <- ggplot(Raf_OA_metabolome_long_normalized_BA, 
                                   aes(x = Metabolites2, y = Normalized_Conc, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("dimgrey", "tomato", "black", "red")) +
  mytheme1 + ylab("Relative Intensity") + xlab("Time (month)") + ylim(c(0,7)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue", size = 1)


print(Raf_metabolites_AA_Intensity_plot)
print(Raf_metabolites_FAA_Intensity_plot)
print(Raf_metabolites_Carbo_Intensity_plot)
print(Raf_metabolites_Hormo_Intensity_plot)
print(Raf_metabolites_Energ_Intensity_plot)
print(Raf_metabolites_BA_Intensity_plot)

ggsave("Raf_metabolites_AA_Intensity_plot.svg", 
       plot = Raf_metabolites_AA_Intensity_plot, 
       device = "svg", 
       width = 10, height = 3.5, 
       units = "in")

ggsave("Raf_metabolites_FAA_Intensity_plot.svg", 
       plot = Raf_metabolites_FAA_Intensity_plot, 
       device = "svg", 
       width = 8.5, height = 3.5, 
       units = "in")

ggsave("Raf_metabolites_Carbo_Intensity_plot.svg", 
       plot = Raf_metabolites_Carbo_Intensity_plot, 
       device = "svg", 
       width = 4.5, height = 3.5, 
       units = "in")

ggsave("Raf_metabolites_Hormo_Intensity_plot.svg", 
       plot = Raf_metabolites_Hormo_Intensity_plot, 
       device = "svg", 
       width = 4.5, height = 3.5, 
       units = "in")

ggsave("Raf_metabolites_Energ_Intensity_plot.svg", 
       plot = Raf_metabolites_Energ_Intensity_plot, 
       device = "svg", 
       width = 5.5, height = 3.5, 
       units = "in")

ggsave("Raf_metabolites_BA_Intensity_plot.svg", 
       plot = Raf_metabolites_BA_Intensity_plot, 
       device = "svg", 
       width = 2.5, height = 3.5, 
       units = "in")

# List of metabolites with signiciant difference to select
selected_metabolites <- c("CREATININE",
  "L.ARGININE", "L.GLUTAMINE", "L.ORNITHINE", "L.SERINE", 
  "L.LYSINE", "L.THREONINE", "L.TYROSINE", "L.VALINE", 
  "HIPPURATE", "L.LYSINE", "L.ORNITHINE", "L.THREONINE", 
  "L.TYROSINE", "L.VALINE", "SUCCINATE"
)

# Filter the dataset to include only the selected metabolites
Raf_metabolites_abs_figure_data <- Raf_metabolites_abs_conc_long %>%
  filter(Metabolites %in% selected_metabolites)

# Calculate the maximum concentration for each metabolite with a buffer
buffer_factor <- 1.2
max_conc <- Raf_metabolites_abs_figure_data %>%
  group_by(Metabolites) %>%
  summarise(max_Conc = max(Conc, na.rm = TRUE) * buffer_factor) %>%
  ungroup()
# Merge max_conc with original data to maintain the structure
Raf_metabolites_abs_figure_data <- Raf_metabolites_abs_figure_data %>%
  left_join(max_conc, by = "Metabolites")

# Create the box plot with different y-axis limits for each metabolite
Raf_metabolites_abs_plot2 <- ggplot(Raf_metabolites_abs_figure_data, 
                                   aes(x = Timepoint, y = Conc, fill = Sample_ID)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", "tomato", "black", "red")) +
  mytheme1 +
  facet_wrap(~ Metabolites, scales = "free", nrow = 2) +
  ylab("Concentration (uM)") +
  xlab("Time (month)") +
  geom_blank(aes(y = max_Conc))
print(Raf_metabolites_abs_plot2)

ggsave("Raf_metabolites_abs_plot.svg", 
       plot = Raf_metabolites_abs_plot, 
       device = "svg", 
       width = 7.5, height = 4.3, 
       units = "in")

```


```{r Figure 3D. Correlations between baseline normalized Serum Metabolome vs.Phenotypes}
Raf_OA_metabolome2 <- read.csv("Raf_metabolites_quality_control_Filtered_Intensity_Data.csv")
Raf_OA_metabolome_phenotype_merged_data <- merge(
  Raf_OA_metabolome2,
  Raf_OA_phenotype_data_outlier_filtered, 
  by = "Sample_Name") 

Raf_OA_metabolome_phenotype_merged_data_long <- Raf_OA_metabolome_phenotype_merged_data %>%
  select(c(Sample_Name, Participant, Months, CITRULLINE:D.GULONIC.ACID.GAMA.LACTONE, TotalMass:TimeUpGo)) %>%
  pivot_longer(cols = CITRULLINE:TimeUpGo, names_to = "Parameters", values_to = "ABS_value")

Raf_OA_metabolome_phenotype_merged_data_long_normalized <- Raf_OA_metabolome_phenotype_merged_data_long %>%
  group_by(Participant, Parameters) %>%
  mutate(
    Month0_values = ABS_value[Months == "M0"],  
    Normalized_values = ifelse(!is.na(Month0_values) & Month0_values != 0, ABS_value / Month0_values, NA)
  ) %>%
  ungroup() %>%
  select(-Month0_values) %>%
  filter(Months %in% c('M3', 'M6')) 

Raf_OA_metabolome_order <-c("Participant", "Months", "Acetate", "Propionate","Butyrate", 
                            "TotalMass", "TotalFat", "TotalLean", "TrunkFatKg",
                            "Fat.", "BMC", "BMD","TrunkFat.",
                            "HandGrip", "FastWalk", "TimeUpGo", "SitToStand", "SixMinWalk", "CITRULLINE",
                            "L.ARGININE","L.GLUTAMIC.ACID", "L.GLUTAMINE", "L.LYSINE", "L.ORNITHINE",
                            "L.PROLINE","L.SERINE","L.THREONINE", "L.TRYPTOPHAN", "L.TYROSINE", "L.VALINE",
                            "LEUCINE","TAURINE","CHOLATE","DEOXYCHOLATE","GLYCOCHOLATE",
                            "D.SORBITOL","GLUCOSE","MANNITOL","SUCCINATE","X6.CARBOXYHEXANOATE","X6.DEOXY.L.GALACTOSE",
                            "ACETOACETATE","OLEATE","OMEGA.HYDROXYDODECANOIC.ACID","PALMITATE","X10.HYDROXYDECANOATE",
                            "X3..2.HYDROXYPHENYL.PROPANOATE","X3.HYDROXY.3.METHYLGLUTARATE","X3.HYDROXYBUTANOIC.ACID",
                            "X3.HYDROXYPHENYLACETATE","X4.METHYL.2.OXO.PENTANOIC.ACID","X4.METHYLCATECHOL","X5.OXO.D.PROLINE",
                            "CORTICOSTERONE","CORTISOL","CORTISONE","ITACONATE","PHENYLACETALDEHYDE","THEOBROMINE","ALLANTOIN",
                            "BENZYL.ALCOHOL","CREATINE","CREATININE","GLUTARATE","HIPPURATE","HOMOGENTISATE","HOMOVANILLATE")

Raf_OA_metabolome_phenotype_merged_data_normalized_wide <- read.csv("Raf_OA_metabolome_phenotype_merged_data_wide.csv") %>%
  select(all_of(Raf_OA_metabolome_order))

str(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)

Phenotypic_cols <- list(body_composition_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "TotalMass"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "TrunkFat.")],
  
  function_test_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "HandGrip"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "SixMinWalk")]
  )

Serum_metabolites_cols <- list(
  Fecal_SCFA_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "Acetate"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "Butyrate")],
  
  serum_AA_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="CITRULLINE"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "TAURINE")],
  
  serum_BA_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="CHOLATE"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "GLYCOCHOLATE")],  
  
  serum_Carbo_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="D.SORBITOL"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "X6.DEOXY.L.GALACTOSE")],  
  
  serum_FAA_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="ACETOACETATE"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "X5.OXO.D.PROLINE")], 
  
  serum_Horm_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="CORTICOSTERONE"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "THEOBROMINE")], 
  
  serum_Energ_cols = names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide)[
    which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) =="ALLANTOIN"):which(names(Raf_OA_metabolome_phenotype_merged_data_normalized_wide) == "HOMOVANILLATE")])

Phenotypic_metabolites_results_combined2 <- data.frame()

# Loop over each Phenotypic category and each group of metabolites
for (Phenotype_group in names(Phenotypic_cols)) {
  for (Phenotype in Phenotypic_cols[[Phenotype_group]]) {
    for (group_name in names(Serum_metabolites_cols)) {
      for (var_name in Serum_metabolites_cols[[group_name]]) {
        test <- cor.test(Raf_OA_metabolome_phenotype_merged_data_normalized_wide[[Phenotype]], 
                         Raf_OA_metabolome_phenotype_merged_data_normalized_wide[[var_name]], 
                         use = "complete.obs")
        temp_result <- data.frame(
          OA_Phenotype = Phenotype,
          Parameter = var_name,
          correlation = test$estimate,
          p_value = test$p.value,
          Group = group_name,
          Phenotype_group = Phenotype_group  
        )
        Phenotypic_metabolites_results_combined2 <- bind_rows(Phenotypic_metabolites_results_combined2, temp_result)
      }
    }
  }
}

Phenotypic_metabolites_results_combined2
write_csv(Phenotypic_metabolites_results_combined2, "Raf_OA_Phenotypic_metabolites_results_combined_normalized.csv")

### Makes heatmap for the correlations #####
unique(Phenotypic_metabolites_results_combined$Parameter)
unique(Phenotypic_metabolites_results_combined$Group)
unique(Phenotypic_metabolites_results_combined$OA_Phenotype)

Phenotype_metabolites_order <- c("Acetate",  "Propionate", "Butyrate",
                       "CITRULLINE","L.ARGININE","L.GLUTAMIC.ACID","L.GLUTAMINE","L.LYSINE","L.ORNITHINE",
                       "L.PROLINE","L.SERINE","L.THREONINE","L.TRYPTOPHAN","L.TYROSINE","L.VALINE","LEUCINE",
                       "TAURINE","CHOLATE","DEOXYCHOLATE","GLYCOCHOLATE","D.SORBITOL","GLUCOSE","MANNITOL",
                       "SUCCINATE","X6.CARBOXYHEXANOATE","X6.DEOXY.L.GALACTOSE","ACETOACETATE","OLEATE",
                       "OMEGA.HYDROXYDODECANOIC.ACID","PALMITATE","X10.HYDROXYDECANOATE","X3..2.HYDROXYPHENYL.PROPANOATE",
                       "X3.HYDROXY.3.METHYLGLUTARATE","X3.HYDROXYBUTANOIC.ACID","X3.HYDROXYPHENYLACETATE",
                       "X4.METHYL.2.OXO.PENTANOIC.ACID","X4.METHYLCATECHOL","X5.OXO.D.PROLINE","CORTICOSTERONE","CORTISOL",
                       "CORTISONE","ITACONATE","PHENYLACETALDEHYDE","THEOBROMINE","ALLANTOIN","BENZYL.ALCOHOL","CREATINE",
                       "CREATININE","GLUTARATE","HIPPURATE","HOMOGENTISATE","HOMOVANILLATE")

Phenotype_order <- c("TotalMass", "TotalFat", "TotalLean", "TrunkFatKg",
                      "Fat.", "TrunkFat.", "BMC", "BMD", 
                      "HandGrip", "FastWalk", "TimeUpGo", "SitToStand", "SixMinWalk")

# Apply the custom parameter order and create the 'Significance' column
Phenotype_metabolites_data <- Phenotypic_metabolites_results_combined2 %>%
  mutate(
    Significance = ifelse(p_value < 0.05, "*", ""),  
    Parameter = factor(Parameter, levels = Phenotype_metabolites_order),
    OA_Phenotype = factor(OA_Phenotype, levels = Phenotype_order) # Apply custom order for parameters
  ) %>%
  arrange(Parameter, OA_Phenotype, Group) 

# Reshape data to wide format for ComplexHeatmap
Phenotype_metabolites_heatmap_data <- Phenotype_metabolites_data %>%
  select(OA_Phenotype, Parameter, correlation, Group) %>%
  pivot_wider(names_from = OA_Phenotype, values_from = correlation)

Phenotye_parameter_groups3 <- Phenotype_metabolites_heatmap_data$Group

OA_metabolites_Phenotype_heatmap_matrix <- Phenotype_metabolites_heatmap_data %>%
  select(-Group) %>%
  column_to_rownames("Parameter") %>%
  as.matrix() %>%
  t()  # Transpose to switch rows and columns

Phenotype_metabolites_significance_data <- Phenotype_metabolites_data %>%
  select(OA_Phenotype, Parameter, Significance) %>%
  pivot_wider(names_from = OA_Phenotype, values_from = Significance) # Prepare significance matrix (transposed)

Phenotype_metabolites_significance_matrix <- Phenotype_metabolites_significance_data  %>%
  column_to_rownames("Parameter") %>%
  as.matrix() %>%
  t()

# Define colors for the Group annotations
group_colors3 <- c("Fecal_SCFA_cols" = "blue",
                  "serum_AA_cols" = "darkgreen",
                  "serum_BA_cols" = "orange",
                  "serum_Carbo_cols"= "darkred",
                  "serum_Carbo_cols" = "dimgrey",
                  "serum_FAA_cols" = "tomato",
                  "serum_Horm_cols" = "yellow",
                  "serum_Energ_cols" = "black")

# Create top annotation for bacteria (columns)
top_annotation <- HeatmapAnnotation(
  Group = Phenotye_parameter_groups3,  # Group annotation for columns
  col = list(Group = group_colors3),
  annotation_legend_param = list(title = "Group")
)

range_coef <- range(OA_metabolites_Phenotype_heatmap_matrix, na.rm = TRUE)
breaks <- c(min(range_coef), 0, max(range_coef)) 
color_palette <- colorRamp2(breaks, colors = c("blue", "white", "red"))

# Generate the heatmap with ComplexHeatmap, adjusting appearance settings
Raf_phenotype_metabolites_correlations_sig <- Heatmap(
  OA_metabolites_Phenotype_heatmap_matrix,
  name = "Correlation",
  col = color_palette,
  border = TRUE,  # Adds border around each cell
  row_names_side = "left",
  column_names_side = "top",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  cell_fun = function(j, i, x, y, width, height, fill) {
     grid.rect(x, y, width, height, gp = gpar(col = "black", lwd = 0.5, fill = NA))
    # Display only significance markers
    if (!is.na(OA_metabolites_Phenotype_heatmap_matrix[i, j]) && 
        Phenotype_metabolites_significance_matrix[i, j] == "*") {
      grid.text("*", x, y, gp = gpar(col = "black", fontsize = 24))
    }
  },
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 11),       # Font size for row names
  column_names_gp = gpar(fontsize = 11),    # Font size for column names
  width = unit(5 * ncol(OA_metabolites_Phenotype_heatmap_matrix), "mm"),  # Total width for columns
  height = unit(5 * nrow(OA_metabolites_Phenotype_heatmap_matrix), "mm"), # Total height for rows
  top_annotation = top_annotation, 
  column_title = "Correlations between Metabolites & Phenotypes",
  column_title_gp = gpar(fontsize = 14, fontface = "bold"),
  row_title_gp = gpar(fontsize = 14, fontface = "bold")
)

Raf_phenotype_metabolites_correlations_sig

svg("Raf_phenotype_metabolites_correlations_sig.svg", width = 16, height = 12)
draw(Raf_phenotype_metabolites_correlations_sig)
```


```{r Figure 4A. CAZyme CGC PUL with predicted substrate Stats & Figures}
dbCAN3_info_summary_data <- read.csv("Raf_CAZy_summary.csv") # dbCAN3 CAZymes summary --- stats & figure @ fam & subfam levels
CAZy_fam_TPM_lme <- lmer(CAZy_fam_TPM ~ Treatment * Timepoint + (1 | Participant), 
                      data = dbCAN3_info_summary_data, REML = FALSE)
CAZym_subfam_TPM_lme <- lmer(CAZym_subfam_TPM ~ Treatment * Timepoint + (1 | Participant), 
                         data = dbCAN3_info_summary_data, REML = FALSE)

# Get the estimated marginal means (EMMs)
CAZy_fam_TPM_emms <- emmeans(CAZy_fam_TPM_lme, ~ Treatment * Timepoint)
CAZym_subfam_TPM_emms <- emmeans(CAZym_subfam_TPM_lme, ~ Treatment * Timepoint)

# Perform pairwise comparisons
CAZy_fam_TPM_emms_pairwise_comparisons <- contrast(CAZy_fam_TPM_emms, method = "pairwise")
CAZym_subfam_TPM_emms_pairwise_comparisons <- contrast(CAZym_subfam_TPM_emms, method = "pairwise")
CAZy_fam_TPM_emms_pairwise_comparisons_adjusted <- summary(CAZy_fam_TPM_emms_pairwise_comparisons, adjust = "bonferroni")
CAZym_subfam_TPM_emms_pairwise_comparisons_adjusted <- summary(CAZym_subfam_TPM_emms_pairwise_comparisons, adjust = "bonferroni")

print(CAZy_fam_TPM_emms_pairwise_comparisons_adjusted)
print(CAZym_subfam_TPM_emms_pairwise_comparisons_adjusted)

# stats on dbCAN3 outputs (MAG, fam, subfam, PUL, & CGC-substrate)
perform_analysis <- function(data_long, id_var, output_file) {
  unique_ids <- unique(data_long[[id_var]])
  
  # Initialize a dataframe for storing all results
  all_results <- data.frame(
    ID = character(),
    Comparison = character(),
    Estimate = numeric(),
    SE = numeric(),
    df = numeric(),
    t.ratio = numeric(),
    P.value = numeric(),
    stringsAsFactors = FALSE
  )
  
  # Analysis loop
  for (id in unique_ids) {
    sub_data <- data_long[data_long[[id_var]] == id,]
    model <- tryCatch({
      lmer(log2_TPM ~ Treatment * Time + (1 | Participant), data = sub_data, REML = FALSE)
    }, error = function(e) {
      NULL
    })
    
    if (!is.null(model) && !isSingular(model)) {
      emm <- emmeans(model, pairwise ~ Treatment * Time)
      comparisons <- summary(emm$contrasts)
      
      id_results <- data.frame(
        ID = rep(id, nrow(comparisons)),
        Comparison = comparisons$contrast,
        Estimate = comparisons$estimate,
        SE = comparisons$SE,
        df = comparisons$df,
        t.ratio = comparisons$t.ratio,
        P.value = comparisons$p.value,
        stringsAsFactors = FALSE
      )
      all_results <- rbind(all_results, id_results)
    }
  }
  print(all_results)
  write.csv(all_results, output_file, row.names = FALSE)
}

# Read, transform datasets, and add log2 transformation
datasets <- list(
  list(data = read.csv("Raf_OA_MAG_TPM_data.csv"), id_var = "MAGs_Abund", output_file = "Raf_OA_MAGs_Abundance_Analysis_Results.csv"),
  list(data = read.csv("Raf_Combined_PUL_Data.csv"), id_var = "CAZyme_PUL", output_file = "Combined_CAZyme_PUL_Analysis_Results.csv"),
  list(data = read.csv("Combined_fam_abund.csv"), id_var = "CAZyme_fam", output_file = "Combined_CAZyme_fam_Analysis_Results.csv"), 
  list(data = read.csv("Combined_CGC_substrate_abund.csv"), id_var = "CAZyme_CGC_substrate", output_file = "Combined_CAZyme_CGC_substrate_Analysis_Results.csv"))

# Loop through each dataset, transform, and perform analysis
for (dataset in datasets) {
  data_long <- dataset$data %>%
    pivot_longer(cols = -Sample_ID, names_to = dataset$id_var, values_to = "TPM") %>%
    separate(Sample_ID, into = c("Treatment", "Time", "Participant"), sep = "_") %>%
    mutate(
      Treatment = as.factor(Treatment),
      Time = as.factor(Time),
      TPM = as.numeric(TPM), 
      log2_TPM = log2(TPM + 1) # adding a constant for Log2 transformation of 0s
    )
  perform_analysis(data_long, dataset$id_var, dataset$output_file)
}

# PUL_Substrate_ figures
# Separate the 'Sample' column into 'Treatment', 'Month', and 'SampleID'
Raf_PUL_figure_data <- read.csv("Raf_Combined_PUL_sig.csv")%>%
  separate(Sample_ID, into = c("Treatment", "Month", "SampleID"), sep = "_")
str(Raf_PUL__figure_data)

Raf_PUL_figure_data_long <- pivot_longer(Raf_PUL_figure_data, 
                                 cols = starts_with("PUL"),
                                 names_to = "PUL_ID", 
                                 values_to = "Abundance") %>%
  mutate(Category = paste(Month, Treatment, sep = "_")) %>%
  mutate(Substrate = case_when(
    PUL_ID == "PUL0019" ~ "beta-glucan",
    PUL_ID == "PUL0179" ~ "beta-mannan",
    PUL_ID == "PUL0189" ~ "pectin",
    PUL_ID == "PUL0196" ~ "host glycan",
    PUL_ID == "PUL0253" ~ "X",
    PUL_ID == "PUL0323" ~ "galactan",
    PUL_ID == "PUL0366" ~ "host glycan",
    PUL_ID == "PUL0371" ~ "alpha-glucan",
    PUL_ID == "PUL0392" ~ "xylan",
    PUL_ID == "PUL0518" ~ "X",
    PUL_ID == "PUL0585" ~ "beta-glucan",
    PUL_ID == "PUL0619" ~ "xylan",
    PUL_ID == "PUL0633" ~ "alpha-glucan",
    PUL_ID == "PUL0638" ~ "alpha-glucan",
    PUL_ID == "PUL0639" ~ "alpha-glucan",
    PUL_ID == "PUL0649" ~ "X",
    PUL_ID == "PUL0651" ~ "galactan",
    TRUE ~ NA_character_  
  ))

Raf_PUL_figure_data_long

write.csv(Raf_PUL_figure_data_long, "Raf_PUL_figure_data_long.csv", row.names = FALSE)

# Order PUL_ID by median Abundance values
Raf_PUL_figure_data_long <- Raf_PUL_figure_data_long %>%
  group_by(Substrate) %>%
  mutate(MedianAbundance = median(Abundance, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Substrate = factor(Substrate, 
                            levels = unique(Substrate[order(MedianAbundance)])))

Raf_PUL_figure_data_long$Category <- factor(Raf_PUL_figure_data_long$Category, 
                                            levels = c('M0_Placebo', 'M0_Prebiotic',
                                                       'M3_Placebo', 'M3_Prebiotic', 
                                                       'M6_Placebo', 'M6_Prebiotic'))
# Generate the plot for combined_plot1
Raf_PUL_plot <- ggplot(Raf_PUL_figure_data_long, 
                       aes(x = Month, y = log2(Abundance), fill = Category)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", 
                               "tomato", "black", "red")) +
  ylab("PUL Abundance \nLog2(TPM)") +
  xlab("Time (Month)") +
  facet_wrap(~PUL_ID, scales = "free", nrow = 3)+
  mytheme1 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_PUL_figure_data_long$PUL_ID)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)
Raf_PUL_plot

```

```{r Figure 4B. Dietary & Host glycan degrading enzyme activities}
# Bacterial glycan-degrading enzyme activities towards host- or plant-glycans determined by employing p-nitrophenyl-linked substrates
# beta-N-acetylglucosaminidase (4N-NAG),a-Fucosidase (4-FP) & Sulfatase (4N-S) are mucin degrading enzymes; 
# beta-glucosidase (4N-GluP) & a-galactosidase are plant glycan enzymes

Raf_CAZymes_file_paths <- list("Raf_OA_CAZyme_4N_NAG_Blankout.csv" = "4N_NAG", 
                               "Raf_OA_CAZyme_4N_GalP_Blankout.csv" = "4N_GalP",
                               "Raf_OA_CAZyme_4N_S_Blankout.csv" = "4N_S", 
                               "Raf_OA_CAZyme_4N_FP_Blankout.csv" = "4N_FP",
                               "Raf_OA_CAZyme_4N_GluP_Blankout.csv" = "4N_GluP")

# Reading the files and adding the source information from file paths
Raf_CAZymes_file_list <- lapply(names(Raf_CAZymes_file_paths), function(file) {
  df <- read.csv(file)
  df$Source <- Raf_CAZymes_file_paths[[file]]  # Add a new column for the file source
  df <- df %>%
    mutate(across(starts_with("Prebiotic") | starts_with("Placebo"), as.numeric))
  return(df)
})

Raf_CAZymes_file_combined <- bind_rows(Raf_CAZymes_file_list)
Raf_CAZymes_file_combined_long <- pivot_longer(Raf_CAZymes_file_combined, 
                                               cols = starts_with("Prebiotic") | starts_with("Placebo"), 
                                               names_to = "SampleID", values_to = "Value")

# Split the SampleID into Treatment, ParticipantID, and Timepoint
Raf_CAZymes_file_combined_long <- Raf_CAZymes_file_combined_long %>%
  separate(SampleID, into = c("Treatment", "ParticipantID", "Timepoint"), sep = "_", remove = FALSE)

# Convert the "Time" column to minutes (assuming the format is "0:42:00" - HH:MM:SS)
Raf_CAZymes_file_combined_long$Time <- as.numeric(hms(Raf_CAZymes_file_combined_long$Time)) / 60  

# Function to perform linear regression and store the results
calculate_regression <- function(df) {
  fit <- lm(Value ~ Time, data = df)
  slope <- coef(fit)["Time"] # Extract the slope
  intercept <- coef(fit)["(Intercept)"] # intercept
  r_squared <- summary(fit)$r.squared # RÂ²
  
  # Create a regression equation as a string
  equation <- paste("y =", round(intercept, 4), "+", round(slope, 6), "* Time")
  
  # Return the results in a dataframe
  return(data.frame(
    Source = df$Source[1],  # The enzyme source
    Treatment = df$Treatment[1],
    ParticipantID = df$ParticipantID[1],
    Timepoint = df$Timepoint[1],
    Slope = slope,
    R_squared = r_squared,
    Equation = equation
  ))
}

# Group the data by each sample (Treatment, ParticipantID, Timepoint)
Raf_CAZymes_activity_regression_results <- Raf_CAZymes_file_combined_long %>%
  group_by(ParticipantID, Source, Timepoint) %>%
  do(calculate_regression(.))

write.csv(Raf_CAZymes_activity_regression_results, "Raf_CAZymes_activity_regression_results.csv", row.names = FALSE)

### Calculate enzymatic activity in Excel ####
### Re-import calculated results for figures ###
Raf_CAZyme_activity_data <- read.csv("Raf_CAZymes_Activity_Final.csv", head=TRUE)%>%
  mutate(Category = paste(Time, Treatment, sep = "_"))
str(Raf_CAZyme_activity_data)

Raf_CAZyme_activity_data$Activity <- as.numeric(Raf_CAZyme_activity_data$Activity)
Raf_CAZyme_activity_data$Ratio <- as.numeric(Raf_CAZyme_activity_data$Ratio)

Raf_CAZyme_activity_wide <- Raf_CAZyme_activity_data %>%
  pivot_wider(names_from = Substrate, values_from = Activity) 

CAZym_4N_S_lme <- lmer(Enzy_4N_S ~ Treatment * Time + (1 | Participant_ID), 
                       data = Raf_CAZyme_activity_wide, REML = FALSE)

CAZy_4N_FP_lme <- lmer(Enzy_4N_FP ~ Treatment * Time + (1 | Participant_ID), 
                       data = Raf_CAZyme_activity_wide, REML = FALSE)

CAZym_4N_NAG_lme <- lmer(Enzy_4N_NAG ~ Treatment * Time + (1 | Participant_ID), 
                         data = Raf_CAZyme_activity_wide, REML = FALSE)

CAZym_4N_GalP_lme <- lmer(Enzy_4N_GalP~ Treatment * Time + (1 | Participant_ID), 
                          data = Raf_CAZyme_activity_wide, REML = FALSE)

CAZym_4N_GluP_lme <- lmer(Enzy_4N_GluP ~ Treatment * Time + (1 | Participant_ID), 
                          data = Raf_CAZyme_activity_wide, REML = FALSE)

# Get the estimated marginal means (EMMs)
CAZym_4N_S_emms <- emmeans(CAZym_4N_S_lme, ~ Treatment * Time)
CAZy_4N_FP_emms <- emmeans(CAZy_4N_FP_lme, ~ Treatment * Time)
CAZym_4N_NAG_memms <- emmeans(CAZym_4N_NAG_lme, ~ Treatment * Time)
CAZym_4N_GalP_emms <- emmeans(CAZym_4N_GalP_lme, ~ Treatment * Time)
CAZym_4N_GluP_emms <- emmeans(CAZym_4N_GluP_lme, ~ Treatment * Time)

# Perform pairwise comparisons
CAZym_4N_S_emms_pairwise_comparisons <- contrast(CAZym_4N_S_emms, interaction = "pairwise", simple = "each")
CAZy_4N_FP_emms_pairwise_comparisons <- contrast(CAZy_4N_FP_emms, interaction = "pairwise", simple = "each")
CAZym_4N_NAG_emms_pairwise_comparisons <- contrast(CAZym_4N_NAG_memms, interaction = "pairwise", simple = "each")
CAZym_4N_GalP_emms_pairwise_comparisons <- contrast(CAZym_4N_GalP_emms, interaction = "pairwise", simple = "each")
CAZym_4N_GluP_emms_pairwise_comparisons <- contrast(CAZym_4N_GluP_emms, interaction = "pairwise", simple = "each")

summary(CAZym_4N_S_emms_pairwise_comparisons)
summary(CAZy_4N_FP_emms_pairwise_comparisons)
summary(CAZym_4N_NAG_emms_pairwise_comparisons)
summary(CAZym_4N_GalP_emms_pairwise_comparisons)
summary(CAZym_4N_GluP_emms_pairwise_comparisons)

# Summarise data: calculate mean and SEM (Standard Error of the Mean)
Raf_CAZyme_activity_summary <- Raf_CAZyme_activity_data %>%
  group_by(Time, Treatment, Category, Substrate) %>%
  summarise(
    Mean_Activity = mean(Activity, na.rm = TRUE),
    SEM_Activity = sd(Activity, na.rm = TRUE) / sqrt(n()) # SEM for Activity
  )

write.csv(Raf_CAZyme_activity_summary, "Raf_OA_CAZyme_activity_summary.csv")  

Raf_CAZyme_activity_summary$Substrate <- factor(Raf_CAZyme_activity_summary$Substrate, 
                                             levels = c('Enzy_4N_S','Enzy_4N_FP',
                                                        'Enzy_4N_NAG','Enzy_4N_GalP',
                                                        'Enzy_4N_GluP'))

Raf_CAZyme_activity_data$Substrate <- factor(Raf_CAZyme_activity_data$Substrate, 
                                             levels = c('Enzy_4N_S','Enzy_4N_FP', 
                                                        'Enzy_4N_NAG','Enzy_4N_GalP',
                                                        'Enzy_4N_GluP'))


Raf_CAZyme_activity_figure <- Raf_CAZyme_activity_summary %>%
  ggplot() +
  geom_jitter(data = Raf_CAZyme_activity_data, 
              aes(x = Time, y = Activity,  fill = Category),color = "black", 
              shape = 21, size = 3, alpha = 1, width = 0.25) +
  geom_line(data = Raf_CAZyme_activity_summary, 
            aes(x = Time, y = Mean_Activity, color = Treatment, group = Treatment), 
            size = 0.75) +  
  geom_point(data = Raf_CAZyme_activity_summary, 
             aes(x = Time, y = Mean_Activity, color = Treatment), size = 4) +
  geom_errorbar(data = Raf_CAZyme_activity_summary, 
                aes(x = Time, ymin = Mean_Activity - SEM_Activity, ymax = Mean_Activity + SEM_Activity, color = Treatment), 
                width = 0.15) +
  scale_color_manual(values = c("black", "red")) + 
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey", 
                               "tomato", "black", "red")) +  
  facet_wrap(~Substrate, scales = "free", nrow = 2) +  
  scale_x_discrete(breaks = c("M0", "M3", "M6"), labels = c("0", "3", "6")) +
  ylab("Enzymatic Activity \n (nkat/mg)") +
  xlab("Time (Month)") +
  mytheme4 +
  geom_vline(xintercept = seq(1.5, length(unique(Raf_CAZyme_activity_data$Time)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_CAZyme_activity_figure

ggsave("Raf_CAZyme_enzymatic_activity_figure.svg", 
       plot = Raf_CAZyme_activity_figure, 
       device = "svg", 
       width = 7, height = 7, 
       units = "in")


#### Spearman's Rank correlation between CAZymes Enzymatic Activity and Phenotype
Raf_CAZyme_activity_data <- read.csv("Raf_CAZymes_Activity_Final.csv", head=TRUE)%>%
  mutate(Group = paste(Treatment,Time, Participant_ID, sep = "_")) %>% 
  pivot_wider(names_from = Substrate, values_from = Activity)

Raf_OA_Phenotype_subset_for_CAZyme_activity <- read.csv("Raf_OA_Phenotype_subset_for_CAZymes_Activity_correlation.csv") %>%
  mutate(Group = paste(Category, Participant, sep = "_"))

Raf_CAZyme_activity_phenotype_regression <- merge(Raf_CAZyme_activity_data, 
                                                   Raf_OA_Phenotype_subset_for_CAZyme_activity,
                                                   by = "Group", all = TRUE) 
str(Raf_CAZyme_activity_phenotype_regression)

enzyme_columns <- Raf_CAZyme_activity_phenotype_regression %>%
  select(starts_with("Enzy_"))

phenotype_columns <- Raf_CAZyme_activity_phenotype_regression %>%
  select(TotalMass:TimeUpGo) 
  
# Install and load the MuMIn package (if not already installed)
# install.packages("MuMIn")  
# library(MuMIn)

# Initialize an empty dataframe to store the regression results
mixed_model_results <- data.frame(Enzyme = character(), 
                                  Phenotype = character(),
                                  Coefficient = numeric(),
                                  PValue = numeric(),
                                  RSquared_Marginal = numeric(),
                                  RSquared_Conditional = numeric(),
                                  stringsAsFactors = FALSE)

# Loop through each enzyme and phenotype to perform mixed-effects regression
for (enzyme in colnames(enzyme_columns)) {
  for (phenotype in colnames(phenotype_columns)) {
    # Create a formula for the model
    formula <- as.formula(paste(phenotype, "~", enzyme, "+  (1 | Participant_ID)"))
    
    # Fit the mixed-effects model
    lme_model <- lmer(formula, data = Raf_CAZyme_activity_phenotype_regression, REML = FALSE)
    
    # Extract coefficients and p-values
    coef_value <- fixef(lme_model)[2]  # Coefficient for the enzyme variable
    p_value <- summary(lme_model)$coefficients[2, 5]  # p-value for the enzyme variable
    
    # Calculate the R-squared value using MuMIn::r.squaredGLMM
    r_squared_values <- r.squaredGLMM(lme_model)  # Get the R-squared values
    
    # Extract marginal and conditional R-squared
    r_squared_marginal <- r_squared_values[1]  # R-squared for fixed effects only
    r_squared_conditional <- r_squared_values[2]  # R-squared for fixed + random effects
    
    # Append results to the mixed_model_results dataframe
    mixed_model_results <- rbind(mixed_model_results, 
                                 data.frame(Enzyme = enzyme,
                                            Phenotype = phenotype,
                                            Coefficient = coef_value,
                                            PValue = p_value,
                                            RSquared_Marginal = r_squared_marginal,
                                            RSquared_Conditional = r_squared_conditional))
  }
}
print(mixed_model_results)
write.csv(mixed_model_results, "Raf_OA_Enzyme_Phenotype_regression.csv")

Raf_CAZyme_activity_phenotype_regression_figure <-Raf_CAZyme_activity_phenotype_regression %>%
  mutate(Category = paste(Treatment,Time, sep = "_")) 

Raf_GalP_trunkfatkg_correlation <- ggplot(Raf_CAZyme_activity_phenotype_regression, 
                                 aes(x = TrunkFatKg, y = Enzy_4N_GalP)) + 
  geom_point(aes(fill = Category), shape =21, size=3) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  scale_color_manual(values = c("black", "red")) +
  geom_smooth(aes(group = Treatment, color = Treatment), method = "gam", alpha = 0.5) +
  mytheme3

Raf_GalP_trunkfatkg_correlation


Raf_FP_trunkfat_correlation <- ggplot(Raf_CAZyme_activity_phenotype_regression, 
                                          aes(x = TrunkFat., y = Enzy_4N_FP)) + 
  geom_point(aes(fill = Category), shape =21, size=3) +
  scale_fill_manual(values = c("grey", "dimgrey", "black", "#FFA07A", "tomato", "red")) +
  scale_color_manual(values = c("black", "red")) +
  geom_smooth(aes(group = Treatment, color = Treatment), method = "gam", alpha = 0.5) +
  mytheme3

Raf_FP_trunkfat_correlation

```


```{r Figure 4D. Correlations between CGC Substrate, Serum metabolome, fecal SCFA & Phenotypes}
Raf_OA_CGC_Substrate_data <- read.csv("Combined_CGC_substrate_abund_for_network.csv")
Raf_OA_metabolome <- read.csv("Raf_metabolites_quality_control_Filtered_Intensity_Data.csv")

Raf_OA_CGC_phenotype_merged_data <- merge(
  Raf_OA_CGC_Substrate_data, 
  Raf_OA_metabolome,
  by = "Sample_Name") %>%
  select(-SampleID)

Raf_OA_CGC_phenotype_merged_data <- merge(
  Raf_OA_CGC_phenotype_merged_data,
  Raf_OA_phenotype_data_outlier_filtered, 
  by = "Sample_Name")

Raf_OA_CGC_phenotype_merged_data_long <- Raf_OA_CGC_phenotype_merged_data %>%
  select(c(Sample_Name, Participant, Months, alginate:URIDINE, TotalMass:TimeUpGo)) %>%
  pivot_longer(cols = c(alginate:URIDINE, TotalMass:TimeUpGo), 
               names_to = "Parameters", values_to = "ABS_value")

Raf_OA_CGC_phenotype_merged_data_long_normalized <- Raf_OA_CGC_phenotype_merged_data_long %>%
  group_by(Participant, Parameters) %>%
  mutate(
    Month0_values = ABS_value[Months == "M0"],  
    Normalized_values = ifelse(!is.na(Month0_values) & Month0_values != 0, ABS_value / Month0_values, NA)
  ) %>%
  ungroup() %>%
  select(-Month0_values) %>%
  filter(Months %in% c('M3', 'M6')) 

write.csv(Raf_OA_CGC_phenotype_merged_data_long_normalized, 
          "Raf_OA_CGC_phenotype_merged_data_long_normalized.csv",
           row.names =FALSE)

unique(Raf_OA_CGC_phenotype_merged_data_long_normalized$Parameters)

Raf_CGC_phenotype_order <-c("Participant", "Months", "Acetate", "Propionate","Butyrate", 
                            "TotalMass", "TotalFat", "TotalLean", "TrunkFatKg","Fat.", "BMC", "BMD",
                            "TrunkFat.","HandGrip", "FastWalk", "TimeUpGo", "SitToStand", "SixMinWalk", 
                            "alpha.galactan","alpha.glucan","alpha.mannan", "alpha.rhamnoside","arabinan", "arabinogalactan",
                            "arabinogalactanprotein", "beta.fucosides", "beta.galactan", "beta.glucan", "beta.glucuronan","beta.mannan",       
                             "cellulose", "chitin",  "fructan",  "glycogen", "hostglycan", "pectin", "peptidoglycan",  "rhamnose", 
                             "starch", "sucrose", "xylan","xyloglucan", "CITRULLINE","L.ARGININE","L.GLUTAMIC.ACID", "L.GLUTAMINE", "L.LYSINE",
                            "L.ORNITHINE", "L.PROLINE","L.SERINE","L.THREONINE", "L.TRYPTOPHAN", "L.TYROSINE", "L.VALINE", "LEUCINE", "TAURINE", 
                            "CHOLATE","DEOXYCHOLATE","GLYCOCHOLATE","D.SORBITOL","GLUCOSE","MANNITOL","SUCCINATE","X6.CARBOXYHEXANOATE",
                            "X6.DEOXY.L.GALACTOSE","ACETOACETATE","OLEATE","OMEGA.HYDROXYDODECANOIC.ACID","PALMITATE","X10.HYDROXYDECANOATE",
                            "X3..2.HYDROXYPHENYL.PROPANOATE","X3.HYDROXY.3.METHYLGLUTARATE","X3.HYDROXYBUTANOIC.ACID",
                            "X3.HYDROXYPHENYLACETATE","X4.METHYL.2.OXO.PENTANOIC.ACID","X4.METHYLCATECHOL","X5.OXO.D.PROLINE",
                            "CORTICOSTERONE","CORTISOL","CORTISONE","ITACONATE","PHENYLACETALDEHYDE","THEOBROMINE","ALLANTOIN",
                            "BENZYL.ALCOHOL","CREATINE","CREATININE","GLUTARATE","HIPPURATE","HOMOGENTISATE","HOMOVANILLATE")

Raf_OA_CGC_phenotype_merged_data_long_normalized_wide <- read.csv("Raf_OA_CGC_phenotype_merged_data_normalized_wide.csv") %>%
  select(all_of(Raf_CGC_phenotype_order))

str(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)

CGC_Substrate_cols <- Raf_OA_CGC_phenotype_merged_data_long_normalized_wide[, 19:42]

Phenotypic_cols2 <- list(body_composition_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
                         [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "TotalMass"):
                             which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "TrunkFat.")],
  
  function_test_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "HandGrip"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "SixMinWalk")],
  
  Fecal_SCFA_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "Acetate"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "Butyrate")],
  
  serum_AA_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="CITRULLINE"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "TAURINE")],
  
  serum_BA_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="CHOLATE"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "GLYCOCHOLATE")],  
  
  serum_Carbo_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="D.SORBITOL"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "X6.DEOXY.L.GALACTOSE")],  
  
  serum_FAA_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="ACETOACETATE"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "X5.OXO.D.PROLINE")], 
  
  serum_Horm_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="CORTICOSTERONE"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "THEOBROMINE")], 
  
  serum_Energ_cols = names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide)
  [which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) =="ALLANTOIN"):
      which(names(Raf_OA_CGC_phenotype_merged_data_long_normalized_wide) == "HOMOVANILLATE")])

Phenotypic_CGC_results_combined <- data.frame()

# Loop over each Phenotypic category and each group of metabolites
for (CGC_Substrate in colnames(CGC_Substrate_cols)) {
  for (group_name in names(Phenotypic_cols2 )) {
    for (var_name in Phenotypic_cols2 [[group_name]]) {
      test <- cor.test(Raf_OA_CGC_phenotype_merged_data[[CGC_Substrate]], 
                       Raf_OA_CGC_phenotype_merged_data[[var_name]], use = "complete.obs")
      temp_result <- data.frame(
        CGC_Substrate = CGC_Substrate,
        Parameter = var_name,
        correlation = test$estimate,
        p_value = test$p.value,
        Group = group_name
      )
      Phenotypic_CGC_results_combined <- bind_rows(Phenotypic_CGC_results_combined, temp_result)
    }
  }
}

Phenotypic_CGC_results_combined
write_csv(Phenotypic_CGC_results_combined, "Raf_OA_Phenotypic_CGC_results_combined_normalized.csv")


### Makes heatmap for the correlations #####
# Define the specific order for phenotype cols
unique(Phenotypic_CGC_results_combined$Parameter)
unique(Phenotypic_CGC_results_combined$CGC_Substrate)

Parameters_order4 <- c("Acetate",  "Propionate", "Butyrate",
                       "CITRULLINE","L.ARGININE","L.GLUTAMIC.ACID", "L.GLUTAMINE", "L.LYSINE", "L.ORNITHINE",
                       "L.PROLINE","L.SERINE","L.THREONINE", "L.TRYPTOPHAN", "L.TYROSINE", "L.VALINE", "LEUCINE", "TAURINE", 
                       "CHOLATE","DEOXYCHOLATE","GLYCOCHOLATE","D.SORBITOL","GLUCOSE","MANNITOL","SUCCINATE","X6.CARBOXYHEXANOATE",
                       "X6.DEOXY.L.GALACTOSE","ACETOACETATE","OLEATE","OMEGA.HYDROXYDODECANOIC.ACID","PALMITATE","X10.HYDROXYDECANOATE",
                       "X3..2.HYDROXYPHENYL.PROPANOATE","X3.HYDROXY.3.METHYLGLUTARATE","X3.HYDROXYBUTANOIC.ACID",
                       "X3.HYDROXYPHENYLACETATE","X4.METHYL.2.OXO.PENTANOIC.ACID","X4.METHYLCATECHOL","X5.OXO.D.PROLINE",
                       "CORTICOSTERONE","CORTISOL","CORTISONE","ITACONATE","PHENYLACETALDEHYDE","THEOBROMINE","ALLANTOIN",
                       "BENZYL.ALCOHOL","CREATINE","CREATININE","GLUTARATE","HIPPURATE","HOMOGENTISATE","HOMOVANILLATE",
                       "TotalMass", "TotalLean","TotalFat", "TrunkFatKg", "Fat.", "TrunkFat.", "BMC", "BMD","HandGrip", 
                       "FastWalk",  "SitToStand", "SixMinWalk","TimeUpGo")

# Apply the custom parameter order and create the 'Significance' column
CGC_Substrate_Phenotype_data <- Phenotypic_CGC_results_combined %>%
  mutate(
    Significance = ifelse(p_value < 0.05, "*", ""),  
    Parameter = factor(Parameter, levels = Parameters_order4)  # Apply custom order for parameters
  ) %>%
  arrange(Parameter, CGC_Substrate, Group) 

# Reshape data to wide format for ComplexHeatmap
CGC_Substrate_Phenotype_heatmap_data <- CGC_Substrate_Phenotype_data %>%
  select(CGC_Substrate, Parameter, correlation, Group) %>%
  pivot_wider(names_from = CGC_Substrate, values_from = correlation)

Phenotye_parameter_groups2 <- CGC_Substrate_Phenotype_heatmap_data$Group

CGC_Substrate_Phenotype_heatmap_matrix <- CGC_Substrate_Phenotype_heatmap_data %>%
  select(-Group) %>%
  column_to_rownames("Parameter") %>%
  as.matrix() %>%
  t()  # Transpose to switch rows and columns

CGC_Substrate_Phenotype_significance_data <- CGC_Substrate_Phenotype_data %>%
  select(CGC_Substrate, Parameter, Significance) %>%
  pivot_wider(names_from = CGC_Substrate, values_from = Significance) # Prepare significance matrix (transposed)

CGC_Substrate_Phenotype_significance_matrix <- CGC_Substrate_Phenotype_significance_data %>%
  column_to_rownames("Parameter") %>%
  as.matrix() %>%
  t()

# Define colors for the Group annotations
group_colors2 <- c("Fecal_SCFA_cols" = "blue",
                  "body_composition_cols" = "pink",
                  "function_test_cols" = "purple",
                  "serum_AA_cols" = "darkgreen",
                  "serum_BA_cols" = "orange",
                  "serum_Carbo_cols"= "darkred",
                  "serum_Carbo_cols" = "dimgrey",
                  "serum_FAA_cols" = "tomato",
                  "serum_Horm_cols" = "yellow",
                  "serum_Energ_cols" = "black")

# Create top annotation for bacteria (columns)
top_annotation <- HeatmapAnnotation(
  Group = Phenotye_parameter_groups2,  # Group annotation for columns
  col = list(Group = group_colors2),
  annotation_legend_param = list(title = "Group")
)

range_coef <- range(CGC_Substrate_Phenotype_heatmap_matrix, na.rm = TRUE)
breaks <- c(min(range_coef), 0, max(range_coef)) 
color_palette <- colorRamp2(breaks, colors = c("blue", "white", "red"))

# Generate the heatmap with ComplexHeatmap, adjusting appearance settings
Raf_phenotype_CGC_Substrate_correlations2 <- Heatmap(
  CGC_Substrate_Phenotype_heatmap_matrix,
  name = "Correlation",
  col = color_palette,
  border = TRUE,  # Adds border around each cell
  row_names_side = "left",
  column_names_side = "top",
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  cell_fun = function(j, i, x, y, width, height, fill) {
     grid.rect(x, y, width, height, gp = gpar(col = "black", lwd = 0.5, fill = NA))
    # Display only significance markers
    if (!is.na(CGC_Substrate_Phenotype_significance_matrix[i, j]) && 
        CGC_Substrate_Phenotype_significance_matrix[i, j] == "*") {
      grid.text("*", x, y, gp = gpar(col = "black", fontsize = 24))
    }
  },
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 11),       # Font size for row names
  column_names_gp = gpar(fontsize = 11),    # Font size for column names
  width = unit(5 * ncol(CGC_Substrate_Phenotype_heatmap_matrix), "mm"),  # Total width for columns
  height = unit(5 * nrow(CGC_Substrate_Phenotype_heatmap_matrix), "mm"), # Total height for rows
  top_annotation = top_annotation, 
  column_title = "Correlations between dbCAN3 CGC-substrate prediction, Fecal SCFA, & Phenotypes",
  column_title_gp = gpar(fontsize = 14, fontface = "bold"),
  row_title_gp = gpar(fontsize = 14, fontface = "bold")
)

Raf_phenotype_CGC_Substrate_correlations2

svg("Raf_phenotype_CGC_Substrate_correlations_pheno_normalized.svg", width = 16, height = 12)
draw(Raf_phenotype_CGC_Substrate_correlations2)

# Integrate CGC_Substrate abundance vs. corresponding correlation with phenotype 

str(Raf_OA_CGC_phenotype_merged_data)

CGC_list <- c("Group", "Months","Participant", "alpha.galactan","alpha.glucan",
              "alpha.mannan", "alpha.rhamnoside","arabinan", 
              "arabinogalactan","arabinogalactanprotein", "beta.fucosides", 
              "beta.galactan", "beta.glucan", "beta.glucuronan",
              "beta.mannan","cellulose", "chitin",  "fructan",  "glycogen", 
              "hostglycan", "pectin", "peptidoglycan",  
              "rhamnose", "starch", "sucrose", "xylan","xyloglucan")

Raf_CGC_Substrate_figure_data <- Raf_OA_CGC_phenotype_merged_data %>%
  select(all_of(CGC_list)) %>%
  pivot_longer(cols = alpha.galactan:xyloglucan, names_to = 'CGC_Substrate', values_to = 'TPM')

Raf_CGC_Substrate_figure_data_normalized <- Raf_CGC_Substrate_figure_data %>%
  group_by(Participant, CGC_Substrate) %>%
  mutate(
    Month0_values = TPM[Months == "M0"],  
    Normalized_values = ifelse(!is.na(Month0_values) & Month0_values != 0, TPM / Month0_values, NA)
  ) %>%
  ungroup() %>%
  select(-Month0_values) %>%
  filter(Months %in% c('M3', 'M6')) 
  
str(Raf_CGC_Substrate_figure_data_normalized)

# Extract the row names based on the order
row_order_clustered <- row_order(Raf_phenotype_CGC_Substrate_correlations2)
row_names_clustered <- rownames(CGC_Substrate_Phenotype_heatmap_matrix)[row_order_clustered]
row_names_clustered_reversed <- rev(row_names_clustered)
print(row_names_clustered_reversed)

# Ensure CGC_Substrate matches the order in row_names_ordered
Raf_CGC_Substrate_figure_data$CGC_Substrate <- factor(Raf_CGC_Substrate_figure_data$CGC_Substrate, 
                                                      levels = row_names_clustered_reversed)

Raf_CGC_Substrate_figure_data$Group <- factor(Raf_CGC_Substrate_figure_data$Group, 
                                            levels = c('Placebo_M0','Prebiotic_M0', 
                                                       'Placebo_M3','Prebiotic_M3', 
                                                       'Placebo_M6', 'Prebiotic_M6'))

Raf_CGC_Substrate_figure <- ggplot(Raf_CGC_Substrate_figure_data, 
                       aes(x = CGC_Substrate, y =TPM, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A", "dimgrey","tomato","black", "red")) +
  ylab("Abundance (TPM)") +
  xlab("dbCAN3 predicted CGC Substrate") +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_CGC_Substrate_figure_data$CGC_Substrate)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", stroke = 0.25)+
  facet_grid(~ Months, scales = "free") +
  coord_flip() 

Raf_CGC_Substrate_figure

ggsave("Raf_CGC_Substrate_abundance_figure_raw.svg", 
       plot = Raf_CGC_Substrate_figure, 
       device = "svg", 
       width = 9, height = 9, 
       units = "in")
```


```{r Figures 5A & D-H. Fructan/host-glycan degrding MAG annotation and profiling stats & figures}
Raf_dbCAN3_MAG_rpkm_data <- read.csv("Raf_OA_MAGs_RPKM_data.csv", row.names = 1)
Raf_dbCAN3_MAG_rpkm_data_transposed <- t(Raf_dbCAN3_MAG_rpkm_data)
colnames(Raf_dbCAN3_MAG_rpkm_data_transposed)

# Calculate TPM for each sample in a loop
for (sample in colnames(Raf_dbCAN3_MAG_rpkm_data_transposed)) {
  total_rpkm <- sum(Raf_dbCAN3_MAG_rpkm_data_transposed[, sample], na.rm = TRUE)
  Raf_dbCAN3_MAG_rpkm_data_transposed[, sample] <- (Raf_dbCAN3_MAG_rpkm_data_transposed[, sample] / total_rpkm) * 1e6
}

Raf_OA_MAG_TPM_data <- t(Raf_dbCAN3_MAG_rpkm_data_transposed)
Raf_OA_MAG_TPM_data  <- cbind(Sample_ID = rownames(Raf_OA_MAG_TPM_data), Raf_OA_MAG_TPM_data)

write.csv(Raf_OA_MAG_TPM_data, "Raf_OA_MAG_TPM_data.csv", row.names = FALSE)
head(Raf_OA_MAG_TPM_data)

############################# Filter the MAG IDs with sig PULs ################
Raf_OA_MAG_sig_data <- read.csv("Raf_OA_MAGs_Abundance_Analysis_Results.csv", header = TRUE) %>% 
  filter(Comparison %in% c("Placebo M0 - Prebiotic M0","Placebo M3 - Prebiotic M3",
                           "Placebo M6 - Prebiotic M6","Placebo M0 - Placebo M3",
                           "Placebo M0 - Placebo M6","Placebo M3 - Placebo M6",
                           "Prebiotic M0 - Prebiotic M3", "Prebiotic M0 - Prebiotic M6",
                           "Prebiotic M3 - Prebiotic M6") & `P.value` < 0.05) 

Raf_OA_MAG_sig_list <- Raf_OA_MAG_sig_data %>%
  distinct(ID)
MAG_sig_IDs <- Raf_OA_MAG_sig_list$ID
MAG_sig_IDs

Raf_OA_MAG_sig_filtered <- as.data.frame(Raf_OA_MAG_TPM_data[-1, ]) %>% 
  select(Sample_ID, any_of(MAG_sig_IDs)) %>% 
  pivot_longer(cols = -Sample_ID, names_to = "MAG_ID", values_to = "TPM") %>% 
  separate(Sample_ID, into = c("Treatment", "Month", "Participant"), sep = "_") %>% 
  mutate(Category = paste(Month, Treatment, sep = "_"))

Raf_OA_MAG_sig_filtered$TPM <- as.numeric(Raf_OA_MAG_sig_filtered$TPM)
head(Raf_OA_MAG_sig_filtered)

threshold <- 2
Raf_OA_MAG_sig_filtered <- Raf_OA_MAG_sig_filtered %>%
  group_by(Treatment, Month, Category) %>%
  filter(abs(TPM - mean(TPM)) <= threshold * sd(TPM))

Raf_OA_MAG_sig_filtered$Category <- factor(Raf_OA_MAG_sig_filtered$Category, 
                                            levels = c('M0_Placebo','M0_Prebiotic','M3_Placebo',
                                                       'M3_Prebiotic', 'M6_Placebo', 'M6_Prebiotic'))

Raf_MAG_sig_plot <- ggplot(Raf_OA_MAG_sig_filtered, 
                       aes(x = MAG_ID, y =TPM, fill = Category)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey","#FFA07A", "dimgrey",
                               "tomato","black", "red")) +
  ylab("MAG Abundance \nLog2(TPM)") +
  xlab("Time (Month)") +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_MAG_sig_filtered$MAG_ID)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)+
  facet_wrap(~MAG_ID, scales = "free", nrow = 4) 

Raf_MAG_sig_plot

ggsave("Raf_MAG_sig_plot.svg", 
       plot = Raf_MAG_sig_plot, 
       device = "svg", 
       width = 9, height = 8, 
       units = "in")

########################## summarize MAG PUL ID for iTOL #############
Raf_MAG_PUL_data <- read.csv("Raf_MAG_PUL.csv")
str(Raf_MAG_PUL_data)

Raf_MAG_PUL_summary_table <- Raf_MAG_PUL_data %>%
  group_by(Sample.ID, PUL_substrate) %>%
  summarise(
    PUL_count = n(), # Count all occurrences of PUL ID
    PUL_IDs = paste(unique(PUL.ID ), collapse = ", ") # List unique PUL IDs
  ) %>%
  ungroup() 

write.csv(Raf_MAG_PUL_summary_table, "Raf_MAG_PUL_Summary_Table.csv", row.names = FALSE)

Raf_MAG_PUL_top_substrates <- Raf_MAG_PUL_summary_table %>%
  select(Sample.ID, PUL_substrate, PUL_count) %>%
  filter(PUL_substrate %in% 
           c("host glycan", "beta-glucan","pectin","xylan","arabinogalactan",
             "galactan","alpha-glucan","beta-mannan","fructan")) %>%
pivot_wider(names_from = PUL_substrate, values_from = PUL_count)

Raf_MAG_taxa <- read.csv("Raf_OA_MAG_Taxanomy.csv")

Raf_MAG_PUL_top_substrates_with_taxa <- full_join(Raf_MAG_taxa, Raf_MAG_PUL_top_substrates, by = "Sample.ID")
Raf_MAG_PUL_top_substrates_with_taxa[is.na(Raf_MAG_PUL_top_substrates_with_taxa)] <- 0

write.csv(Raf_MAG_PUL_top_substrates_with_taxa, "Raf_MAG_PUL_top_substrates_with_taxa.csv", row.names = FALSE)

######### Specific Summary for fructan & host-glycan degrades #####
Raf_OA_MAG_fructan_hostglycan_data <- read.csv("Raf_MAG_Fructan_hostglycan_PUL_for_ranking.csv")
Raf_OA_MAG_fructan_hostglycan_data$host_glycan_rank <- rank(-Raf_OA_MAG_fructan_hostglycan_data$host.glycan, ties.method = "average")
Raf_OA_MAG_fructan_hostglycan_data$host_glycan_rank <- max(Raf_OA_MAG_fructan_hostglycan_data$host_glycan_rank) + 1 -Raf_OA_MAG_fructan_hostglycan_data$host_glycan_rank

Raf_OA_MAG_fructan_hostglycan_data$fructan_rank <- rank(-Raf_OA_MAG_fructan_hostglycan_data$fructan, ties.method = "average")
Raf_OA_MAG_fructan_hostglycan_data$fructan_rank <- max(Raf_OA_MAG_fructan_hostglycan_data$fructan_rank) + 1 - Raf_OA_MAG_fructan_hostglycan_data$fructan_rank

head(Raf_OA_MAG_fructan_hostglycan_data)

write.csv(Raf_OA_MAG_fructan_hostglycan_data, "Raf_OA_MAG_fructan_hostglycan_Ranked.csv", row.names = FALSE)

####### profile of hostglycan degrading MAGs #####
Raf_OA_hostglycan_degrading_MAG_data <- read.csv("Raf_OA_MAG_hostglycan_profile.csv") %>%
  select(Sample_ID, Placebo_M0_OA05:Prebiotic_M6_OA39) %>%
  pivot_longer(cols=Placebo_M0_OA05:Prebiotic_M6_OA39, names_to = "Sample_Name", values_to = "Abundance") %>%
  separate(Sample_Name, into = c("Treatment", "Months", "ParticipantID"), sep = "_", remove = FALSE) %>%
  mutate(Group=paste(Treatment, Months, sep = "_"))

Raf_OA_hostglycan_degrading_MAG_annotation <- read.csv("Raf_OA_MAG_hostglycan_profile.csv") %>%
  select(Sample_ID:Category)

Raf_OA_hostglycan_degrading_MAG_with_annotation <-merge(Raf_OA_hostglycan_degrading_MAG_annotation,
                                                        Raf_OA_hostglycan_degrading_MAG_data,
                                                        by="Sample_ID")

Raf_OA_hostglycan_degrading_MAG_summary <- Raf_OA_hostglycan_degrading_MAG_with_annotation %>%
  group_by(ParticipantID, Category, Group) %>%
  dplyr::summarize(Sum_Abundance = sum(Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_summary_per_group <- Raf_OA_hostglycan_degrading_MAG_summary %>%
  group_by(Category, Group) %>%
  dplyr::summarize(Average_Sum_Abundance = mean(Sum_Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_Specialist_summary <- Raf_OA_hostglycan_degrading_MAG_summary %>%
  filter(Category %in% "Specialist") %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_summary <- Raf_OA_hostglycan_degrading_MAG_summary %>%
  filter(Category %in% "Generalist") %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)

Raf_OA_hostglycan_degrading_MAG_summary_wide <- Raf_OA_hostglycan_degrading_MAG_summary %>%
  pivot_wider(names_from = Category, values_from = Sum_Abundance)

Raf_OA_hostglycan_degrading_MAG_summary_wide <- Raf_OA_hostglycan_degrading_MAG_summary_wide %>%
  mutate(Ratio = Specialist / Generalist) %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)

view(Raf_OA_hostglycan_degrading_MAG_summary_wide)

###### stats on Specialist/Generalist summary
Raf_OA_hostglycan_degrading_MAG_Specialist_summary_lme <- lmer(Sum_Abundance ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Specialist_summary, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_summary_lme <- lmer(Sum_Abundance ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_summary, REML = FALSE)

summary(Raf_OA_hostglycan_degrading_MAG_Specialist_summary_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Generalist_summary_lme)

Raf_OA_hostglycan_degrading_MAG_Specialist_summary_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Specialist_summary_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_summary_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_summary_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Specialist_summary_memms
Raf_OA_hostglycan_degrading_MAG_Generalist_summary_memms

# Perform pairwise comparisons
Raf_OA_hostglycan_degrading_MAG_Specialist_summary_pairwise_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Specialist_summary_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_summary_pairwise_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_summary_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Specialist_summary_pairwise_comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_summary_pairwise_comparisons

dark_colors <- c("orange","darkgreen")

Raf_OA_hostglycan_degrading_MAG_sum_ggplot <-ggplot(Raf_OA_hostglycan_degrading_MAG_summary_per_group, 
       aes(x = Group, y = Average_Sum_Abundance, fill = Category)) +
  geom_bar(stat = "identity") +  
  labs(title = "Raf_OA_hostglycan_degrading_MAG_summary",
       x = "Time (Months)",
       y = "MAG Abundance (TPM)") +
  mytheme1+  # Use a clean theme
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = dark_colors)

Raf_OA_hostglycan_degrading_MAG_sum_ggplot

###### stats on Specialist/Generalist--phylum summary
Raf_OA_hostglycan_degrading_MAG_sum_per_sample <- Raf_OA_hostglycan_degrading_MAG_with_annotation %>%
  group_by(ParticipantID, Category, Phylum, Group,
           galactan, pectin, xylan, alpha.glucan,beta.glucan,fructan, host.glycan) %>%
  dplyr::summarize(Sum_Abundance = sum(Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_per_group <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample %>%
  group_by(Category, Phylum, Group,galactan, pectin, xylan, alpha.glucan,beta.glucan,fructan,host.glycan) %>%
  dplyr::summarize(Average_Sum_Abundance = mean(Sum_Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_Specialist_phylum_wide <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample %>%
  filter(Category %in% "Specialist")  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE) %>%
  pivot_wider(names_from = Phylum, values_from = Sum_Abundance)

Raf_OA_hostglycan_degrading_MAG_Generalist_phylum_wide <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample %>%
  filter(Category %in% "Generalist")  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)%>%
  pivot_wider(names_from = Phylum, values_from = Sum_Abundance)

###### stats on Specialist/Generalist--phylum summary
Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_lme <- lmer(Bacteroidota ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Specialist_phylum_wide, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_lme <- lmer(Firmicutes ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Specialist_phylum_wide, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_lme <- lmer(Verrucomicrobiota ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Specialist_phylum_wide, REML = FALSE)


Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_lme <- lmer(Bacteroidota ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_phylum_wide, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_lme <- lmer(Firmicutes ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_phylum_wide, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_lme <- lmer(Actinobacteriota ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_phylum_wide, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_lme <- lmer(Proteobacteria ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_phylum_wide, REML = FALSE)

summary(Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_lme)

summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_lme)

Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_memms
Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_memms
Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_memms

Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_memms
Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_memms
Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_memms
Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_memms

# Perform pairwise comparisons
Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_pairwise_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_pairwise_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Specialist_Bacteriodetes_pairwise_comparisons
Raf_OA_hostglycan_degrading_MAG_Specialist_Firmicutes_comparisons
Raf_OA_hostglycan_degrading_MAG_Specialist_Verrucomicrobiota_comparisons

Raf_OA_hostglycan_degrading_MAG_Generalist_Bacteriodetes_pairwise_comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_Firmicutes_comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_Actinobacteriota_comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_Proteobacteria_comparisons

#### Figures ####
dark_colors2 <- c("tomato2","steelblue","dimgrey")
dark_colors3 <- c("purple","tomato2", "steelblue","green", "pink", "burlywood4")

Raf_OA_hostglycan_degrading_MAG_Specialist <- Raf_OA_hostglycan_degrading_MAG_per_group %>%
  filter(Category %in% "Specialist")

Raf_OA_hostglycan_degrading_MAG_Generalist <- Raf_OA_hostglycan_degrading_MAG_per_group %>%
  filter(Category %in% "Generalist")

Raf_OA_hostglycan_degrading_MAG_Specialist_plot <- ggplot(Raf_OA_hostglycan_degrading_MAG_Specialist, 
       aes(x = Group, y = Average_Sum_Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +  
  labs(title = "Raf_OA_hostglycan_degrading_MAG_Specialist",
       x = "Time (Months)",
       y = "MAG Abundance (TPM)") +
  mytheme1+  # Use a clean theme
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = dark_colors2)

Raf_OA_hostglycan_degrading_MAG_Specialist_plot

Raf_OA_hostglycan_degrading_MAG_Generalist_plot <- ggplot(Raf_OA_hostglycan_degrading_MAG_Generalist, 
       aes(x = Group, y = Average_Sum_Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +  
  labs(title = "Raf_OA_hostglycan_degrading_MAG_Generalist",
       x = "Time (Months)",
       y = "MAG Abundance (TPM)") +
  mytheme1+  # Use a clean theme
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = dark_colors3)

Raf_OA_hostglycan_degrading_MAG_Generalist_plot

ggsave("Raf_OA_hostglycan_degrading_MAG_sum_ggplot.svg", 
       plot = Raf_OA_hostglycan_degrading_MAG_sum_ggplot, 
       device = "svg", 
       width = 2.5, height = 4, 
       units = "in")

ggsave("Raf_OA_hostglycan_degrading_MAG_Specialist_plot.svg", 
       plot = Raf_OA_hostglycan_degrading_MAG_Specialist_plot, 
       device = "svg", 
       width = 2.5, height = 4, 
       units = "in")

ggsave("Raf_OA_hostglycan_degrading_MAG_Generalist_plot.svg", 
       plot = Raf_OA_hostglycan_degrading_MAG_Generalist_plot, 
       device = "svg", 
       width = 3, height = 4, 
       units = "in")

###### MAG host glycan degrades --- Genus level ####
Raf_OA_hostglycan_degrading_MAG_sum_per_sample2 <- Raf_OA_hostglycan_degrading_MAG_with_annotation %>%
  group_by(ParticipantID, Category, Phylum, Genus, Group) %>%
  dplyr::summarize(Sum_Abundance = sum(Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_per_group2 <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample2 %>%
  group_by(Category, Phylum, Genus, Group) %>%
  dplyr::summarize(Average_Sum_Abundance = mean(Sum_Abundance, na.rm = TRUE), .groups = 'drop')

Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample2 %>%
  filter(Category ==  "Specialist")  %>%
  filter(Phylum == "Verrucomicrobiota")  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE) %>%
  pivot_wider(names_from = Genus, values_from = Sum_Abundance) 

# NO DIFFERENCE detected in phylum-level ratio SV/GF, SV/GB, SB/GB, SF/GF 
# Move to genus-level ratio
Raf_OA_hostglycan_degrading_MAG_Genus_4ratio <- Raf_OA_hostglycan_degrading_MAG_with_annotation %>%
  group_by(ParticipantID,Category, Group, Genus) %>%
  dplyr::summarize(Sum_Abundance = sum(Abundance, na.rm = TRUE), .groups = 'drop') %>%
  filter(Genus %in% c("Akkermansia",  "Roseburia"))  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE) %>%
  pivot_wider(names_from = Genus, values_from = Sum_Abundance)

write.csv(Raf_OA_hostglycan_degrading_MAG_Genus_4ratio,
          "Raf_OA_hostglycan_degrading_MAG_Genus_4ratio.csv")

Raf_OA_hostglycan_degrading_MAG_Genus_ratio <- read.csv ("Raf_OA_hostglycan_degrading_MAG_Genus_Calculated_ratio.csv")
str(Raf_OA_hostglycan_degrading_MAG_Genus_ratio)

Raf_OA_hostglycan_degrading_MAG_Genus_ratio_PRE <- Raf_OA_hostglycan_degrading_MAG_Genus_ratio %>%
  filter(Treatment ==  "Prebiotic") 
Raf_OA_hostglycan_degrading_MAG_Genus_ratio_Placebo <- Raf_OA_hostglycan_degrading_MAG_Genus_ratio %>%
  filter(Treatment ==  "Placebo") 

Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M0 <- Raf_OA_hostglycan_degrading_MAG_Genus_ratio %>%
  filter(Months ==  "M0") 
Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M3 <- Raf_OA_hostglycan_degrading_MAG_Genus_ratio %>%
  filter(Months ==  "M3") 
Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M6 <- Raf_OA_hostglycan_degrading_MAG_Genus_ratio %>%
  filter(Months ==  "M6")

kruskal.test(Ratio ~ Group, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio)
kruskal.test(Ratio ~ Months, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio_PRE)
kruskal.test(Ratio ~ Months, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio_Placebo)

kruskal.test(Ratio ~ Treatment, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M0)
kruskal.test(Ratio ~ Treatment, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M3)
kruskal.test(Ratio ~ Treatment, data = Raf_OA_hostglycan_degrading_MAG_Genus_ratio_M6)

Raf_OA_hostglycan_degrading_MAG_summary_wide <- Raf_OA_hostglycan_degrading_MAG_summary_wide %>%
  mutate(Ratio = Specialist / Generalist) %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)

Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_lme <- lmer(Akkermansia ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide, REML = FALSE)

summary(Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_lme)

Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_lme, ~ Treatment * Months)

# Perform pairwise comparisons
Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_pairwise_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Specialist_Akk_Genus_pairwise_comparisons


Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide$Group <- factor(Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide$Group, 
                                            levels = c('Placebo_M0','Prebiotic_M0',
                                                       'Placebo_M3','Prebiotic_M3',
                                                       'Placebo_M6','Prebiotic_M6'))

Raf_MAG_Specialist_Akk_Genus_plot <- ggplot(Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide, 
                       aes(x = Months, y = Akkermansia, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey","#FFA07A", "dimgrey",
                               "tomato","black", "red")) +
  ylab("Host Glycan Specialist Akk_Genus \nLog2(TPM)") +
  xlab("Time (Month)") +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_hostglycan_degrading_MAG_Specialist_Genus_wide$Months)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_MAG_Specialist_Akk_Genus_plot

ggsave("Raf_OA_Hostglycan_Specialist_Akk_Genus_plot.svg", 
       plot = Raf_MAG_Specialist_Akk_Genus_plot, 
       device = "svg", 
       width = 2.5, height = 2, 
       units = "in")

Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample2 %>%
  filter(Category %in% "Generalist")  %>%
  filter(Phylum %in% c("Actinobacteriota"))  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)%>%
  pivot_wider(names_from = Genus, values_from = Sum_Abundance)

str(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A)

Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_lme <- lmer(Bifidobacterium ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A, REML = FALSE)

Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_lme <- lmer(Collinsella ~ Treatment * Months + (1 | ParticipantID), 
                          data = Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A, REML = FALSE)

summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_lme)
summary(Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_lme)

Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_lme, ~ Treatment * Months)

Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_memms <- emmeans(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_lme, ~ Treatment * Months)

# Perform pairwise comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_comparisons <- contrast(
  Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_memms, interaction = "pairwise", simple = "each")

Raf_OA_hostglycan_degrading_MAG_Generalist_Bifido_Genus_comparisons
Raf_OA_hostglycan_degrading_MAG_Generalist_Collinsella_Genus_comparisons


Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A$Group <- factor(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A$Group, 
                                            levels = c('Placebo_M0','Prebiotic_M0',
                                                       'Placebo_M3','Prebiotic_M3',
                                                       'Placebo_M6','Prebiotic_M6'))

Raf_MAG_Generalist_Collinsella_Genus_plot <- ggplot(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A, 
                       aes(x = Months, y = Collinsella, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey","#FFA07A", "dimgrey",
                               "tomato","black", "red")) +
  ylab("Host Glycan Specialist Collinsella_Genus \nLog2(TPM)") +
  xlab("Time (Month)") +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_A$Months)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_MAG_Generalist_Collinsella_Genus_plot

ggsave("Raf_OA_Hostglycan_Generalist_Collinsella_Genus_plot.svg", 
       plot = Raf_MAG_Generalist_Collinsella_Genus_plot, 
       device = "svg", 
       width = 2.5, height = 2, 
       units = "in")

str(Raf_OA_hostglycan_degrading_MAG_with_annotation)

Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F <- Raf_OA_hostglycan_degrading_MAG_sum_per_sample2 %>%
  filter(Category %in% "Generalist")  %>%
  filter(Phylum %in% c("Firmicutes"))  %>%
  separate(Group, into = c("Treatment", "Months"), sep = "_", remove = FALSE)%>%
  pivot_wider(names_from = Genus, values_from = Sum_Abundance)

str(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F)



Raf_OA_hostglycan_degrading_MAG_sum_per_sample_cazy <- Raf_OA_hostglycan_degrading_MAG_with_annotation %>%
  group_by(ParticipantID, Category, Phylum, Genus, Group, galactan, pectin,xylan,
           alpha.glucan,host.glycan,fructan) %>%
  dplyr::summarize(Sum_Abundance = sum(Abundance, na.rm = TRUE), .groups = 'drop')

Generalist_Firmicutes_genus <- c("Agathobacter", "Anaerostipes", "Bariatricus", "Blautia", 
                 "Faecalibacterium", "Fusicatenibacter", "Roseburia", 
                 "Ruminococcus_D", "Eisenbergiella", "Enterocloster", 
                 "Eubacterium_I", "Faecousia", "Fusicatenibacter", 
                 "Gemmiger", "KLE1615", "Lachnospira", "Mediterraneibacter", 
                 "Roseburia", "Ruminococcus_B", "Ruthenibacterium")

lme_models <- list()
emmeans_results <- list()
comparisons_results <- list()

# Loop over each genus in the list
for (genus in Generalist_Firmicutes_genus) {
  formula <- as.formula(paste(genus, "~ Treatment * Months + (1 | ParticipantID)"))
  lme_model <- lmer(formula, data = Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F, REML = FALSE)
  lme_models[[genus]] <- summary(lme_model)
  emmeans_model <- emmeans(lme_model, ~ Treatment * Months)
  emmeans_results[[genus]] <- emmeans_model
  genus_comparisons <- contrast(emmeans_model, interaction = "pairwise", simple = "each")
  comparisons_results[[genus]] <- genus_comparisons
}

lme_model_results <- data.frame()
for (genus in Generalist_Firmicutes_genus) {
  lme_model_results <- rbind(lme_model_results, 
                             data.frame(Genus = genus, 
                                        Model_Summary = paste(capture.output(lme_models[[genus]]), collapse = "\n")))
}

emmeans_results_df <- data.frame()
for (genus in Generalist_Firmicutes_genus) {
  emmeans_results_df <- rbind(emmeans_results_df, 
                              data.frame(Genus = genus, 
                                         EMM_Results = paste(capture.output(emmeans_results[[genus]]), collapse = "\n")))
}

comparisons_results_df <- data.frame()
for (genus in Generalist_Firmicutes_genus) {
  comparisons_results_df <- rbind(comparisons_results_df, 
                                   data.frame(Genus = genus, 
                                              Comparisons_Results = paste(capture.output(comparisons_results[[genus]]), collapse = "\n")))
}

# Save the results as CSV files
write.csv(lme_model_results, "Raf_OA_hostglycan_degrading_Generalist_Genus_Firmicutes_LME.csv", row.names = FALSE)
write.csv(emmeans_results_df, "Raf_OA_hostglycan_degrading_Generalist_Genus_Firmicutes_EMMeans.csv", row.names = FALSE)
write.csv(comparisons_results_df, "Raf_OA_hostglycan_degrading_Generalist_Genus_Firmicutes_Pairwise_Comparisons.csv", row.names = FALSE)

# General Firmicutes list #### 
Generalist_Firmicutes_genus_sig <- c( "Roseburia", "Gemmiger")


Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F$Group <- factor(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F$Group, 
                                            levels = c('Placebo_M0','Prebiotic_M0',
                                                       'Placebo_M3','Prebiotic_M3',
                                                       'Placebo_M6','Prebiotic_M6'))

Raf_Generalist_Firmicutes_genus_Roseburia <- ggplot(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F, 
                       aes(x = Months, y = Roseburia, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey","#FFA07A", "dimgrey",
                               "tomato","black", "red")) +
  ylab("Host Glycan Specialist Collinsella_Genus \nLog2(TPM)") +
  xlab("Time (Month)") +
  ylim(c(0,21000)) +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F$Months)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)

Raf_Generalist_Firmicutes_genus_Gemmiger <- ggplot(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F, 
                       aes(x = Months, y = Gemmiger, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey","#FFA07A", "dimgrey",
                               "tomato","black", "red")) +
  ylab("Host Glycan Specialist Collinsella_Genus \nLog2(TPM)") +
  xlab("Time (Month)") +
  mytheme3 + 
  geom_vline(xintercept = seq(1.5, length(unique(Raf_OA_hostglycan_degrading_MAG_Generalist_Genus_wide_F$Months)) - 0.5, by = 1), 
             linetype = "dashed", color = "grey", size = 0.3)


Raf_Generalist_Firmicutes_genus_Roseburia
Raf_Generalist_Firmicutes_genus_Gemmiger

ggsave("Raf_OA_Hostglycan_Generalist_Firmicutes_genus_Roseburia_plot.svg", 
       plot = Raf_Generalist_Firmicutes_genus_Roseburia, 
       device = "svg", 
       width = 2.5, height = 2, 
       units = "in")

ggsave("Raf_OA_Hostglycan_Generalist_Firmicutes_genus_Gemmiger_plot.svg", 
       plot = Raf_Generalist_Firmicutes_genus_Gemmiger, 
       device = "svg", 
       width = 2.5, height = 2, 
       units = "in")

```


```{r Figure 5B-C. HUMaNAn3 Bile Acid & Butyrate production pathways}
Raf_OA_Bile_acid_pathway_Total <- read.csv("Raf_OA_Bile_Acids_Genes_total.csv")
str(Raf_OA_Bile_acid_pathway_Total)

Raf_OA_Bile_acid_pathway_with_phenotypes_Total <- merge(Raf_OA_Bile_acid_pathway_Total ,
                                                 Raf_OA_phenotype_data_outlier_filtered,
                                                 by= "SampleID") 

average_per_group <- Raf_OA_Bile_acid_pathway_with_phenotypes_Total %>%
  group_by(Group) %>%
  dplyr::summarize(Average_Sum_BA_Abundance = mean(BSH, na.rm = TRUE), .groups = 'drop')

BSH_lme <- lmer(BSH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
X12aHSDH_lme <- lmer(X12aHSDH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
X7aHSDH_lme <- lmer(X7aHSDH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
X7bHSDH_lme <- lmer(X7bHSDH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
X3aHSDH_lme <- lmer(X3aHSDH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
X3bHSDH_lme <- lmer(X3bHSDH ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
BaiA_lme <- lmer(BaiA ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
BaiB_lme <- lmer(BaiB ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
BaiCD_lme <- lmer(BaiCD ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
BaiF_lme <- lmer(BaiF ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)
BaiE_lme <- lmer(BaiE ~ Diets * Months + (1 | Participant), 
                             data = Raf_OA_Bile_acid_pathway_with_phenotypes_Total, REML = FALSE)

BSH_emms <- emmeans(BSH_lme, ~ Diets * Months)
X12aHSDH_emms <- emmeans(X12aHSDH_lme, ~ Diets * Months)
X7aHSDH_emms <- emmeans(X7aHSDH_lme, ~ Diets * Months)
X7bHSDH_emms <- emmeans(X7bHSDH_lme, ~ Diets * Months)
X3aHSDH_emms <- emmeans(X3aHSDH_lme, ~ Diets * Months)
X3bHSDH_emms <- emmeans(X3bHSDH_lme, ~ Diets * Months)
BaiA_emms <- emmeans(BaiA_lme, ~ Diets * Months)
BaiB_emms <- emmeans(BaiB_lme, ~ Diets * Months)
BaiCD_emms <- emmeans(BaiCD_lme, ~ Diets * Months)
BaiF_emms <- emmeans(BaiF_lme, ~ Diets * Months)
BaiE_emms <- emmeans(BaiE_lme, ~ Diets * Months)

BSH_comparisons <- contrast(BSH_emms, interaction = "pairwise", simple = "each")
X12aHSDH_comparisons <- contrast(X12aHSDH_emms, interaction = "pairwise", simple = "each")
X7aHSDH_comparisons <- contrast(X7aHSDH_emms, interaction = "pairwise", simple = "each")
X7bHSDH_comparisons <- contrast(X7bHSDH_emms, interaction = "pairwise", simple = "each")
X3aHSDH_comparisons <- contrast(X3aHSDH_emms, interaction = "pairwise", simple = "each")
X3bHSDH_comparisons <- contrast(X3bHSDH_emms, interaction = "pairwise", simple = "each")
BaiA_comparisons <- contrast(BaiA_emms, interaction = "pairwise", simple = "each")
BaiB_comparisons <- contrast(BaiB_emms, interaction = "pairwise", simple = "each")
BaiCD_comparisons <- contrast(BaiCD_emms, interaction = "pairwise", simple = "each")
BaiF_comparisons <- contrast(BaiF_emms, interaction = "pairwise", simple = "each")
BaiE_comparisons <- contrast(BaiE_emms, interaction = "pairwise", simple = "each")

summary(BSH_comparisons)
summary(X12aHSDH_comparisons)
summary(X7aHSDH_comparisons)
summary(X7bHSDH_comparisons)
summary(X3aHSDH_comparisons)
summary(X3bHSDH_comparisons)
summary(BaiA_comparisons)
summary(BaiB_comparisons)
summary(BaiCD_comparisons)
summary(BaiF_comparisons)
summary(BaiE_comparisons)


Raf_OA_Bile_acid_pathway_Total_long <- Raf_OA_Bile_acid_pathway_Total %>%
  pivot_longer(cols = BSH:BaiE,   
               names_to = "BA_Gene",     
               values_to = "BA_Abundance") 

Raf_OA_Bile_acid_pathway_with_phenotypes_long <-merge(Raf_OA_Bile_acid_pathway_Total_long,
                                                 Raf_OA_phenotype_data_outlier_filtered,
                                                 by= "SampleID") 

Raf_OA_Bile_acid_pathway_species_long <- read.csv("Raf_OA_Bile_Acids_Genes.csv") %>% 
  pivot_longer(cols = BSH_Alistipes:BaiE_unclassified,
               names_to = "BA_Genus",
               values_to = "BA_Abundance")

Raf_OA_Bile_acid_pathway_species_long_with_phenotypes <- merge(Raf_OA_Bile_acid_pathway_species_long,
                                                 Raf_OA_phenotype_data_outlier_filtered,
                                                 by= "SampleID") 

Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2 <-read.csv("Raf_OA_Bile_acid_pathway_species_long_metadata_added.csv")

view(Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2)

sum_per_sample <- Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2 %>%
  group_by(Genes, SampleID, Group, Genus, Sepcies) %>%
  dplyr::summarize(Sum_BA_Abundance = sum(BA_Abundance, na.rm = TRUE), .groups = 'drop')

average_per_group <- sum_per_sample %>%
  group_by(Genes, Group, Genus, Sepcies) %>%
  dplyr::summarize(
    Average_Sum_BA_Abundance = mean(Sum_BA_Abundance, na.rm = TRUE),
    SEM_Sum_BA_Abundance = sd(Sum_BA_Abundance, na.rm = TRUE) / sqrt(n()),  .groups = 'drop')

view(average_per_group)

write.csv(average_per_group, "Raf_OA_Bile_Acids_metbaolism_genes.csv")

dark_colors <- c(
   "darkcyan","darkblue","darkgreen","darkmagenta","purple",
  "burlywood4", "lightgreen", "lightblue", "lightyellow", "tomato2", "red","yellow", "steelblue",
  "darkred","#444444", "deepskyblue1", "khaki4", "aquamarine1", "firebrick4", "darkkhaki", "green",  "pink",
  "orange", "blue", "chocolate","cornsilk4",  "deeppink", "azure3", "steelblue",   
  "black",  "darkslategray2", "cyan2","dimgrey","grey"
)

Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Genes <-as.factor(Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Genes)
Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Group <-as.factor(Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Group)
Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Genus <-as.factor(Raf_OA_Bile_acid_pathway_species_long_with_phenotypes2$Genus)

Raf_OA_Bile_acid_pathway_species_ggplot <-ggplot(average_per_group, 
       aes(x = Group, y = Average_Sum_BA_Abundance, fill = Genus)) +
  geom_bar(stat = "identity") +  
  facet_wrap(~ Genes, scales = "free_y") +
  labs(title = "Secondary Bile Acids Metabolism Pathway",
       x = "Time (Months)",
       y = "Gene Abundance (CPM)") +
  mytheme1+  # Use a clean theme
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = dark_colors)

Raf_OA_Bile_acid_pathway_species_ggplot

ggsave("af_OA_Bile_acid_pathway_species_ggplot.svg", 
       plot = Raf_OA_Bile_acid_pathway_species_ggplot, 
       device = "svg", 
       width = 12, height = 15, 
       units = "in")


Raf_OA_HuMaNA3_Butyrate_pathway_unstratified <- read.csv("Raf_OA_HuMaNn3_Butyrate_pathways.csv") %>% 
  select(SampleID, CENTFERM.PWY..pyruvate.fermentation.to.butanoate:PWY.5677..succinate.fermentation.to.butanoate)

Raf_OA_HuMaNA3_Butyrate_pathway_species <- read.csv("Raf_OA_HuMaNn3_Butyrate_pathways.csv") %>% 
  select(-c(CENTFERM.PWY..pyruvate.fermentation.to.butanoate:PWY.5677..succinate.fermentation.to.butanoate))


Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes <-merge(Raf_OA_HuMaNA3_Butyrate_pathway_unstratified,
                                                        Raf_OA_phenotype_data_outlier_filtered,
                                                        by= "SampleID") 

Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes <-merge(Raf_OA_HuMaNA3_Butyrate_pathway_species,
                                                        Raf_OA_phenotype_data_outlier_filtered,
                                                        by= "SampleID") 

###### Stats with lme #####
PWY5676_butyrate_lme <- lmer(PWY.5676..acetyl.CoA.fermentation.to.butanoate.II ~ Diets * Months + (1 | Participant), data = Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes, REML = FALSE)
Anaerostipes_hadrus_butyrate_lme <- lmer(PWY.5676..acetyl.CoA.fermentation.to.butanoate.II.g__Anaerostipes.s__Anaerostipes_hadrus ~ Diets * Months + (1 | Participant), 
                                         data = Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes, REML = FALSE)

PWY5676_butyrate_emms <- emmeans(PWY5676_butyrate_lme, ~ Diets * Months)
Anaerostipes_hadrus_butyrate_emms <- emmeans(Anaerostipes_hadrus_butyrate_lme, ~ Diets * Months)

PWY5676_butyrate_comparisons <- contrast(PWY5676_butyrate_emms, interaction = "pairwise", simple = "each")
Anaerostipes_hadrus_butyrate_comparisons <- contrast(Anaerostipes_hadrus_butyrate_emms, interaction = "pairwise", simple = "each")

summary(PWY5676_butyrate_comparisons)
summary(Anaerostipes_hadrus_butyrate_comparisons)
write.csv(Anaerostipes_hadrus_butyrate_comparisons, "Anaerostipes_hadrus_butyrate_comparisons.csv")

Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes %>%
   pivot_longer(
     cols = PWY.5676..acetyl.CoA.fermentation.to.butanoate.II.g__Anaerostipes.s__Anaerostipes_hadrus:
       PWY.5676..acetyl.CoA.fermentation.to.butanoate.II.unclassified,
     names_to = "Butyrate_Pathways",
     values_to = "Pathway_Abundance") 

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes %>%
   pivot_longer(
     cols = CENTFERM.PWY..pyruvate.fermentation.to.butanoate:PWY.5677..succinate.fermentation.to.butanoate,
     names_to = "Butyrate_Pathways",
     values_to = "Pathway_Abundance") 


Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes$Group <- factor(Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes$Group, 
                                                                levels = c('Placebo_M0', 'Prebiotic_M0',
                                                                           'Placebo_M3','Prebiotic_M3', 
                                                                           'Placebo_M6', 'Prebiotic_M6')) 

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes$Group <- factor(Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes$Group, 
                                                                levels = c('Placebo_M0', 'Prebiotic_M0',
                                                                           'Placebo_M3','Prebiotic_M3', 
                                                                           'Placebo_M6', 'Prebiotic_M6')) 

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes %>%
  mutate(Butyrate_Pathways = as.factor(Butyrate_Pathways))
Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes %>%
  mutate(Butyrate_Pathways = as.factor(Butyrate_Pathways))

Butyrate_pathway_unstratified_average <- Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes %>%
  group_by(Butyrate_Pathways) %>%
  dplyr::summarize(Butyrate_avg_abundance = mean(Pathway_Abundance, na.rm = TRUE))
Butyrate_pathway_species_average <- Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes %>%
  group_by(Butyrate_Pathways) %>%
  dplyr::summarize(Butyrate_avg_abundance = mean(Pathway_Abundance, na.rm = TRUE))

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes %>%
  left_join(Butyrate_pathway_unstratified_average, by = "Butyrate_Pathways")
Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes %>%
  left_join(Butyrate_pathway_species_average, by = "Butyrate_Pathways")

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes %>%
  mutate(Butyrate_Pathways = factor(Butyrate_Pathways, levels = Butyrate_pathway_unstratified_average$Butyrate_Pathways[order(-Butyrate_pathway_unstratified_average$Butyrate_avg_abundance)]))

Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes <- Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes %>%
  mutate(Butyrate_Pathways = factor(Butyrate_Pathways, levels = Butyrate_pathway_species_average$Butyrate_Pathways[order(-Butyrate_pathway_species_average$Butyrate_avg_abundance)]))

Raf_OA_HuMaNA3_Butyrate_pathway_species_plot <- ggplot(Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes, 
                       aes(x = Butyrate_Pathways, y=Pathway_Abundance, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A","dimgrey","tomato","black","red")) +
  ylab("HuMaMn3 Abundance-CPM") +
  xlab("Time (Month)") +
  mytheme2 + 
  geom_vline(xintercept = seq(1.5, length(
    unique(Raf_OA_HuMaNA3_Butyrate_pathway_species_with_phenotypes$Butyrate_Pathways)
    ) - 0.5, by = 1), linetype = "dashed", color = "grey", size = 0.3) +
  coord_flip()

Raf_OA_HuMaNA3_Butyrate_pathway_species_plot 


Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_plot <- ggplot(Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes, 
                       aes(x = Butyrate_Pathways, y=Pathway_Abundance, fill = Group)) +
  stat_boxplot(geom ='errorbar') + 
  geom_boxplot(alpha = 1) +
  geom_point(position = position_jitterdodge(jitter.width = 0.10, dodge.width = 0.75), 
             size = 2, color = "black", shape = 21) +
  scale_fill_manual(values = c("grey", "#FFA07A","dimgrey","tomato","black","red")) +
  ylab("HuMaMn3 Abundance-CPM") +
  xlab("Time (Month)") +
  mytheme2 + 
  geom_vline(xintercept = seq(1.5, length(
    unique(Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_with_phenotypes$Butyrate_Pathways)
    ) - 0.5, by = 1), linetype = "dashed", color = "grey", size = 0.3) +
  coord_flip()

Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_plot 

Raf_OA_HuMaNA3_Butyrate_pathway_plot_combined <-grid.arrange(
  Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_plot,
  Raf_OA_HuMaNA3_Butyrate_pathway_species_plot,
  ncol = 1
)

ggsave("Raf_OA_HuMaNA3_Butyrate_pathway_plot.svg", 
       plot = Raf_OA_HuMaNA3_Butyrate_pathway_unstratified_plot, 
       device = "svg", 
       width = 8, height = 6, 
       units = "in")

```



```{r Figure 6. MOFA2ï¼Multi-Omics Factorial Analysis}
library(MOFA2)
# Set up MOFA2 analysis with proper group/time design and downstream outcome modeling
dir.create("Raf_OA_Multiomics", showWarnings = FALSE)
OutputDirectory <- "Raf_OA_Multiomics"

# Load and process input data
Raf_OA_MetaPhlan_metadata <- read.csv("Raf_OA_phenotypes.csv", header = TRUE, row.names = 1)
str(Raf_OA_MetaPhlan_metadata)

Raf_OA_MetaPhlan_species <- read.delim("Raf_OA_metaphlan_merged_abundance_table_species.txt", 
                                       header = TRUE, row.names = 1) 
Raf_OA_HuMaNn3_Pathway_CPM <- read.delim("Raf_OA_humann_pathabundance_cpm_normalized_unstratified.tsv", 
                                         header = TRUE, row.names = 1)

colnames(Raf_OA_HuMaNn3_Pathway_CPM) <- gsub("_paired_Abundance.CPM$", "", colnames(Raf_OA_HuMaNn3_Pathway_CPM))
colnames(Raf_OA_MetaPhlan_species) <- gsub("d_metagenome$", "", colnames(Raf_OA_MetaPhlan_species))

Raf_OA_MetaPhlan_data_transposed <- as.data.frame(t(Raf_OA_MetaPhlan_species))
str(Raf_OA_MetaPhlan_data_transposed)
Raf_OA_HuMaNn3_Pathway_CPM_transposed <- as.data.frame(t(Raf_OA_HuMaNn3_Pathway_CPM))

Raf_OA_PUL_Contig_data <- read.csv("Raf_Summarized_PUL_Data.csv", header = TRUE, row.names = 1) %>%
  select(-c(Participant, Group, Treatment, Time))

Raf_OA_Metabolites_intensity_data <- read.csv("Raf_metabolites_quality_control_Filtered_Intensity_Data_MOFA2.csv", header = TRUE) 

Raf_OA_CGC_Substrate_data <- read.csv("Combined_CGC_substrate_abund_for_network.csv") %>%
  filter(!CGC_Substrate %in% "humanmilkpolysaccharide")

Raf_OA_Metagemoics_combined_data1 <- merge(
  Raf_OA_MetaPhlan_data_transposed,
  Raf_OA_HuMaNn3_Pathway_CPM_transposed,
  by = "row.names", all = TRUE
) %>%
  column_to_rownames("Row.names")

Raf_OA_Metagemoics_combined_data2 <- merge(
  Raf_OA_Metagemoics_combined_data1,
  Raf_OA_MetaPhlan_metadata,
  by = "row.names", all = TRUE
) %>%
  column_to_rownames("Row.names")

Raf_OA_Metagemoics_combined_data3 <- merge(
  Raf_OA_Metagemoics_combined_data2,
  Raf_OA_PUL_Contig_data,
  by = "Sample_Name", all = TRUE)

Raf_OA_Metagemoics_combined_data4 <- merge(
  Raf_OA_Metagemoics_combined_data3,
  Raf_OA_Metabolites_intensity_data,
  by = "Sample_Name", all = TRUE)

Raf_OA_Metagemoics_combined_data <- merge(
  Raf_OA_Metagemoics_combined_data4,
  Raf_OA_CGC_Substrate_data,
  by = "Sample_Name", all = TRUE)

Raf_OA_Metagemoics_combined_data <- Raf_OA_Metagemoics_combined_data %>%
  mutate(Diets = as.factor(Diets),
         Months_numeric = case_when(
           Months == "M0" ~ 0,
           Months == "M3" ~ 3,
           Months == "M6" ~ 6
         ))%>%
  select(-UNMAPPED, -UNINTEGRATED)

# Preprocess + reshape per view
library(caret)
cytokine_names <- colnames(Raf_OA_Metagemoics_combined_data[1763:1772])
All_Species <- colnames(Raf_OA_Metagemoics_combined_data[2:1279])
All_HUMAnN3_pathways <- colnames(Raf_OA_Metagemoics_combined_data[1280:1749])      
All_PULs <- colnames(Raf_OA_Metagemoics_combined_data[1784:2152]) 
Metabolites_names <- colnames(Raf_OA_Metagemoics_combined_data[2153:2209])
CGC_voted_substrates <- colnames(Raf_OA_Metagemoics_combined_data[2210:2244])
SCFA_names <- colnames(Raf_OA_Metagemoics_combined_data[1773:1778])

# check if the col names are correct
print(Metabolites_names)
print(CGC_voted_substrates)
print(cytokine_names)
print(All_Species)
print(All_PULs)
print(SCFA_names)
print(All_HUMAnN3_pathways)

pp_Cytokine <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(cytokine_names)], method = c("center", "scale", "medianImpute"))
pp_All_Species <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(All_Species)], method = c("center", "scale", "medianImpute"))
pp_All_HUMAnN3 <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(All_HUMAnN3_pathways)], method = c("center", "scale", "medianImpute"))
pp_Metabolites <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(Metabolites_names)], method = c("center", "scale", "medianImpute"))
pp_CGC <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(CGC_voted_substrates)], method = c("center", "scale", "medianImpute"))
pp_All_PULs <- caret::preProcess(Raf_OA_Metagemoics_combined_data[c(All_PULs)], method = c("center", "scale", "medianImpute"))


Cytokine_data <- stats::predict(pp_Cytokine, newdata = Raf_OA_Metagemoics_combined_data[c(cytokine_names,"Sample_Name")])
All_Species_data <- stats::predict(pp_All_Species, newdata = Raf_OA_Metagemoics_combined_data[c(All_Species,"Sample_Name")])
HUMAnN3_data <- stats::predict(pp_All_HUMAnN3, newdata = Raf_OA_Metagemoics_combined_data[c(All_HUMAnN3_pathways,"Sample_Name")])
Metabolites_data <- stats::predict(pp_Metabolites, newdata = Raf_OA_Metagemoics_combined_data[c(Metabolites_names,"Sample_Name")])
CGC_data <- stats::predict(pp_CGC, newdata = Raf_OA_Metagemoics_combined_data[c(CGC_voted_substrates,"Sample_Name")])
PULs_data <- stats::predict(pp_All_PULs, newdata = Raf_OA_Metagemoics_combined_data[c(All_PULs,"Sample_Name")])


Cytokine_data <- Cytokine_data %>% relocate(Sample_Name)
All_Species_data <- All_Species_data %>% relocate(Sample_Name)
HUMAnN3_data <- HUMAnN3_data %>% relocate(Sample_Name)
Metabolites_data <- Metabolites_data %>% relocate(Sample_Name)
CGC_data <- CGC_data %>% relocate(Sample_Name)
PULs_data <- PULs_data %>% relocate(Sample_Name)


dat2a <-data.frame(Cytokine_data[,c(1)], stack(Cytokine_data[2:ncol(Cytokine_data)]))
dat2a$view <- "Cytokine"
colnames(dat2a)[1] <- "sample"
colnames(dat2a)[2] <- "value"
colnames(dat2a)[3] <- "feature"

dat2b <-data.frame(All_Species_data [,c(1)], stack(All_Species_data[2:ncol(All_Species_data)]))
dat2b$view <- "MetaPhlAn4"
colnames(dat2b)[1] <- "sample"
colnames(dat2b)[2] <- "value"
colnames(dat2b)[3] <- "feature"

dat2c <-data.frame(HUMAnN3_data[,c(1)], stack(HUMAnN3_data[2:ncol(HUMAnN3_data)]))
dat2c$view <- "HUMAnN3"
colnames(dat2c)[1] <- "sample"
colnames(dat2c)[2] <- "value"
colnames(dat2c)[3] <- "feature"

dat2d <-data.frame(Metabolites_data[,c(1)], stack(Metabolites_data[2:ncol(Metabolites_data)]))
dat2d$view <- "Metabolites"
colnames(dat2d)[1] <- "sample"
colnames(dat2d)[2] <- "value"
colnames(dat2d)[3] <- "feature"

dat2e <-data.frame(CGC_data[,c(1)], stack(CGC_data[2:ncol(CGC_data)]))
dat2e$view <- "CGC"
colnames(dat2e)[1] <- "sample"
colnames(dat2e)[2] <- "value"
colnames(dat2e)[3] <- "feature"

dat2f <-data.frame(PULs_data[,c(1)], stack(PULs_data[2:ncol(PULs_data)]))
dat2f$view <- "PULs"
colnames(dat2f)[1] <- "sample"
colnames(dat2f)[2] <- "value"
colnames(dat2f)[3] <- "feature"


# Combine into one MOFA2-ready long table
Raf_OA_MOFA2_dt <- rbind(dat2a, dat2b, dat2c, dat2d, dat2e, dat2f)

# Add group info (tied to sample)
Raf_OA_MOFA2_dt <- Raf_OA_MOFA2_dt %>%
  left_join(Raf_OA_Metagemoics_combined_data[, c("Sample_Name", "Diets")], by = c("sample" = "Sample_Name")) %>%
  dplyr::rename(group = Diets)

Raf_OA_MOFA2_dt$feature <- as.character(Raf_OA_MOFA2_dt$feature)

ggdensity(Raf_OA_MOFA2_dt, 
          x = "value", 
          fill = "group", 
          color = "group", 
          alpha = 0.4) +
  facet_wrap(~view + group, nrow = 2, scales = "free") +
  theme_minimal()
ggsave("density_distribution.png", plot = last_plot(), path = OutputDirectory, width = 11, height = 7)

##### Create MOFA ######## 
Raf_OA_MOFA2 <- create_mofa(Raf_OA_MOFA2_dt)
print(Raf_OA_MOFA2)

# Subset metadata based on sample names in MOFA model
Raf_OA_MOFA2_metadata <- Raf_OA_MetaPhlan_metadata[
  match(Raf_OA_MOFA2@samples_metadata$sample, Raf_OA_MetaPhlan_metadata$Sample_Name),
]

Raf_OA_MOFA2_metadata$group <- Raf_OA_Metagemoics_combined_data$Diets[
  match(Raf_OA_MOFA2_metadata$Sample_Name, Raf_OA_Metagemoics_combined_data$Sample_Name)
]

colnames(Raf_OA_MOFA2_metadata)[1] <- "sample"

Raf_OA_MOFA2_metadata$Months_numeric <- dplyr::case_when(
  Raf_OA_MOFA2_metadata$Months == "M0" ~ 0,
  Raf_OA_MOFA2_metadata$Months == "M3" ~ 3,
  Raf_OA_MOFA2_metadata$Months == "M6" ~ 6
)

samples_metadata(Raf_OA_MOFA2) <- Raf_OA_MOFA2_metadata
print(Raf_OA_MOFA2)

# Set up MOFA + MEFISTO options
data_opts <- get_default_data_options(Raf_OA_MOFA2)
data_opts$scale_views <- T
head(data_opts)

model_opts <- get_default_model_options(Raf_OA_MOFA2)
model_opts$num_factors <- 2
head(model_opts)

train_opts <- get_default_training_options(Raf_OA_MOFA2)
train_opts$seed <- 813496
train_opts$convergence_mode <- "fast"
train_opts$maxiter <- 5000
train_opts$stochastic <- TRUE
head(train_opts)

mefisto_opts <- get_default_mefisto_options(Raf_OA_MOFA2)
mefisto_opts$time <- "Months_numeric"
mefisto_opts$n_grid <- 15
mefisto_opts$start_opt <- 20
mefisto_opts$opt_freq <- 25
mefisto_opts$warping <- TRUE
mefisto_opts$model_groups <- TRUE
print(mefisto_opts)

stochastic_opts <- get_default_stochastic_options(Raf_OA_MOFA2)
head(stochastic_opts)

# Prepare and Train the Model
Raf_OA_MOFA2 <- prepare_mofa(
  object = Raf_OA_MOFA2,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts,
  mefisto_options = mefisto_opts,
  stochastic_options = stochastic_opts  
)

library(reticulate)
library(MOFA2)

conda_create("RAF_OA_MOFA2")
use_condaenv(condaenv = 'RAF_OA_MOFA2', required = TRUE)
outfile = file.path(OutputDirectory,"Raf_OA_MOFA2.hdf5")
Raf_OA_MOFA2 <- run_mofa(Raf_OA_MOFA2, outfile, use_basilisk = TRUE)

######## Downstream Analysis with trained MOFA2 ######## 
num_factors <- Raf_OA_MOFA2@dimensions$K
print(num_factors)

sample_metadata <- samples_metadata(Raf_OA_MOFA2)
print(colnames(sample_metadata))

plot_factors(Raf_OA_MOFA2,
             factors = 1:min(5, num_factors),  # Adjusting to the available number of factors
             color_by = "group"
)
ggsave("factors_Diet.png", plot = last_plot(), path = OutputDirectory, width = 8, height = 7)

# Variance decomposition
Raf_OA_MOFA2_factors <- get_factors(Raf_OA_MOFA2)
head(Raf_OA_MOFA2_factors)

Raf_OA_MOFA2_variance_explained <- get_variance_explained(Raf_OA_MOFA2)
Raf_OA_MOFA2_variance_explained_df <- as.data.frame(Raf_OA_MOFA2_variance_explained)
write.csv(Raf_OA_MOFA2_variance_explained_df, "Raf_OA_MOFA2_variance_explained.csv", row.names = FALSE)

plot_variance_explained(Raf_OA_MOFA2, plot_total = T)[[2]]
ggsave("variance_explained.png", plot = last_plot(), path = OutputDirectory)

plot_variance_explained(Raf_OA_MOFA2, max_r2=25)
ggsave("variance_explained_factors2.svg", plot = last_plot(), path = OutputDirectory)

#cumulative variance explained by view
r2 <- Raf_OA_MOFA2@cache$variance_explained$r2_per_factor
r2.dt <- r2 %>%
  as.data.table %>% .[,factor:=as.factor(1:Raf_OA_MOFA2@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2")

write.csv(r2.dt, "Raf_OA_MOFA2_variance_explained.csv", row.names = FALSE)

r2_placebo <- Raf_OA_MOFA2@cache$variance_explained$r2_per_factor[[1]]
r2_prebiotic <- Raf_OA_MOFA2@cache$variance_explained$r2_per_factor[[2]]
r2_placebo
r2_prebiotic

r2_placebo.dt <- r2_placebo %>%
  as.data.table %>% .[,factor:=as.factor(1:Raf_OA_MOFA2@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2")

r2_prebiotic.dt <- r2_prebiotic %>%
  as.data.table %>% .[,factor:=as.factor(1:Raf_OA_MOFA2@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2")

ggplot(r2_placebo.dt, aes(x=factor, y=r2, fill=view))+
  geom_bar(stat="identity") +
  labs(x="Factor number", y="Cumulative variance explained (%)") +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.text = element_text(size=rel(0.8))
  ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5), 
        axis.text = element_text(size=14), 
        text = element_text(size=14)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggsave("cumulative_variance_explained_factors_Placebo.svg", plot = last_plot(), path = OutputDirectory)

ggplot(r2_prebiotic.dt, aes(x=factor, y=r2, fill=view))+
  geom_bar(stat="identity") +
  labs(x="Factor number", y="Cumulative variance explained (%)") +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.text = element_text(size=rel(0.8))
  ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5), 
        axis.text = element_text(size=14), 
        text = element_text(size=14)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggsave("cumulative_variance_explained_factors_Prebiotic.svg", plot = last_plot(), path = OutputDirectory)

ggline(r2.dt, x="factor", y="r2", color="view") +
  labs(x="Factor number", y="Cumulative variance explained (%)") +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    axis.text = element_text(size=rel(0.8))
  ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5), axis.text = element_text(size=14), text = element_text(size=14)) +
  theme_classic()
ggsave("cumulative_variance_explained_factors-line.svg", plot = last_plot(), path = OutputDirectory)

#### Factor weights #### 
plot_weights_fn <- function(Raf_OA_MOFA2, factor=1, view=1, nfeatures=10) {
  p2 <- plot_top_weights(Raf_OA_MOFA2,
                         factors = factor,
                         view = view,
                         nfeatures = nfeatures
  )
  
  return(p2)
}

setwd(OutputDirectory)
svg(file = "Factor1_Weights.svg", width = 12, height = 18)

# Generate the individual plots for each view
plot1 <- plot_weights_fn(Raf_OA_MOFA2, factor=1, view="CGC", nfeatures=20)
plot2 <- plot_weights_fn(Raf_OA_MOFA2, factor=1, view="HUMAnN3", nfeatures=20)
plot3 <- plot_weights_fn(Raf_OA_MOFA2, factor=1, view="PULs", nfeatures=20)

combined_plots <- cowplot::plot_grid(plotlist = list(plot1, plot2, plot3), nrow = 3)
print(combined_plots)
dev.off()

plot_weights_fn2 <- function(Raf_OA_MOFA2, factor=2, view=1, nfeatures=10) {
  p2 <- plot_top_weights(Raf_OA_MOFA2,
                         factors = factor,
                         view = view,
                         nfeatures = nfeatures
  )
  
  return(p2)
}

setwd(OutputDirectory)
svg(file = "Factor2_Weights.svg", width = 9, height = 12)

# Generate the individual plots for each view
plot1 <- plot_weights_fn(Raf_OA_MOFA2, factor=2, view="PULs", nfeatures=10)
plot2 <- plot_weights_fn(Raf_OA_MOFA2, factor=2, view="HUMAnN3", nfeatures=10)
plot3 <- plot_weights_fn(Raf_OA_MOFA2, factor=2, view="Cytokine", nfeatures=10)

combined_plots <- cowplot::plot_grid(plotlist = list(plot1, plot2, plot3), nrow = 3)
print(combined_plots)
dev.off()

factor_scores <- factor_analysis_model(Raf_OA_MOFA2)
plot_data_overview(Raf_OA_MOFA2)


plot_factor(Raf_OA_MOFA2, 
  factor = 1:2,
  color_by = "group",
  shape_by = "Months"
)

plot_factors(Raf_OA_MOFA2, 
  factors = c(1,2), 
  color_by = "Butyrate", 
  shape_by = "group", 
  dot_size = 3.5
) + scale_fill_gradient(low = "white", high = "#BF3EFF")

plot_factors(Raf_OA_MOFA2, 
  factors = c(1,2), 
  color_by = "Propionate", 
  shape_by = "group", 
  dot_size = 3.5
) + scale_fill_gradient(low = "white", high = "#BF3EFF")


plot_factors(Raf_OA_MOFA2, 
  factors = c(1,2), 
  color_by = "TotalLean", 
  shape_by = "group", 
  dot_size = 3.5
) + scale_fill_gradient(low = "white", high = "#BF3EFF")


plot_factors(Raf_OA_MOFA2, 
  factors = c(1,2), 
  color_by = "HandGrip", 
  shape_by = "group", 
  dot_size = 3.5
) + scale_fill_gradient(low = "white", high = "#BF3EFF")


# Extract weights from the model
Raf_OA_MOFA2_weights <- get_weights(Raf_OA_MOFA2)
str(Raf_OA_MOFA2_weights)

# Extract weight data for a specific omics layer
Raf_OA_MOFA2_weights_CGC <- Raf_OA_MOFA2_weights$CGC  
Raf_OA_MOFA2_weights_Cytokine <- Raf_OA_MOFA2_weights$Cytokine
Raf_OA_MOFA2_weights_HUMAnN3 <- Raf_OA_MOFA2_weights$HUMAnN3  
Raf_OA_MOFA2_weights_Metabolites <- Raf_OA_MOFA2_weights$Metabolites
Raf_OA_MOFA2_weights_MetaPhlAn4 <- Raf_OA_MOFA2_weights$MetaPhlAn4  
Raf_OA_MOFA2_weights_PULs <- Raf_OA_MOFA2_weights$PULs

#Extract data for a specific factor
Raf_OA_MOFA2_weights_CGC_f1 <- Raf_OA_MOFA2_weights_CGC[, 1]  
Raf_OA_MOFA2_weights_HUMAnN3_f1 <- Raf_OA_MOFA2_weights_HUMAnN3[, 1]  
Raf_OA_MOFA2_weights_PULs_f1 <- Raf_OA_MOFA2_weights_PULs[, 1]  

Raf_OA_MOFA2_weights_PULs_f2 <- Raf_OA_MOFA2_weights_PULs[, 2]  
Raf_OA_MOFA2_weights_HUMAnN3_f2 <- Raf_OA_MOFA2_weights_HUMAnN3[, 2]  
Raf_OA_MOFA2_weights_Cytokine_f2 <- Raf_OA_MOFA2_weights_Cytokine[, 2] 


# Create data frames for each omics layer separately
# List of omics layers and colors for each layer (including the new weights)
omics_layers <- list(
  CGC = list(data = f1_weights_CGC_df, 
             color = "steelblue", 
             title = "Top 5 Absolute Weights (CGC)"),
  
  HUMAnN3 = list(data = f1_weights_HUMAnN3_df, 
                 color = "orange", 
                 title = "Top 5 Absolute Weights (HUMAnN3)"),
  
  PULs = list(data = f1_weights_PULs_df, 
              color = "green", 
              title = "Top 5 Absolute Weights (PULs)"),
  
  PULs_f2 = list(data = data.frame(Feature = names(Raf_OA_MOFA2_weights_PULs_f2), 
                                   Weight = Raf_OA_MOFA2_weights_PULs_f2), 
                                   color = "purple", 
                                   title = "Top 5 Absolute Weights (PULs f2)"),
  
  HUMAnN3_f2 = list(data = data.frame(Feature = names(Raf_OA_MOFA2_weights_HUMAnN3_f2), 
                                      Weight = Raf_OA_MOFA2_weights_HUMAnN3_f2), 
                                      color = "red", 
                                      title = "Top 5 Absolute Weights (HUMAnN3 f2)"),
  
  Cytokine_f2 = list(data = data.frame(Feature = names(Raf_OA_MOFA2_weights_Cytokine_f2), 
                                       Weight = Raf_OA_MOFA2_weights_Cytokine_f1), 
                                       color = "blue", 
                                       title = "Top 5 Absolute Weights (Cytokine f)"))

# Loop through each omics layer and generate the plots
for (omics_layer in names(omics_layers)) {
  # Get the data, color, and title for the current layer
  data <- omics_layers[[omics_layer]]$data
  color <- omics_layers[[omics_layer]]$color
  plot_title <- omics_layers[[omics_layer]]$title
  
  # Convert to absolute weights and get the top 5 absolute weights
  data$Abs_Weight <- abs(data$Weight)
  top_5_weights <- data %>%
    arrange(desc(Abs_Weight)) %>%
    head(25)
  
  # Calculate a small margin to extend the y-axis beyond the max value
  max_weight <- max(top_5_weights$Abs_Weight)
  y_axis_limit <- max_weight + 0.06  # Extend y-axis limit by 0.1 (adjust if needed)
  
  # Create the plot
  plot <- ggplot(top_5_weights, aes(x = reorder(Feature, -Abs_Weight), y = Abs_Weight)) +
    geom_bar(stat = "identity", color = "black", fill = color, show.legend = FALSE) +
    geom_text(aes(label = round(Weight, 2)), vjust = -0.5, size = 5) +  # Display the true weight value
    mytheme1 +
    labs(title = plot_title, x = "Features", y = "Absolute Weights") +
    coord_flip() +  # Flip the axes
    scale_x_discrete(expand = c(0.1, 0.1)) +  # Add breaks to x-axis (Features)
    scale_y_continuous(
      expand = c(0, 0), 
      breaks = seq(0, y_axis_limit, by = 0.1),  # Extend breaks beyond the max value
      limits = c(-0.02, y_axis_limit)  # Set y-axis limit to slightly higher than max weight
    )
  ggsave(paste0("top_5_weights_", omics_layer, "_plot.svg"), plot = plot, width = 12, height = 6)
}

sample_metadata <- samples_metadata(Raf_OA_MOFA2)
print(colnames(sample_metadata))


# correlations between factors with co-variates
SCFA <- c("Acetate", "Propionate", "Butyrate")
Major_outcomes <- c("TotalMass", "TotalLean", "TrunkFatKg","TrunkFat.","TotalFat","BMC", "BMD" ,"Fat." ,
                    "HandGrip","FastWalk","SixMinWalk", "TimeUpGo","SitToStand")

# Correlations between factors with covariates

correlation_SCFA_log_pval <- correlate_factors_with_covariates(Raf_OA_MOFA2,
                                                              covariates = SCFA,
                                                              plot = "log_pval")

correlation_SCFA_r <- correlate_factors_with_covariates(Raf_OA_MOFA2,
                                                        covariates = SCFA,
                                                        plot = "r")

str(correlation_SCFA_r)

# Extract the correlation matrix from the result
correlation_SCFA_r_values <- correlation_SCFA_r$corr
SCFA_cor_matrix_long <- melt(correlation_SCFA_r_values)
colnames(SCFA_cor_matrix_long) <- c("Factor", "SCFA", "Correlation")
head(SCFA_cor_matrix_long)

MOFA2_Factor_SCFA_correlation_plot2 <- ggplot(SCFA_cor_matrix_long, aes(x = SCFA, y = Factor, fill = Correlation)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +  # Adjust colors
  theme_minimal() +
  labs(title = "Correlation Between Factors and SCFAs", x = "SCFA", y = "Factors") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

MOFA2_Factor_SCFA_correlation_plot <- correlate_factors_with_covariates(Raf_OA_MOFA2,
                                                                        covariates = SCFA, 
                                                                        plot = "log_pval")

ggsave("MOFA2_Factor_SCFA_correlation_plot.svg", MOFA2_Factor_SCFA_correlation_plot, width = 4, height = 3)
ggsave("MOFA2_Factor_SCFA_correlation_plot_r.svg", MOFA2_Factor_SCFA_correlation_plot2, width = 4, height = 3)


MOFA2_Factor_Major_outcomes_r <- correlate_factors_with_covariates(Raf_OA_MOFA2,
                                                                   covariates = Major_outcomes,
                                                                   plot = "r")

correlation_Major_outcomes_r_values <- MOFA2_Factor_Major_outcomes_r$corr
Major_outcomes_cor_matrix_long <- melt(correlation_Major_outcomes_r_values)
colnames(Major_outcomes_cor_matrix_long) <- c("Factor", "Major_outcomes", "Correlation")
head(Major_outcomes_cor_matrix_long)

MOFA2_Factor_Major_outcomes_correlation_plot2 <- ggplot(Major_outcomes_cor_matrix_long, 
                                                        aes(x = Major_outcomes, y = Factor, fill = Correlation)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +  # Adjust colors
  theme_minimal() +
  labs(title = "Correlation Between Factors and SCFAs", x = "SCFA", y = "Factors") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

MOFA2_Factor_Major_outcomes_correlation_plot <- correlate_factors_with_covariates(Raf_OA_MOFA2,
                                                                                  covariates = Major_outcomes,
                                                                                  plot = "log_pval")


ggsave("MOFA2_Factor_Major_outcomes_correlation.svg", MOFA2_Factor_Major_outcomes_correlation_plot, width = 4, height = 3)
ggsave("MOFA2_Factor_Major_outcomes_correlation_plot_r.svg", MOFA2_Factor_Major_outcomes_correlation_plot2, width = 4, height = 3)

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

